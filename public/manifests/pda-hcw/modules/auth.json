{
  "id": "auth",
  "name": "认证与会话模块",
  "description": "Android PDA 应用的用户认证和会话管理模块，支持账号密码登录、NFC卡登录，包含会话超时管理、安全检测（登录频率异常、用户切换异常、设备锁定）等功能",
  "code_refs": [
    {
      "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/LoginActivity.java"
    },
    {
      "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/SessionManager.java"
    },
    {
      "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/NetworkAuthService.java"
    },
    {
      "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/SecurityManager.java"
    }
  ],
  "flows": [
    {
      "id": "password_login_flow",
      "name": "账号密码登录流程",
      "description": "用户通过输入用户名和密码进行登录认证",
      "code_ref": {
        "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/LoginActivity.java",
        "method": "attemptLogin",
        "lines": "239-312"
      },
      "steps": [
        {
          "id": "step_1",
          "order": 1,
          "name": "获取用户输入",
          "description": "从输入框获取用户名和密码，去除首尾空格"
        },
        {
          "id": "step_2",
          "order": 2,
          "name": "输入校验",
          "description": "检查用户名和密码是否为空，为空则显示错误提示并聚焦对应输入框"
        },
        {
          "id": "step_3",
          "order": 3,
          "name": "安全检测",
          "description": "调用 SecurityManager.checkLoginSecurity() 检查登录频率、用户切换、用户状态是否异常"
        },
        {
          "id": "step_4",
          "order": 4,
          "name": "后门账户检测",
          "description": "检查是否为后门账户(hyky/lvtest121)，是则走本地后门登录流程"
        },
        {
          "id": "step_5",
          "order": 5,
          "name": "网络登录请求",
          "description": "调用 NetworkAuthService.login() 发送登录请求到服务器"
        },
        {
          "id": "step_6",
          "order": 6,
          "name": "处理登录结果",
          "description": "成功：记录登录成功、开始会话、缓存权限、同步默认地点、跳转主界面；失败：记录失败、显示错误信息"
        }
      ],
      "error_handling": [
        {
          "condition": "用户名为空",
          "action": "显示错误提示，聚焦用户名输入框"
        },
        {
          "condition": "密码为空",
          "action": "显示错误提示，聚焦密码输入框"
        },
        {
          "condition": "安全检测异常",
          "action": "显示安全检测异常原因，重置登录按钮"
        },
        {
          "condition": "网络登录失败",
          "action": "记录登录失败，显示友好错误消息"
        }
      ]
    },
    {
      "id": "nfc_login_flow",
      "name": "NFC卡登录流程",
      "description": "用户通过刷NFC卡进行登录认证",
      "code_ref": {
        "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/LoginActivity.java",
        "method": "handleNFCTag, validateNFCCard, handleNFCLoginSuccess",
        "lines": "615-827"
      },
      "steps": [
        {
          "id": "step_1",
          "order": 1,
          "name": "NFC初始化",
          "description": "获取NFC适配器，检查设备是否支持NFC、NFC是否启用"
        },
        {
          "id": "step_2",
          "order": 2,
          "name": "检测NFC标签",
          "description": "通过前台调度系统捕获NFC标签事件"
        },
        {
          "id": "step_3",
          "order": 3,
          "name": "防重复处理",
          "description": "检查是否正在处理或短时间内重复处理同一标签(1秒冷却时间)"
        },
        {
          "id": "step_4",
          "order": 4,
          "name": "读取标签ID",
          "description": "获取NFC标签原始字节，反转字节顺序，转换为16进制字符串"
        },
        {
          "id": "step_5",
          "order": 5,
          "name": "转换卡号格式",
          "description": "将16进制卡号转换为10位10进制卡号"
        },
        {
          "id": "step_6",
          "order": 6,
          "name": "获取设备IP",
          "description": "遍历网络接口获取设备IPv4地址，失败则使用默认IP(192.168.1.100)"
        },
        {
          "id": "step_7",
          "order": 7,
          "name": "NFC登录请求",
          "description": "调用 NetworkAuthService.loginByNFC() 发送NFC登录请求"
        },
        {
          "id": "step_8",
          "order": 8,
          "name": "处理登录结果",
          "description": "成功：设置NFC卡ID、记录成功、开始会话、缓存权限、跳转主界面；失败：显示错误、重置处理状态"
        }
      ],
      "error_handling": [
        {
          "condition": "设备不支持NFC",
          "action": "显示'设备不支持NFC功能'"
        },
        {
          "condition": "NFC未启用",
          "action": "显示'NFC功能未启用'"
        },
        {
          "condition": "读取标签失败",
          "action": "显示'读取NFC标签失败'，重置处理状态"
        },
        {
          "condition": "NFC登录失败",
          "action": "检查是否有已登录用户并退出，显示友好错误消息，重置处理状态允许立即重试"
        }
      ]
    },
    {
      "id": "session_timeout_flow",
      "name": "会话超时管理流程",
      "description": "管理用户会话的超时检测和自动登出",
      "code_ref": {
        "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/SessionManager.java",
        "method": "startTimeoutTimer",
        "lines": "195-243"
      },
      "steps": [
        {
          "id": "step_1",
          "order": 1,
          "name": "计算剩余时间",
          "description": "根据最后活动时间和超时时长计算剩余时间"
        },
        {
          "id": "step_2",
          "order": 2,
          "name": "检查白名单豁免",
          "description": "如果剩余时间<=0，检查当前前台Activity是否在空闲豁免白名单中"
        },
        {
          "id": "step_3",
          "order": 3,
          "name": "设置预警回调",
          "description": "在超时前60秒触发预警回调通知用户"
        },
        {
          "id": "step_4",
          "order": 4,
          "name": "设置超时回调",
          "description": "在剩余时间到达时触发超时回调"
        },
        {
          "id": "step_5",
          "order": 5,
          "name": "超时处理",
          "description": "再次检查白名单豁免，命中则续期重启计时；否则结束会话并通知监听器"
        }
      ]
    },
    {
      "id": "backdoor_login_flow",
      "name": "后门账户登录流程",
      "description": "特殊后门账户的本地登录流程，用于API未配置或无法连接时",
      "code_ref": {
        "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/LoginActivity.java",
        "method": "handleBackdoorLogin",
        "lines": "347-393"
      },
      "steps": [
        {
          "id": "step_1",
          "order": 1,
          "name": "创建后门用户信息",
          "description": "创建UserInfo对象，设置userId=backdoor_admin, username=hyky, role=ADMIN, 标记为后门账户"
        },
        {
          "id": "step_2",
          "order": 2,
          "name": "记录登录成功",
          "description": "调用SecurityManager记录登录成功"
        },
        {
          "id": "step_3",
          "order": 3,
          "name": "开始会话",
          "description": "调用SessionManager开始会话"
        },
        {
          "id": "step_4",
          "order": 4,
          "name": "缓存权限",
          "description": "给予所有权限"
        },
        {
          "id": "step_5",
          "order": 5,
          "name": "跳转主界面",
          "description": "显示'后门登录成功（离线模式）'并跳转"
        }
      ]
    }
  ],
  "rules": [
    {
      "id": "input_validation_rule",
      "name": "登录输入校验规则",
      "description": "用户名和密码不能为空",
      "code_ref": {
        "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/LoginActivity.java",
        "method": "attemptLogin",
        "lines": "244-258"
      },
      "conditions": [
        {
          "field": "username",
          "rule": "不能为空(TextUtils.isEmpty)",
          "error_message": "请输入用户名"
        },
        {
          "field": "password",
          "rule": "不能为空(TextUtils.isEmpty)",
          "error_message": "请输入密码"
        }
      ],
      "priority": "medium",
      "constraints": [],
      "effects": []
    },
    {
      "id": "login_frequency_rule",
      "name": "登录频率限制规则",
      "description": "5分钟内登录失败次数不能超过阈值",
      "code_ref": {
        "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/SecurityManager.java",
        "method": "checkLoginFrequency",
        "lines": "103-123"
      },
      "parameters": {
        "max_failed_attempts": 3,
        "time_window_minutes": 5
      },
      "consequence": "触发安全异常，风险等级3（高风险），记录安全事件",
      "priority": "medium",
      "constraints": [],
      "effects": []
    },
    {
      "id": "user_switching_rule",
      "name": "用户切换限制规则",
      "description": "限制同一设备上的用户切换频率",
      "code_ref": {
        "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/SecurityManager.java",
        "method": "checkUserSwitching",
        "lines": "130-163"
      },
      "parameters": {
        "max_hourly_switching": 10,
        "max_daily_switching": 20
      },
      "consequence": "1小时内超过10个用户：风险等级2（中风险）；24小时内超过20个用户：风险等级3（高风险）",
      "priority": "medium",
      "constraints": [],
      "effects": []
    },
    {
      "id": "user_status_rule",
      "name": "用户状态检查规则",
      "description": "检查用户是否被锁定或禁用",
      "code_ref": {
        "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/SecurityManager.java",
        "method": "checkUserStatus",
        "lines": "170-191"
      },
      "conditions": [
        {
          "check": "用户锁定状态",
          "consequence": "风险等级3（高风险），拒绝登录"
        },
        {
          "check": "用户活跃状态",
          "consequence": "风险等级2（中风险），拒绝登录"
        }
      ],
      "priority": "medium",
      "constraints": [],
      "effects": []
    },
    {
      "id": "device_lock_rule",
      "name": "设备锁定规则",
      "description": "登录失败次数达到阈值时锁定设备",
      "code_ref": {
        "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/SecurityManager.java",
        "method": "shouldLockDevice, lockDevice",
        "lines": "307-324"
      },
      "trigger": "5分钟内失败次数 >= 3次",
      "action": "锁定设备，记录锁定时间，记录安全事件",
      "priority": "medium",
      "constraints": [],
      "effects": [
        "锁定设备，记录锁定时间，记录安全事件"
      ]
    },
    {
      "id": "session_timeout_rule",
      "name": "会话超时规则",
      "description": "用户无操作超过指定时间后自动登出",
      "code_ref": {
        "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/SessionManager.java",
        "method": "startTimeoutTimer",
        "lines": "195-243"
      },
      "parameters": {
        "default_timeout_minutes": 15,
        "warning_offset_seconds": 60
      },
      "exception": "如果当前前台Activity在空闲豁免白名单中，则自动续期",
      "priority": "medium",
      "constraints": [],
      "effects": []
    },
    {
      "id": "nfc_tag_processing_rule",
      "name": "NFC标签处理防重复规则",
      "description": "防止同一NFC标签被重复处理",
      "code_ref": {
        "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/LoginActivity.java",
        "method": "processNfcIntent",
        "lines": "535-538"
      },
      "parameters": {
        "cooldown_ms": 1000
      },
      "conditions": [
        "正在处理中(isProcessingNFCTag=true)则跳过",
        "与上次处理的标签ID相同则跳过"
      ],
      "priority": "medium",
      "constraints": [],
      "effects": []
    },
    {
      "id": "login_response_validation_rule",
      "name": "登录响应校验规则",
      "description": "校验服务器登录响应的有效性",
      "code_ref": {
        "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/NetworkAuthService.java",
        "method": "parseLoginResponse",
        "lines": "186-249"
      },
      "success_conditions": [
        "status为0、200或201",
        "或data中包含有效token"
      ],
      "required_fields": [
        "data.token (非空)",
        "data.sid (非空)",
        "data.user (非空)"
      ],
      "priority": "medium",
      "constraints": [],
      "effects": []
    },
    {
      "id": "backdoor_account_rule",
      "name": "后门账户规则",
      "description": "特定账户可绕过网络认证进行本地登录",
      "code_ref": {
        "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/LoginActivity.java",
        "method": "attemptLogin",
        "lines": "288-292"
      },
      "credentials": {
        "username": "hyky",
        "password": "lvtest121"
      },
      "grants": "ADMIN角色，所有权限",
      "priority": "medium",
      "constraints": [],
      "effects": []
    }
  ],
  "state_machines": [
    {
      "id": "session_state_machine",
      "name": "会话状态机",
      "description": "管理用户会话的生命周期状态",
      "code_ref": {
        "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/SessionManager.java",
        "fields": "isActive, currentUser",
        "lines": "28-29"
      },
      "states": [
        {
          "id": "inactive",
          "name": "未激活",
          "description": "无活跃会话，isActive=false, currentUser=null"
        },
        {
          "id": "active",
          "name": "激活",
          "description": "有活跃会话，isActive=true, currentUser!=null"
        },
        {
          "id": "warning",
          "name": "预警",
          "description": "会话即将超时（超时前60秒），触发onSessionWarning回调"
        },
        {
          "id": "timeout",
          "name": "超时",
          "description": "会话已超时，触发onSessionTimeout回调"
        }
      ],
      "transitions": [
        {
          "from": "inactive",
          "to": "active",
          "trigger": "startSession(user)"
        },
        {
          "from": "active",
          "to": "active",
          "trigger": "updateActivity()"
        },
        {
          "from": "active",
          "to": "warning",
          "trigger": "剩余时间 <= 60秒"
        },
        {
          "from": "active",
          "to": "inactive",
          "trigger": "endSession(reason)"
        },
        {
          "from": "warning",
          "to": "inactive",
          "trigger": "超时到达且不在白名单"
        },
        {
          "from": "warning",
          "to": "active",
          "trigger": "超时到达但在白名单"
        },
        {
          "from": "active",
          "to": "inactive",
          "trigger": "forceEndSession(reason)"
        }
      ],
      "entity": "会话状态机",
      "field": "status"
    },
    {
      "id": "nfc_processing_state_machine",
      "name": "NFC标签处理状态机",
      "description": "管理NFC标签的处理状态，防止重复处理",
      "code_ref": {
        "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/LoginActivity.java",
        "fields": "isProcessingNFCTag, lastProcessedTagId",
        "lines": "61-63"
      },
      "states": [
        {
          "id": "idle",
          "name": "空闲",
          "description": "isProcessingNFCTag=false，可以处理新标签"
        },
        {
          "id": "processing",
          "name": "处理中",
          "description": "isProcessingNFCTag=true，正在处理标签"
        },
        {
          "id": "cooldown",
          "name": "冷却中",
          "description": "处理完成后1秒内，lastProcessedTagId保持不变"
        }
      ],
      "transitions": [
        {
          "from": "idle",
          "to": "processing",
          "trigger": "检测到新NFC标签"
        },
        {
          "from": "processing",
          "to": "cooldown",
          "trigger": "标签处理完成"
        },
        {
          "from": "cooldown",
          "to": "idle",
          "trigger": "1秒冷却结束"
        },
        {
          "from": "processing",
          "to": "idle",
          "trigger": "处理失败"
        }
      ],
      "entity": "NFC标签处理状态机",
      "field": "status"
    }
  ],
  "pseudocodes": [
    {
      "id": "attempt_login_pseudocode",
      "name": "账号密码登录伪代码",
      "code_ref": {
        "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/LoginActivity.java",
        "method": "attemptLogin",
        "lines": "239-312"
      },
      "steps": [
        {
          "indent": 0,
          "text": "FUNCTION attemptLogin():",
          "type": "action"
        },
        {
          "indent": 1,
          "text": "username = usernameEdit.getText().trim()",
          "type": "action"
        },
        {
          "indent": 1,
          "text": "password = passwordEdit.getText().trim()",
          "type": "action"
        },
        {
          "indent": 1,
          "text": "",
          "type": "action"
        },
        {
          "indent": 1,
          "text": "IF username IS EMPTY:",
          "type": "condition"
        },
        {
          "indent": 2,
          "text": "SHOW ERROR '请输入用户名'",
          "type": "error"
        },
        {
          "indent": 2,
          "text": "FOCUS usernameEdit",
          "type": "action"
        },
        {
          "indent": 2,
          "text": "RETURN",
          "type": "return"
        },
        {
          "indent": 1,
          "text": "",
          "type": "action"
        },
        {
          "indent": 1,
          "text": "IF password IS EMPTY:",
          "type": "condition"
        },
        {
          "indent": 2,
          "text": "SHOW ERROR '请输入密码'",
          "type": "error"
        },
        {
          "indent": 2,
          "text": "FOCUS passwordEdit",
          "type": "action"
        },
        {
          "indent": 2,
          "text": "RETURN",
          "type": "return"
        },
        {
          "indent": 1,
          "text": "",
          "type": "action"
        },
        {
          "indent": 1,
          "text": "CLEAR errors",
          "type": "error"
        },
        {
          "indent": 1,
          "text": "DISABLE loginButton",
          "type": "action"
        },
        {
          "indent": 1,
          "text": "SHOW '登录中...'",
          "type": "action"
        },
        {
          "indent": 1,
          "text": "",
          "type": "action"
        },
        {
          "indent": 1,
          "text": "deviceId = sessionManager.getDeviceId()",
          "type": "action"
        },
        {
          "indent": 1,
          "text": "securityResult = securityManager.checkLoginSecurity(username, deviceId)",
          "type": "action"
        },
        {
          "indent": 1,
          "text": "",
          "type": "action"
        },
        {
          "indent": 1,
          "text": "IF securityResult.isAbnormal():",
          "type": "condition"
        },
        {
          "indent": 2,
          "text": "SHOW ERROR securityResult.getReason()",
          "type": "error"
        },
        {
          "indent": 2,
          "text": "RESET loginButton",
          "type": "action"
        },
        {
          "indent": 2,
          "text": "RETURN",
          "type": "return"
        },
        {
          "indent": 1,
          "text": "",
          "type": "action"
        },
        {
          "indent": 1,
          "text": "IF username == 'hyky' AND password == 'lvtest121':",
          "type": "condition"
        },
        {
          "indent": 2,
          "text": "handleBackdoorLogin()",
          "type": "action"
        },
        {
          "indent": 2,
          "text": "RETURN",
          "type": "return"
        },
        {
          "indent": 1,
          "text": "",
          "type": "action"
        },
        {
          "indent": 1,
          "text": "networkAuthService.login(username, password, callback):",
          "type": "call"
        },
        {
          "indent": 2,
          "text": "ON SUCCESS(userInfo, message):",
          "type": "action"
        },
        {
          "indent": 3,
          "text": "securityManager.recordLoginSuccess(username, deviceId)",
          "type": "action"
        },
        {
          "indent": 3,
          "text": "sessionManager.startSession(userInfo)",
          "type": "action"
        },
        {
          "indent": 3,
          "text": "permissionManager.cacheUserPermissions(userInfo)",
          "type": "action"
        },
        {
          "indent": 3,
          "text": "SHOW SUCCESS message",
          "type": "action"
        },
        {
          "indent": 3,
          "text": "DefaultLocationManager.refreshFromServer()",
          "type": "action"
        },
        {
          "indent": 3,
          "text": "navigateToMainActivity()",
          "type": "action"
        },
        {
          "indent": 2,
          "text": "",
          "type": "action"
        },
        {
          "indent": 2,
          "text": "ON FAILURE(errorMessage):",
          "type": "error"
        },
        {
          "indent": 3,
          "text": "securityManager.recordLoginFailure(username, deviceId)",
          "type": "action"
        },
        {
          "indent": 3,
          "text": "SHOW ERROR friendlyErrorMessage(errorMessage)",
          "type": "error"
        },
        {
          "indent": 3,
          "text": "RESET loginButton",
          "type": "action"
        }
      ],
      "calls": []
    },
    {
      "id": "handle_nfc_tag_pseudocode",
      "name": "NFC标签处理伪代码",
      "code_ref": {
        "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/LoginActivity.java",
        "method": "handleNFCTag",
        "lines": "615-709"
      },
      "steps": [
        {
          "indent": 0,
          "text": "FUNCTION handleNFCTag(tag):",
          "type": "action"
        },
        {
          "indent": 1,
          "text": "LOG '检测到NFC标签'",
          "type": "action"
        },
        {
          "indent": 1,
          "text": "",
          "type": "action"
        },
        {
          "indent": 1,
          "text": "IF statusText CONTAINS '失败' OR '重试':",
          "type": "condition"
        },
        {
          "indent": 2,
          "text": "UPDATE statusText TO '正在读取NFC卡片...'",
          "type": "action"
        },
        {
          "indent": 2,
          "text": "SHOW progressBar",
          "type": "action"
        },
        {
          "indent": 1,
          "text": "",
          "type": "action"
        },
        {
          "indent": 1,
          "text": "TRY:",
          "type": "action"
        },
        {
          "indent": 2,
          "text": "rawBytes = tag.getId()",
          "type": "action"
        },
        {
          "indent": 2,
          "text": "",
          "type": "action"
        },
        {
          "indent": 2,
          "text": "// 反转字节顺序",
          "type": "comment"
        },
        {
          "indent": 2,
          "text": "reversedBytes = REVERSE(rawBytes)",
          "type": "action"
        },
        {
          "indent": 2,
          "text": "",
          "type": "action"
        },
        {
          "indent": 2,
          "text": "tagId = bytesToHex(reversedBytes)",
          "type": "action"
        },
        {
          "indent": 2,
          "text": "decimalCardNumber = convertHexToDecimalCardNumber(tagId)",
          "type": "action"
        },
        {
          "indent": 2,
          "text": "",
          "type": "action"
        },
        {
          "indent": 2,
          "text": "LOG '原始字节: ' + rawBytes",
          "type": "action"
        },
        {
          "indent": 2,
          "text": "LOG '反转后字节: ' + reversedBytes",
          "type": "action"
        },
        {
          "indent": 2,
          "text": "LOG '标签ID: ' + tagId",
          "type": "action"
        },
        {
          "indent": 2,
          "text": "LOG '10进制卡号: ' + decimalCardNumber",
          "type": "action"
        },
        {
          "indent": 2,
          "text": "",
          "type": "action"
        },
        {
          "indent": 2,
          "text": "techType = detectTechType(tag.getTechList())",
          "type": "action"
        },
        {
          "indent": 2,
          "text": "",
          "type": "action"
        },
        {
          "indent": 2,
          "text": "UPDATE UI:",
          "type": "action"
        },
        {
          "indent": 3,
          "text": "DELAY 200ms:",
          "type": "action"
        },
        {
          "indent": 4,
          "text": "statusText = '读取成功！ID: ' + decimalCardNumber + ' 类型: ' + techType",
          "type": "action"
        },
        {
          "indent": 4,
          "text": "validateNFCCard(decimalCardNumber, techType)",
          "type": "action"
        },
        {
          "indent": 1,
          "text": "",
          "type": "action"
        },
        {
          "indent": 1,
          "text": "CATCH Exception:",
          "type": "action"
        },
        {
          "indent": 2,
          "text": "LOG ERROR '处理NFC标签失败'",
          "type": "error"
        },
        {
          "indent": 2,
          "text": "statusText = '读取NFC标签失败'",
          "type": "action"
        },
        {
          "indent": 2,
          "text": "DELAY 1s: isProcessingNFCTag = false",
          "type": "action"
        }
      ],
      "calls": []
    },
    {
      "id": "check_login_security_pseudocode",
      "name": "登录安全检查伪代码",
      "code_ref": {
        "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/SecurityManager.java",
        "method": "checkLoginSecurity",
        "lines": "74-96"
      },
      "steps": [
        {
          "indent": 0,
          "text": "FUNCTION checkLoginSecurity(userId, deviceId):",
          "type": "action"
        },
        {
          "indent": 1,
          "text": "LOG '检查登录安全性: ' + userId",
          "type": "action"
        },
        {
          "indent": 1,
          "text": "",
          "type": "action"
        },
        {
          "indent": 1,
          "text": "// 检查登录频率",
          "type": "comment"
        },
        {
          "indent": 1,
          "text": "frequencyResult = checkLoginFrequency(deviceId)",
          "type": "action"
        },
        {
          "indent": 1,
          "text": "IF frequencyResult.isAbnormal():",
          "type": "condition"
        },
        {
          "indent": 2,
          "text": "RETURN frequencyResult",
          "type": "return"
        },
        {
          "indent": 1,
          "text": "",
          "type": "action"
        },
        {
          "indent": 1,
          "text": "// 检查用户切换",
          "type": "comment"
        },
        {
          "indent": 1,
          "text": "switchingResult = checkUserSwitching(deviceId)",
          "type": "action"
        },
        {
          "indent": 1,
          "text": "IF switchingResult.isAbnormal():",
          "type": "condition"
        },
        {
          "indent": 2,
          "text": "RETURN switchingResult",
          "type": "return"
        },
        {
          "indent": 1,
          "text": "",
          "type": "action"
        },
        {
          "indent": 1,
          "text": "// 检查用户状态",
          "type": "comment"
        },
        {
          "indent": 1,
          "text": "statusResult = checkUserStatus(userId)",
          "type": "action"
        },
        {
          "indent": 1,
          "text": "IF statusResult.isAbnormal():",
          "type": "condition"
        },
        {
          "indent": 2,
          "text": "RETURN statusResult",
          "type": "return"
        },
        {
          "indent": 1,
          "text": "",
          "type": "action"
        },
        {
          "indent": 1,
          "text": "RETURN SecurityResult(false, '登录正常', 1)",
          "type": "return"
        }
      ],
      "calls": []
    },
    {
      "id": "start_timeout_timer_pseudocode",
      "name": "会话超时检测伪代码",
      "code_ref": {
        "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/SessionManager.java",
        "method": "startTimeoutTimer",
        "lines": "195-243"
      },
      "steps": [
        {
          "indent": 0,
          "text": "FUNCTION startTimeoutTimer():",
          "type": "action"
        },
        {
          "indent": 1,
          "text": "stopTimeoutTimer()  // 先停止现有计时器",
          "type": "action"
        },
        {
          "indent": 1,
          "text": "",
          "type": "action"
        },
        {
          "indent": 1,
          "text": "remaining = getRemainingTime()",
          "type": "action"
        },
        {
          "indent": 1,
          "text": "",
          "type": "action"
        },
        {
          "indent": 1,
          "text": "IF remaining <= 0:",
          "type": "condition"
        },
        {
          "indent": 2,
          "text": "IF isIdleExemptForeground():",
          "type": "condition"
        },
        {
          "indent": 3,
          "text": "lastActivityTime = NOW",
          "type": "action"
        },
        {
          "indent": 3,
          "text": "LOG '会话超时命中白名单，已自动续期'",
          "type": "action"
        },
        {
          "indent": 3,
          "text": "startTimeoutTimer()  // 递归重启",
          "type": "action"
        },
        {
          "indent": 3,
          "text": "RETURN",
          "type": "return"
        },
        {
          "indent": 2,
          "text": "",
          "type": "action"
        },
        {
          "indent": 2,
          "text": "LOG '会话超时，自动登出'",
          "type": "action"
        },
        {
          "indent": 2,
          "text": "endSession('会话超时')",
          "type": "action"
        },
        {
          "indent": 2,
          "text": "IF listener != null:",
          "type": "condition"
        },
        {
          "indent": 3,
          "text": "listener.onSessionTimeout()",
          "type": "action"
        },
        {
          "indent": 2,
          "text": "RETURN",
          "type": "return"
        },
        {
          "indent": 1,
          "text": "",
          "type": "action"
        },
        {
          "indent": 1,
          "text": "// 设置预警回调（超时前60秒）",
          "type": "comment"
        },
        {
          "indent": 1,
          "text": "warnDelay = remaining - 60000",
          "type": "action"
        },
        {
          "indent": 1,
          "text": "IF warnDelay > 0 AND listener != null:",
          "type": "condition"
        },
        {
          "indent": 2,
          "text": "SCHEDULE warningRunnable AFTER warnDelay:",
          "type": "action"
        },
        {
          "indent": 3,
          "text": "rem = getRemainingTime()",
          "type": "action"
        },
        {
          "indent": 3,
          "text": "IF isActive AND rem > 0:",
          "type": "condition"
        },
        {
          "indent": 4,
          "text": "listener.onSessionWarning(rem)",
          "type": "action"
        },
        {
          "indent": 1,
          "text": "",
          "type": "action"
        },
        {
          "indent": 1,
          "text": "// 设置超时回调",
          "type": "comment"
        },
        {
          "indent": 1,
          "text": "SCHEDULE timeoutRunnable AFTER remaining:",
          "type": "action"
        },
        {
          "indent": 2,
          "text": "IF NOT isActive:",
          "type": "condition"
        },
        {
          "indent": 3,
          "text": "RETURN",
          "type": "return"
        },
        {
          "indent": 2,
          "text": "IF isIdleExemptForeground():",
          "type": "condition"
        },
        {
          "indent": 3,
          "text": "lastActivityTime = NOW",
          "type": "action"
        },
        {
          "indent": 3,
          "text": "LOG '会话超时命中白名单，已自动续期'",
          "type": "action"
        },
        {
          "indent": 3,
          "text": "startTimeoutTimer()",
          "type": "action"
        },
        {
          "indent": 3,
          "text": "RETURN",
          "type": "return"
        },
        {
          "indent": 2,
          "text": "LOG '会话超时，自动登出'",
          "type": "action"
        },
        {
          "indent": 2,
          "text": "endSession('会话超时')",
          "type": "action"
        },
        {
          "indent": 2,
          "text": "IF listener != null:",
          "type": "condition"
        },
        {
          "indent": 3,
          "text": "listener.onSessionTimeout()",
          "type": "action"
        },
        {
          "indent": 1,
          "text": "",
          "type": "action"
        },
        {
          "indent": 1,
          "text": "LOG '启动会话超时检测，remaining=' + remaining + 'ms'",
          "type": "action"
        }
      ],
      "calls": []
    },
    {
      "id": "parse_login_response_pseudocode",
      "name": "登录响应解析伪代码",
      "code_ref": {
        "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/NetworkAuthService.java",
        "method": "parseLoginResponse",
        "lines": "186-249"
      },
      "steps": [
        {
          "indent": 0,
          "text": "FUNCTION parseLoginResponse(responseBody, username, httpCode):",
          "type": "action"
        },
        {
          "indent": 1,
          "text": "TRY:",
          "type": "action"
        },
        {
          "indent": 2,
          "text": "json = PARSE_JSON(responseBody)",
          "type": "action"
        },
        {
          "indent": 2,
          "text": "",
          "type": "action"
        },
        {
          "indent": 2,
          "text": "status = json.status OR json.code OR -1",
          "type": "action"
        },
        {
          "indent": 2,
          "text": "message = json.message OR json.msg OR ''",
          "type": "action"
        },
        {
          "indent": 2,
          "text": "data = json.data",
          "type": "action"
        },
        {
          "indent": 2,
          "text": "",
          "type": "action"
        },
        {
          "indent": 2,
          "text": "tokenInData = data?.token",
          "type": "action"
        },
        {
          "indent": 2,
          "text": "tokenOk = tokenInData IS NOT EMPTY",
          "type": "action"
        },
        {
          "indent": 2,
          "text": "statusOk = status IN [0, 200, 201]",
          "type": "action"
        },
        {
          "indent": 2,
          "text": "",
          "type": "action"
        },
        {
          "indent": 2,
          "text": "IF NOT statusOk AND NOT tokenOk:",
          "type": "condition"
        },
        {
          "indent": 3,
          "text": "friendly = buildFriendlyErrorMessage(httpCode, status, message)",
          "type": "error"
        },
        {
          "indent": 3,
          "text": "THROW Exception(friendly)",
          "type": "error"
        },
        {
          "indent": 2,
          "text": "",
          "type": "action"
        },
        {
          "indent": 2,
          "text": "IF data IS NULL:",
          "type": "condition"
        },
        {
          "indent": 3,
          "text": "THROW Exception('登录失败：响应缺少data')",
          "type": "error"
        },
        {
          "indent": 2,
          "text": "",
          "type": "action"
        },
        {
          "indent": 2,
          "text": "token = data.token",
          "type": "action"
        },
        {
          "indent": 2,
          "text": "sessionId = data.sid",
          "type": "action"
        },
        {
          "indent": 2,
          "text": "",
          "type": "action"
        },
        {
          "indent": 2,
          "text": "IF token IS EMPTY OR sessionId IS EMPTY:",
          "type": "condition"
        },
        {
          "indent": 3,
          "text": "THROW Exception('登录失败：响应缺少token或sid')",
          "type": "error"
        },
        {
          "indent": 2,
          "text": "",
          "type": "action"
        },
        {
          "indent": 2,
          "text": "user = data.user",
          "type": "action"
        },
        {
          "indent": 2,
          "text": "IF user IS NULL:",
          "type": "condition"
        },
        {
          "indent": 3,
          "text": "THROW Exception('登录失败：响应缺少user信息')",
          "type": "error"
        },
        {
          "indent": 2,
          "text": "",
          "type": "action"
        },
        {
          "indent": 2,
          "text": "userId = user.id",
          "type": "action"
        },
        {
          "indent": 2,
          "text": "realName = user.name OR username",
          "type": "action"
        },
        {
          "indent": 2,
          "text": "department = user.deptName OR ''",
          "type": "action"
        },
        {
          "indent": 2,
          "text": "userRole = user.role OR 'USER'",
          "type": "action"
        },
        {
          "indent": 2,
          "text": "",
          "type": "action"
        },
        {
          "indent": 2,
          "text": "successMessage = message OR '登录成功'",
          "type": "action"
        },
        {
          "indent": 2,
          "text": "",
          "type": "action"
        },
        {
          "indent": 2,
          "text": "userInfo = UserInfo.createFromApiResponse(...)",
          "type": "action"
        },
        {
          "indent": 2,
          "text": "RETURN LoginResponse(userInfo, successMessage)",
          "type": "return"
        },
        {
          "indent": 1,
          "text": "",
          "type": "action"
        },
        {
          "indent": 1,
          "text": "CATCH JSONException:",
          "type": "action"
        },
        {
          "indent": 2,
          "text": "TRY:",
          "type": "action"
        },
        {
          "indent": 3,
          "text": "// 尝试从原始响应提取错误信息",
          "type": "comment"
        },
        {
          "indent": 3,
          "text": "friendly = buildFriendlyErrorMessage(httpCode, status, message)",
          "type": "error"
        },
        {
          "indent": 3,
          "text": "THROW Exception(friendly)",
          "type": "error"
        },
        {
          "indent": 2,
          "text": "CATCH:",
          "type": "action"
        },
        {
          "indent": 3,
          "text": "THROW Exception(buildFriendlyErrorMessage(httpCode, httpCode, ''))",
          "type": "error"
        }
      ],
      "calls": []
    }
  ]
}