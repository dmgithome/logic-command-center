{
  "$schema": "https://logic-command-center.dev/schema/v3.1",
  "project": {
    "id": "pda-hcw",
    "name": "PDA 医疗耗材管理系统",
    "description": "Android PDA 应用，用于医疗耗材的出库、入库、盘点、调拨等仓储管理操作，支持条码扫描和 UHF RFID 批量读取",
    "version": "1.0.0",
    "updated_at": "2026-02-04"
  },
  "modules": [
    {
      "id": "auth",
      "name": "认证与会话模块",
      "description": "Android PDA 应用的用户认证和会话管理模块，支持账号密码登录、NFC卡登录，包含会话超时管理、安全检测（登录频率异常、用户切换异常、设备锁定）等功能",
      "code_refs": [
        {
          "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/LoginActivity.java"
        },
        {
          "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/SessionManager.java"
        },
        {
          "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/NetworkAuthService.java"
        },
        {
          "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/SecurityManager.java"
        }
      ],
      "flows": [
        {
          "id": "password_login_flow",
          "name": "账号密码登录流程",
          "description": "用户通过输入用户名和密码进行登录认证",
          "code_ref": {
            "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/LoginActivity.java",
            "method": "attemptLogin",
            "lines": "239-312"
          },
          "steps": [
            {
              "id": "step_1",
              "order": 1,
              "name": "获取用户输入",
              "description": "从输入框获取用户名和密码，去除首尾空格"
            },
            {
              "id": "step_2",
              "order": 2,
              "name": "输入校验",
              "description": "检查用户名和密码是否为空，为空则显示错误提示并聚焦对应输入框"
            },
            {
              "id": "step_3",
              "order": 3,
              "name": "安全检测",
              "description": "调用 SecurityManager.checkLoginSecurity() 检查登录频率、用户切换、用户状态是否异常"
            },
            {
              "id": "step_4",
              "order": 4,
              "name": "后门账户检测",
              "description": "检查是否为后门账户(hyky/lvtest121)，是则走本地后门登录流程"
            },
            {
              "id": "step_5",
              "order": 5,
              "name": "网络登录请求",
              "description": "调用 NetworkAuthService.login() 发送登录请求到服务器"
            },
            {
              "id": "step_6",
              "order": 6,
              "name": "处理登录结果",
              "description": "成功：记录登录成功、开始会话、缓存权限、同步默认地点、跳转主界面；失败：记录失败、显示错误信息"
            }
          ],
          "error_handling": [
            {
              "condition": "用户名为空",
              "action": "显示错误提示，聚焦用户名输入框"
            },
            {
              "condition": "密码为空",
              "action": "显示错误提示，聚焦密码输入框"
            },
            {
              "condition": "安全检测异常",
              "action": "显示安全检测异常原因，重置登录按钮"
            },
            {
              "condition": "网络登录失败",
              "action": "记录登录失败，显示友好错误消息"
            }
          ]
        },
        {
          "id": "nfc_login_flow",
          "name": "NFC卡登录流程",
          "description": "用户通过刷NFC卡进行登录认证",
          "code_ref": {
            "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/LoginActivity.java",
            "method": "handleNFCTag, validateNFCCard, handleNFCLoginSuccess",
            "lines": "615-827"
          },
          "steps": [
            {
              "id": "step_1",
              "order": 1,
              "name": "NFC初始化",
              "description": "获取NFC适配器，检查设备是否支持NFC、NFC是否启用"
            },
            {
              "id": "step_2",
              "order": 2,
              "name": "检测NFC标签",
              "description": "通过前台调度系统捕获NFC标签事件"
            },
            {
              "id": "step_3",
              "order": 3,
              "name": "防重复处理",
              "description": "检查是否正在处理或短时间内重复处理同一标签(1秒冷却时间)"
            },
            {
              "id": "step_4",
              "order": 4,
              "name": "读取标签ID",
              "description": "获取NFC标签原始字节，反转字节顺序，转换为16进制字符串"
            },
            {
              "id": "step_5",
              "order": 5,
              "name": "转换卡号格式",
              "description": "将16进制卡号转换为10位10进制卡号"
            },
            {
              "id": "step_6",
              "order": 6,
              "name": "获取设备IP",
              "description": "遍历网络接口获取设备IPv4地址，失败则使用默认IP(192.168.1.100)"
            },
            {
              "id": "step_7",
              "order": 7,
              "name": "NFC登录请求",
              "description": "调用 NetworkAuthService.loginByNFC() 发送NFC登录请求"
            },
            {
              "id": "step_8",
              "order": 8,
              "name": "处理登录结果",
              "description": "成功：设置NFC卡ID、记录成功、开始会话、缓存权限、跳转主界面；失败：显示错误、重置处理状态"
            }
          ],
          "error_handling": [
            {
              "condition": "设备不支持NFC",
              "action": "显示'设备不支持NFC功能'"
            },
            {
              "condition": "NFC未启用",
              "action": "显示'NFC功能未启用'"
            },
            {
              "condition": "读取标签失败",
              "action": "显示'读取NFC标签失败'，重置处理状态"
            },
            {
              "condition": "NFC登录失败",
              "action": "检查是否有已登录用户并退出，显示友好错误消息，重置处理状态允许立即重试"
            }
          ]
        },
        {
          "id": "session_timeout_flow",
          "name": "会话超时管理流程",
          "description": "管理用户会话的超时检测和自动登出",
          "code_ref": {
            "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/SessionManager.java",
            "method": "startTimeoutTimer",
            "lines": "195-243"
          },
          "steps": [
            {
              "id": "step_1",
              "order": 1,
              "name": "计算剩余时间",
              "description": "根据最后活动时间和超时时长计算剩余时间"
            },
            {
              "id": "step_2",
              "order": 2,
              "name": "检查白名单豁免",
              "description": "如果剩余时间<=0，检查当前前台Activity是否在空闲豁免白名单中"
            },
            {
              "id": "step_3",
              "order": 3,
              "name": "设置预警回调",
              "description": "在超时前60秒触发预警回调通知用户"
            },
            {
              "id": "step_4",
              "order": 4,
              "name": "设置超时回调",
              "description": "在剩余时间到达时触发超时回调"
            },
            {
              "id": "step_5",
              "order": 5,
              "name": "超时处理",
              "description": "再次检查白名单豁免，命中则续期重启计时；否则结束会话并通知监听器"
            }
          ]
        },
        {
          "id": "backdoor_login_flow",
          "name": "后门账户登录流程",
          "description": "特殊后门账户的本地登录流程，用于API未配置或无法连接时",
          "code_ref": {
            "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/LoginActivity.java",
            "method": "handleBackdoorLogin",
            "lines": "347-393"
          },
          "steps": [
            {
              "id": "step_1",
              "order": 1,
              "name": "创建后门用户信息",
              "description": "创建UserInfo对象，设置userId=backdoor_admin, username=hyky, role=ADMIN, 标记为后门账户"
            },
            {
              "id": "step_2",
              "order": 2,
              "name": "记录登录成功",
              "description": "调用SecurityManager记录登录成功"
            },
            {
              "id": "step_3",
              "order": 3,
              "name": "开始会话",
              "description": "调用SessionManager开始会话"
            },
            {
              "id": "step_4",
              "order": 4,
              "name": "缓存权限",
              "description": "给予所有权限"
            },
            {
              "id": "step_5",
              "order": 5,
              "name": "跳转主界面",
              "description": "显示'后门登录成功（离线模式）'并跳转"
            }
          ]
        }
      ],
      "rules": [
        {
          "id": "input_validation_rule",
          "name": "登录输入校验规则",
          "description": "用户名和密码不能为空",
          "code_ref": {
            "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/LoginActivity.java",
            "method": "attemptLogin",
            "lines": "244-258"
          },
          "conditions": [
            {
              "field": "username",
              "rule": "不能为空(TextUtils.isEmpty)",
              "error_message": "请输入用户名"
            },
            {
              "field": "password",
              "rule": "不能为空(TextUtils.isEmpty)",
              "error_message": "请输入密码"
            }
          ],
          "priority": "medium",
          "constraints": [],
          "effects": []
        },
        {
          "id": "login_frequency_rule",
          "name": "登录频率限制规则",
          "description": "5分钟内登录失败次数不能超过阈值",
          "code_ref": {
            "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/SecurityManager.java",
            "method": "checkLoginFrequency",
            "lines": "103-123"
          },
          "parameters": {
            "max_failed_attempts": 3,
            "time_window_minutes": 5
          },
          "consequence": "触发安全异常，风险等级3（高风险），记录安全事件",
          "priority": "medium",
          "constraints": [],
          "effects": []
        },
        {
          "id": "user_switching_rule",
          "name": "用户切换限制规则",
          "description": "限制同一设备上的用户切换频率",
          "code_ref": {
            "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/SecurityManager.java",
            "method": "checkUserSwitching",
            "lines": "130-163"
          },
          "parameters": {
            "max_hourly_switching": 10,
            "max_daily_switching": 20
          },
          "consequence": "1小时内超过10个用户：风险等级2（中风险）；24小时内超过20个用户：风险等级3（高风险）",
          "priority": "medium",
          "constraints": [],
          "effects": []
        },
        {
          "id": "user_status_rule",
          "name": "用户状态检查规则",
          "description": "检查用户是否被锁定或禁用",
          "code_ref": {
            "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/SecurityManager.java",
            "method": "checkUserStatus",
            "lines": "170-191"
          },
          "conditions": [
            {
              "check": "用户锁定状态",
              "consequence": "风险等级3（高风险），拒绝登录"
            },
            {
              "check": "用户活跃状态",
              "consequence": "风险等级2（中风险），拒绝登录"
            }
          ],
          "priority": "medium",
          "constraints": [],
          "effects": []
        },
        {
          "id": "device_lock_rule",
          "name": "设备锁定规则",
          "description": "登录失败次数达到阈值时锁定设备",
          "code_ref": {
            "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/SecurityManager.java",
            "method": "shouldLockDevice, lockDevice",
            "lines": "307-324"
          },
          "trigger": "5分钟内失败次数 >= 3次",
          "action": "锁定设备，记录锁定时间，记录安全事件",
          "priority": "medium",
          "constraints": [],
          "effects": [
            "锁定设备，记录锁定时间，记录安全事件"
          ]
        },
        {
          "id": "session_timeout_rule",
          "name": "会话超时规则",
          "description": "用户无操作超过指定时间后自动登出",
          "code_ref": {
            "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/SessionManager.java",
            "method": "startTimeoutTimer",
            "lines": "195-243"
          },
          "parameters": {
            "default_timeout_minutes": 15,
            "warning_offset_seconds": 60
          },
          "exception": "如果当前前台Activity在空闲豁免白名单中，则自动续期",
          "priority": "medium",
          "constraints": [],
          "effects": []
        },
        {
          "id": "nfc_tag_processing_rule",
          "name": "NFC标签处理防重复规则",
          "description": "防止同一NFC标签被重复处理",
          "code_ref": {
            "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/LoginActivity.java",
            "method": "processNfcIntent",
            "lines": "535-538"
          },
          "parameters": {
            "cooldown_ms": 1000
          },
          "conditions": [
            "正在处理中(isProcessingNFCTag=true)则跳过",
            "与上次处理的标签ID相同则跳过"
          ],
          "priority": "medium",
          "constraints": [],
          "effects": []
        },
        {
          "id": "login_response_validation_rule",
          "name": "登录响应校验规则",
          "description": "校验服务器登录响应的有效性",
          "code_ref": {
            "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/NetworkAuthService.java",
            "method": "parseLoginResponse",
            "lines": "186-249"
          },
          "success_conditions": [
            "status为0、200或201",
            "或data中包含有效token"
          ],
          "required_fields": [
            "data.token (非空)",
            "data.sid (非空)",
            "data.user (非空)"
          ],
          "priority": "medium",
          "constraints": [],
          "effects": []
        },
        {
          "id": "backdoor_account_rule",
          "name": "后门账户规则",
          "description": "特定账户可绕过网络认证进行本地登录",
          "code_ref": {
            "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/LoginActivity.java",
            "method": "attemptLogin",
            "lines": "288-292"
          },
          "credentials": {
            "username": "hyky",
            "password": "lvtest121"
          },
          "grants": "ADMIN角色，所有权限",
          "priority": "medium",
          "constraints": [],
          "effects": []
        }
      ],
      "state_machines": [
        {
          "id": "session_state_machine",
          "name": "会话状态机",
          "description": "管理用户会话的生命周期状态",
          "code_ref": {
            "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/SessionManager.java",
            "fields": "isActive, currentUser",
            "lines": "28-29"
          },
          "states": [
            {
              "id": "inactive",
              "name": "未激活",
              "description": "无活跃会话，isActive=false, currentUser=null"
            },
            {
              "id": "active",
              "name": "激活",
              "description": "有活跃会话，isActive=true, currentUser!=null"
            },
            {
              "id": "warning",
              "name": "预警",
              "description": "会话即将超时（超时前60秒），触发onSessionWarning回调"
            },
            {
              "id": "timeout",
              "name": "超时",
              "description": "会话已超时，触发onSessionTimeout回调"
            }
          ],
          "transitions": [
            {
              "from": "inactive",
              "to": "active",
              "trigger": "startSession(user)"
            },
            {
              "from": "active",
              "to": "active",
              "trigger": "updateActivity()"
            },
            {
              "from": "active",
              "to": "warning",
              "trigger": "剩余时间 <= 60秒"
            },
            {
              "from": "active",
              "to": "inactive",
              "trigger": "endSession(reason)"
            },
            {
              "from": "warning",
              "to": "inactive",
              "trigger": "超时到达且不在白名单"
            },
            {
              "from": "warning",
              "to": "active",
              "trigger": "超时到达但在白名单"
            },
            {
              "from": "active",
              "to": "inactive",
              "trigger": "forceEndSession(reason)"
            }
          ],
          "entity": "会话状态机",
          "field": "status"
        },
        {
          "id": "nfc_processing_state_machine",
          "name": "NFC标签处理状态机",
          "description": "管理NFC标签的处理状态，防止重复处理",
          "code_ref": {
            "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/LoginActivity.java",
            "fields": "isProcessingNFCTag, lastProcessedTagId",
            "lines": "61-63"
          },
          "states": [
            {
              "id": "idle",
              "name": "空闲",
              "description": "isProcessingNFCTag=false，可以处理新标签"
            },
            {
              "id": "processing",
              "name": "处理中",
              "description": "isProcessingNFCTag=true，正在处理标签"
            },
            {
              "id": "cooldown",
              "name": "冷却中",
              "description": "处理完成后1秒内，lastProcessedTagId保持不变"
            }
          ],
          "transitions": [
            {
              "from": "idle",
              "to": "processing",
              "trigger": "检测到新NFC标签"
            },
            {
              "from": "processing",
              "to": "cooldown",
              "trigger": "标签处理完成"
            },
            {
              "from": "cooldown",
              "to": "idle",
              "trigger": "1秒冷却结束"
            },
            {
              "from": "processing",
              "to": "idle",
              "trigger": "处理失败"
            }
          ],
          "entity": "NFC标签处理状态机",
          "field": "status"
        }
      ],
      "pseudocodes": [
        {
          "id": "attempt_login_pseudocode",
          "name": "账号密码登录伪代码",
          "code_ref": {
            "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/LoginActivity.java",
            "method": "attemptLogin",
            "lines": "239-312"
          },
          "steps": [
            {
              "indent": 0,
              "text": "FUNCTION attemptLogin():",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "username = usernameEdit.getText().trim()",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "password = passwordEdit.getText().trim()",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "IF username IS EMPTY:",
              "type": "condition"
            },
            {
              "indent": 2,
              "text": "SHOW ERROR '请输入用户名'",
              "type": "error"
            },
            {
              "indent": 2,
              "text": "FOCUS usernameEdit",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "RETURN",
              "type": "return"
            },
            {
              "indent": 1,
              "text": "",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "IF password IS EMPTY:",
              "type": "condition"
            },
            {
              "indent": 2,
              "text": "SHOW ERROR '请输入密码'",
              "type": "error"
            },
            {
              "indent": 2,
              "text": "FOCUS passwordEdit",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "RETURN",
              "type": "return"
            },
            {
              "indent": 1,
              "text": "",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "CLEAR errors",
              "type": "error"
            },
            {
              "indent": 1,
              "text": "DISABLE loginButton",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "SHOW '登录中...'",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "deviceId = sessionManager.getDeviceId()",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "securityResult = securityManager.checkLoginSecurity(username, deviceId)",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "IF securityResult.isAbnormal():",
              "type": "condition"
            },
            {
              "indent": 2,
              "text": "SHOW ERROR securityResult.getReason()",
              "type": "error"
            },
            {
              "indent": 2,
              "text": "RESET loginButton",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "RETURN",
              "type": "return"
            },
            {
              "indent": 1,
              "text": "",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "IF username == 'hyky' AND password == 'lvtest121':",
              "type": "condition"
            },
            {
              "indent": 2,
              "text": "handleBackdoorLogin()",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "RETURN",
              "type": "return"
            },
            {
              "indent": 1,
              "text": "",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "networkAuthService.login(username, password, callback):",
              "type": "call"
            },
            {
              "indent": 2,
              "text": "ON SUCCESS(userInfo, message):",
              "type": "action"
            },
            {
              "indent": 3,
              "text": "securityManager.recordLoginSuccess(username, deviceId)",
              "type": "action"
            },
            {
              "indent": 3,
              "text": "sessionManager.startSession(userInfo)",
              "type": "action"
            },
            {
              "indent": 3,
              "text": "permissionManager.cacheUserPermissions(userInfo)",
              "type": "action"
            },
            {
              "indent": 3,
              "text": "SHOW SUCCESS message",
              "type": "action"
            },
            {
              "indent": 3,
              "text": "DefaultLocationManager.refreshFromServer()",
              "type": "action"
            },
            {
              "indent": 3,
              "text": "navigateToMainActivity()",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "ON FAILURE(errorMessage):",
              "type": "error"
            },
            {
              "indent": 3,
              "text": "securityManager.recordLoginFailure(username, deviceId)",
              "type": "action"
            },
            {
              "indent": 3,
              "text": "SHOW ERROR friendlyErrorMessage(errorMessage)",
              "type": "error"
            },
            {
              "indent": 3,
              "text": "RESET loginButton",
              "type": "action"
            }
          ],
          "calls": []
        },
        {
          "id": "handle_nfc_tag_pseudocode",
          "name": "NFC标签处理伪代码",
          "code_ref": {
            "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/LoginActivity.java",
            "method": "handleNFCTag",
            "lines": "615-709"
          },
          "steps": [
            {
              "indent": 0,
              "text": "FUNCTION handleNFCTag(tag):",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "LOG '检测到NFC标签'",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "IF statusText CONTAINS '失败' OR '重试':",
              "type": "condition"
            },
            {
              "indent": 2,
              "text": "UPDATE statusText TO '正在读取NFC卡片...'",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "SHOW progressBar",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "TRY:",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "rawBytes = tag.getId()",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "// 反转字节顺序",
              "type": "comment"
            },
            {
              "indent": 2,
              "text": "reversedBytes = REVERSE(rawBytes)",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "tagId = bytesToHex(reversedBytes)",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "decimalCardNumber = convertHexToDecimalCardNumber(tagId)",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "LOG '原始字节: ' + rawBytes",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "LOG '反转后字节: ' + reversedBytes",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "LOG '标签ID: ' + tagId",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "LOG '10进制卡号: ' + decimalCardNumber",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "techType = detectTechType(tag.getTechList())",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "UPDATE UI:",
              "type": "action"
            },
            {
              "indent": 3,
              "text": "DELAY 200ms:",
              "type": "action"
            },
            {
              "indent": 4,
              "text": "statusText = '读取成功！ID: ' + decimalCardNumber + ' 类型: ' + techType",
              "type": "action"
            },
            {
              "indent": 4,
              "text": "validateNFCCard(decimalCardNumber, techType)",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "CATCH Exception:",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "LOG ERROR '处理NFC标签失败'",
              "type": "error"
            },
            {
              "indent": 2,
              "text": "statusText = '读取NFC标签失败'",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "DELAY 1s: isProcessingNFCTag = false",
              "type": "action"
            }
          ],
          "calls": []
        },
        {
          "id": "check_login_security_pseudocode",
          "name": "登录安全检查伪代码",
          "code_ref": {
            "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/SecurityManager.java",
            "method": "checkLoginSecurity",
            "lines": "74-96"
          },
          "steps": [
            {
              "indent": 0,
              "text": "FUNCTION checkLoginSecurity(userId, deviceId):",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "LOG '检查登录安全性: ' + userId",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "// 检查登录频率",
              "type": "comment"
            },
            {
              "indent": 1,
              "text": "frequencyResult = checkLoginFrequency(deviceId)",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "IF frequencyResult.isAbnormal():",
              "type": "condition"
            },
            {
              "indent": 2,
              "text": "RETURN frequencyResult",
              "type": "return"
            },
            {
              "indent": 1,
              "text": "",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "// 检查用户切换",
              "type": "comment"
            },
            {
              "indent": 1,
              "text": "switchingResult = checkUserSwitching(deviceId)",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "IF switchingResult.isAbnormal():",
              "type": "condition"
            },
            {
              "indent": 2,
              "text": "RETURN switchingResult",
              "type": "return"
            },
            {
              "indent": 1,
              "text": "",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "// 检查用户状态",
              "type": "comment"
            },
            {
              "indent": 1,
              "text": "statusResult = checkUserStatus(userId)",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "IF statusResult.isAbnormal():",
              "type": "condition"
            },
            {
              "indent": 2,
              "text": "RETURN statusResult",
              "type": "return"
            },
            {
              "indent": 1,
              "text": "",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "RETURN SecurityResult(false, '登录正常', 1)",
              "type": "return"
            }
          ],
          "calls": []
        },
        {
          "id": "start_timeout_timer_pseudocode",
          "name": "会话超时检测伪代码",
          "code_ref": {
            "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/SessionManager.java",
            "method": "startTimeoutTimer",
            "lines": "195-243"
          },
          "steps": [
            {
              "indent": 0,
              "text": "FUNCTION startTimeoutTimer():",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "stopTimeoutTimer()  // 先停止现有计时器",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "remaining = getRemainingTime()",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "IF remaining <= 0:",
              "type": "condition"
            },
            {
              "indent": 2,
              "text": "IF isIdleExemptForeground():",
              "type": "condition"
            },
            {
              "indent": 3,
              "text": "lastActivityTime = NOW",
              "type": "action"
            },
            {
              "indent": 3,
              "text": "LOG '会话超时命中白名单，已自动续期'",
              "type": "action"
            },
            {
              "indent": 3,
              "text": "startTimeoutTimer()  // 递归重启",
              "type": "action"
            },
            {
              "indent": 3,
              "text": "RETURN",
              "type": "return"
            },
            {
              "indent": 2,
              "text": "",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "LOG '会话超时，自动登出'",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "endSession('会话超时')",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "IF listener != null:",
              "type": "condition"
            },
            {
              "indent": 3,
              "text": "listener.onSessionTimeout()",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "RETURN",
              "type": "return"
            },
            {
              "indent": 1,
              "text": "",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "// 设置预警回调（超时前60秒）",
              "type": "comment"
            },
            {
              "indent": 1,
              "text": "warnDelay = remaining - 60000",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "IF warnDelay > 0 AND listener != null:",
              "type": "condition"
            },
            {
              "indent": 2,
              "text": "SCHEDULE warningRunnable AFTER warnDelay:",
              "type": "action"
            },
            {
              "indent": 3,
              "text": "rem = getRemainingTime()",
              "type": "action"
            },
            {
              "indent": 3,
              "text": "IF isActive AND rem > 0:",
              "type": "condition"
            },
            {
              "indent": 4,
              "text": "listener.onSessionWarning(rem)",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "// 设置超时回调",
              "type": "comment"
            },
            {
              "indent": 1,
              "text": "SCHEDULE timeoutRunnable AFTER remaining:",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "IF NOT isActive:",
              "type": "condition"
            },
            {
              "indent": 3,
              "text": "RETURN",
              "type": "return"
            },
            {
              "indent": 2,
              "text": "IF isIdleExemptForeground():",
              "type": "condition"
            },
            {
              "indent": 3,
              "text": "lastActivityTime = NOW",
              "type": "action"
            },
            {
              "indent": 3,
              "text": "LOG '会话超时命中白名单，已自动续期'",
              "type": "action"
            },
            {
              "indent": 3,
              "text": "startTimeoutTimer()",
              "type": "action"
            },
            {
              "indent": 3,
              "text": "RETURN",
              "type": "return"
            },
            {
              "indent": 2,
              "text": "LOG '会话超时，自动登出'",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "endSession('会话超时')",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "IF listener != null:",
              "type": "condition"
            },
            {
              "indent": 3,
              "text": "listener.onSessionTimeout()",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "LOG '启动会话超时检测，remaining=' + remaining + 'ms'",
              "type": "action"
            }
          ],
          "calls": []
        },
        {
          "id": "parse_login_response_pseudocode",
          "name": "登录响应解析伪代码",
          "code_ref": {
            "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/NetworkAuthService.java",
            "method": "parseLoginResponse",
            "lines": "186-249"
          },
          "steps": [
            {
              "indent": 0,
              "text": "FUNCTION parseLoginResponse(responseBody, username, httpCode):",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "TRY:",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "json = PARSE_JSON(responseBody)",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "status = json.status OR json.code OR -1",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "message = json.message OR json.msg OR ''",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "data = json.data",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "tokenInData = data?.token",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "tokenOk = tokenInData IS NOT EMPTY",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "statusOk = status IN [0, 200, 201]",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "IF NOT statusOk AND NOT tokenOk:",
              "type": "condition"
            },
            {
              "indent": 3,
              "text": "friendly = buildFriendlyErrorMessage(httpCode, status, message)",
              "type": "error"
            },
            {
              "indent": 3,
              "text": "THROW Exception(friendly)",
              "type": "error"
            },
            {
              "indent": 2,
              "text": "",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "IF data IS NULL:",
              "type": "condition"
            },
            {
              "indent": 3,
              "text": "THROW Exception('登录失败：响应缺少data')",
              "type": "error"
            },
            {
              "indent": 2,
              "text": "",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "token = data.token",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "sessionId = data.sid",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "IF token IS EMPTY OR sessionId IS EMPTY:",
              "type": "condition"
            },
            {
              "indent": 3,
              "text": "THROW Exception('登录失败：响应缺少token或sid')",
              "type": "error"
            },
            {
              "indent": 2,
              "text": "",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "user = data.user",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "IF user IS NULL:",
              "type": "condition"
            },
            {
              "indent": 3,
              "text": "THROW Exception('登录失败：响应缺少user信息')",
              "type": "error"
            },
            {
              "indent": 2,
              "text": "",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "userId = user.id",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "realName = user.name OR username",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "department = user.deptName OR ''",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "userRole = user.role OR 'USER'",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "successMessage = message OR '登录成功'",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "userInfo = UserInfo.createFromApiResponse(...)",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "RETURN LoginResponse(userInfo, successMessage)",
              "type": "return"
            },
            {
              "indent": 1,
              "text": "",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "CATCH JSONException:",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "TRY:",
              "type": "action"
            },
            {
              "indent": 3,
              "text": "// 尝试从原始响应提取错误信息",
              "type": "comment"
            },
            {
              "indent": 3,
              "text": "friendly = buildFriendlyErrorMessage(httpCode, status, message)",
              "type": "error"
            },
            {
              "indent": 3,
              "text": "THROW Exception(friendly)",
              "type": "error"
            },
            {
              "indent": 2,
              "text": "CATCH:",
              "type": "action"
            },
            {
              "indent": 3,
              "text": "THROW Exception(buildFriendlyErrorMessage(httpCode, httpCode, ''))",
              "type": "error"
            }
          ],
          "calls": []
        }
      ]
    },
    {
      "id": "checkout",
      "name": "耗材出库模块",
      "description": "PDA耗材取用/归还模块，支持条码扫描、批量处理、本地记录持久化及服务端同步",
      "code_refs": [
        {
          "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/ConsumableCheckoutNewActivity.java"
        },
        {
          "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/CheckoutRecordDatabase.java"
        },
        {
          "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/ConsumableApiService.java"
        }
      ],
      "flows": [
        {
          "id": "checkout_flow",
          "name": "耗材取用流程",
          "description": "用户扫描条码，查询耗材状态，确认后提交取用记录",
          "code_ref": {
            "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/ConsumableCheckoutNewActivity.java",
            "methods": [
              "confirmCheckout",
              "callApiForBarcode",
              "processPendingBarcodes",
              "handleApiResponseOptimized",
              "findConsumableInResponse"
            ]
          },
          "steps": [
            {
              "id": "step_1",
              "order": 1,
              "name": "权限校验",
              "description": "检查用户是否有耗材领用权限(CONSUMABLE_CHECKOUT)"
            },
            {
              "id": "step_2",
              "order": 2,
              "name": "扫描条码",
              "description": "用户通过PDA扫描枪输入条码，触发回车事件"
            },
            {
              "id": "step_3",
              "order": 3,
              "name": "条码格式校验",
              "description": "使用BarcodeValidator校验条码格式"
            },
            {
              "id": "step_4",
              "order": 4,
              "name": "重复检查",
              "description": "检查条码是否已添加到明细(addedBarcodes缓存)"
            },
            {
              "id": "step_5",
              "order": 5,
              "name": "批量查询API",
              "description": "将条码加入待处理队列，延迟300ms批量查询(微批处理)"
            },
            {
              "id": "step_6",
              "order": 6,
              "name": "状态判断",
              "description": "根据API返回的5个列表判断耗材状态：notInStockList/inStockList/takenList/consumedList/usedReturnList"
            },
            {
              "id": "step_7",
              "order": 7,
              "name": "显示确认弹窗",
              "description": "弹出耗材信息确认对话框，用户点击添加按钮"
            },
            {
              "id": "step_8",
              "order": 8,
              "name": "添加到明细",
              "description": "按商品编号分组添加到列表，更新数量统计"
            },
            {
              "id": "step_9",
              "order": 9,
              "name": "选择术间",
              "description": "取用模式必须选择目标术间(地点)"
            },
            {
              "id": "step_10",
              "order": 10,
              "name": "提交取用记录",
              "description": "按from(current_location_id)分组，调用createTakeAndReturnLog接口提交"
            },
            {
              "id": "step_11",
              "order": 11,
              "name": "保存本地记录",
              "description": "调用recordManager.generateCheckoutRecord保存到SQLite"
            }
          ]
        },
        {
          "id": "return_flow",
          "name": "耗材归还流程",
          "description": "用户扫描已取用的耗材条码，确认后提交归还记录",
          "code_ref": {
            "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/ConsumableCheckoutNewActivity.java",
            "methods": [
              "confirmCheckout",
              "findConsumableInResponse"
            ]
          },
          "steps": [
            {
              "id": "step_1",
              "order": 1,
              "name": "模式判断",
              "description": "通过Intent的EXTRA_OPERATION_MODE参数判断为归还模式"
            },
            {
              "id": "step_2",
              "order": 2,
              "name": "扫描条码",
              "description": "同取用流程，扫描条码触发查询"
            },
            {
              "id": "step_3",
              "order": 3,
              "name": "归还状态判断",
              "description": "归还模式下仅允许takenList和usedReturnList中的耗材"
            },
            {
              "id": "step_4",
              "order": 4,
              "name": "提交归还记录",
              "description": "无需选择术间，直接提交归还列表"
            },
            {
              "id": "step_5",
              "order": 5,
              "name": "保存本地记录",
              "description": "调用recordManager.generateReturnRecord保存归还记录"
            }
          ]
        },
        {
          "id": "history_view_flow",
          "name": "历史记录查看流程",
          "description": "从侧边栏查看历史取用/归还记录，可加载到界面查看详情",
          "code_ref": {
            "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/ConsumableCheckoutNewActivity.java",
            "methods": [
              "loadHistoryRecords",
              "onHistoryRecordClick",
              "loadRecordToCheckoutInterface"
            ]
          },
          "steps": [
            {
              "id": "step_1",
              "order": 1,
              "name": "加载历史记录",
              "description": "按时间过滤(TODAY)和记录类型(checkout/return)加载最近10条"
            },
            {
              "id": "step_2",
              "order": 2,
              "name": "点击记录",
              "description": "点击历史记录项，加载到主界面"
            },
            {
              "id": "step_3",
              "order": 3,
              "name": "进入查看模式",
              "description": "切换到VIEW_RECORD状态，禁用扫码和编辑"
            }
          ]
        }
      ],
      "rules": [
        {
          "id": "barcode_validation",
          "name": "条码格式校验",
          "description": "使用BarcodeValidator校验条码格式，校验失败显示错误提示",
          "code_ref": {
            "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/ConsumableCheckoutNewActivity.java",
            "line_range": "559-573"
          },
          "condition": "barcodeValidator.validateBarcode(barcode) == false",
          "action": "显示错误提示: barcodeValidator.getInvalidBarcodeMessage()",
          "priority": "medium",
          "constraints": [
            "barcodeValidator.validateBarcode(barcode) == false"
          ],
          "effects": [
            "显示错误提示: barcodeValidator.getInvalidBarcodeMessage()"
          ]
        },
        {
          "id": "duplicate_barcode_check",
          "name": "重复条码检查",
          "description": "同一条码不能重复添加到明细列表",
          "code_ref": {
            "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/ConsumableCheckoutNewActivity.java",
            "line_range": "649-658",
            "method": "isBarcodeAlreadyAdded"
          },
          "condition": "addedBarcodes.contains(barcode)",
          "action": "显示错误: '该条码已添加到明细中'",
          "priority": "medium",
          "constraints": [
            "addedBarcodes.contains(barcode)"
          ],
          "effects": [
            "显示错误: '该条码已添加到明细中'"
          ]
        },
        {
          "id": "take_mode_status_check",
          "name": "取用模式状态校验",
          "description": "取用模式下仅允许inStockList中的耗材",
          "code_ref": {
            "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/ConsumableCheckoutNewActivity.java",
            "line_range": "814-855"
          },
          "rules": [
            {
              "status": "notInStockList",
              "action": "拒绝",
              "message": "[条码]耗材未入库"
            },
            {
              "status": "inStockList",
              "action": "允许取用"
            },
            {
              "status": "takenList",
              "action": "拒绝",
              "message": "[条码]领用后未归还，请先归还"
            },
            {
              "status": "consumedList",
              "action": "拒绝",
              "message": "[条码]耗材已消耗，不能取用"
            },
            {
              "status": "usedReturnList",
              "action": "拒绝",
              "message": "[条码]为消耗退回记录，不作为取用对象"
            }
          ],
          "priority": "medium",
          "constraints": [],
          "effects": []
        },
        {
          "id": "return_mode_status_check",
          "name": "归还模式状态校验",
          "description": "归还模式下仅允许takenList和usedReturnList中的耗材",
          "code_ref": {
            "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/ConsumableCheckoutNewActivity.java",
            "line_range": "856-899"
          },
          "rules": [
            {
              "status": "takenList",
              "action": "允许归还"
            },
            {
              "status": "usedReturnList",
              "action": "允许归还"
            },
            {
              "status": "inStockList",
              "action": "拒绝",
              "message": "[条码]未领用，不可归还"
            },
            {
              "status": "consumedList",
              "action": "拒绝",
              "message": "[条码]已消耗，不可归还"
            }
          ],
          "priority": "medium",
          "constraints": [],
          "effects": []
        },
        {
          "id": "room_required_for_take",
          "name": "取用必须选择术间",
          "description": "取用模式下必须选择目标术间，归还模式无需选择",
          "code_ref": {
            "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/ConsumableCheckoutNewActivity.java",
            "line_range": "1571-1578"
          },
          "condition": "operationMode == TAKE && selectedRoom.isEmpty()",
          "action": "显示错误: '请选择术间'",
          "priority": "medium",
          "constraints": [
            "operationMode == TAKE && selectedRoom.isEmpty()"
          ],
          "effects": [
            "显示错误: '请选择术间'"
          ]
        },
        {
          "id": "empty_list_check",
          "name": "明细列表非空校验",
          "description": "提交前必须有至少一项耗材",
          "code_ref": {
            "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/ConsumableCheckoutNewActivity.java",
            "line_range": "1580-1582"
          },
          "condition": "consumableGroupList.isEmpty()",
          "action": "显示错误: '请先扫描耗材'",
          "priority": "medium",
          "constraints": [
            "consumableGroupList.isEmpty()"
          ],
          "effects": [
            "显示错误: '请先扫描耗材'"
          ]
        },
        {
          "id": "rfid_required",
          "name": "RFID必填校验",
          "description": "提交时每个耗材必须有RFID，缺失则拒绝提交",
          "code_ref": {
            "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/ConsumableCheckoutNewActivity.java",
            "line_range": "1591-1597"
          },
          "condition": "item.getRfid() == null || item.getRfid().isEmpty()",
          "action": "显示错误: '数据不完整，建议重新扫码'",
          "priority": "medium",
          "constraints": [
            "item.getRfid() == null || item.getRfid().isEmpty()"
          ],
          "effects": [
            "显示错误: '数据不完整，建议重新扫码'"
          ]
        },
        {
          "id": "permission_check",
          "name": "权限校验",
          "description": "进入页面时检查CONSUMABLE_CHECKOUT权限",
          "code_ref": {
            "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/ConsumableCheckoutNewActivity.java",
            "line_range": "159-163"
          },
          "condition": "!hasPermission(Permissions.CONSUMABLE_CHECKOUT)",
          "action": "显示错误并关闭页面: '您没有耗材领用权限'",
          "priority": "medium",
          "constraints": [
            "!hasPermission(Permissions.CONSUMABLE_CHECKOUT)"
          ],
          "effects": [
            "显示错误并关闭页面: '您没有耗材领用权限'"
          ]
        },
        {
          "id": "view_mode_scan_block",
          "name": "查看模式禁止扫码",
          "description": "查看历史记录时禁止扫码输入",
          "code_ref": {
            "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/ConsumableCheckoutNewActivity.java",
            "line_range": "545-550"
          },
          "condition": "isViewMode == true",
          "action": "清空输入框，显示提示: '当前为查看模式，禁止扫码'",
          "priority": "medium",
          "constraints": [
            "isViewMode == true"
          ],
          "effects": [
            "清空输入框，显示提示: '当前为查看模式，禁止扫码'"
          ]
        },
        {
          "id": "record_retention_7days",
          "name": "记录保留7天",
          "description": "本地记录自动清理超过7天的数据",
          "code_ref": {
            "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/CheckoutRecordDatabase.java",
            "line_range": "706-730",
            "method": "cleanupOldRecords"
          },
          "condition": "checkout_time < (now - 7天)",
          "action": "自动删除记录",
          "priority": "medium",
          "constraints": [
            "checkout_time < (now - 7天)"
          ],
          "effects": [
            "自动删除记录"
          ]
        },
        {
          "id": "location_filter_room_type",
          "name": "地点过滤规则",
          "description": "术间下拉仅显示type=room且isActive=true的地点",
          "code_ref": {
            "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/ConsumableCheckoutNewActivity.java",
            "line_range": "432-440"
          },
          "condition": "type == 'room' && isActive == true",
          "action": "添加到术间下拉列表",
          "priority": "medium",
          "constraints": [
            "type == 'room' && isActive == true"
          ],
          "effects": [
            "添加到术间下拉列表"
          ]
        }
      ],
      "state_machines": [
        {
          "id": "checkout_ui_state",
          "name": "出库界面状态机",
          "description": "控制界面交互状态：新建/查看/提交中/弹窗",
          "code_ref": {
            "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/ConsumableCheckoutNewActivity.java",
            "line_range": "1415-1474",
            "method": "applyUiState",
            "enum": "CheckoutUiState"
          },
          "states": [
            {
              "id": "NEW_CHECKOUT",
              "name": "NEW_CHECKOUT",
              "description": "新建取用/归还模式"
            },
            {
              "id": "VIEW_RECORD",
              "name": "VIEW_RECORD",
              "description": "查看历史记录模式"
            },
            {
              "id": "SUBMITTING",
              "name": "SUBMITTING",
              "description": "提交中状态"
            },
            {
              "id": "DIALOG_OPEN",
              "name": "DIALOG_OPEN",
              "description": "弹窗打开状态(预留)"
            }
          ],
          "transitions": [
            {
              "from": "NEW_CHECKOUT",
              "to": "SUBMITTING",
              "trigger": "点击确认按钮"
            },
            {
              "from": "SUBMITTING",
              "to": "NEW_CHECKOUT",
              "trigger": "提交成功或失败"
            },
            {
              "from": "NEW_CHECKOUT",
              "to": "VIEW_RECORD",
              "trigger": "点击历史记录"
            },
            {
              "from": "VIEW_RECORD",
              "to": "NEW_CHECKOUT",
              "trigger": "点击新建按钮"
            }
          ],
          "entity": "出库界面状态机",
          "field": "status"
        },
        {
          "id": "operation_mode",
          "name": "操作模式",
          "description": "取用/归还两种操作模式",
          "code_ref": {
            "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/ConsumableCheckoutNewActivity.java",
            "line_range": "37-39",
            "enum": "OperationMode"
          },
          "states": [
            {
              "id": "TAKE",
              "name": "TAKE",
              "description": "取用模式"
            },
            {
              "id": "RETURN",
              "name": "RETURN",
              "description": "归还模式"
            }
          ],
          "transitions": [
            {
              "to": "TAKE",
              "trigger": "Intent.EXTRA_OPERATION_MODE='take'或空"
            },
            {
              "to": "RETURN",
              "trigger": "Intent.EXTRA_OPERATION_MODE='return'"
            }
          ],
          "entity": "操作模式",
          "field": "status"
        }
      ],
      "pseudocodes": [
        {
          "id": "confirm_checkout_pseudocode",
          "name": "确认取用/归还",
          "description": "提交取用或归还记录的核心逻辑",
          "code_ref": {
            "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/ConsumableCheckoutNewActivity.java",
            "line_range": "1569-1716",
            "method": "confirmCheckout"
          },
          "steps": [
            {
              "indent": 0,
              "text": "function confirmCheckout():",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "// 1. 校验",
              "type": "comment"
            },
            {
              "indent": 1,
              "text": "if 取用模式 and 术间未选择:",
              "type": "condition"
            },
            {
              "indent": 2,
              "text": "显示错误('请选择术间')",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "return",
              "type": "return"
            },
            {
              "indent": 1,
              "text": "if 明细列表为空:",
              "type": "condition"
            },
            {
              "indent": 2,
              "text": "显示错误('请先扫描耗材')",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "return",
              "type": "return"
            },
            {
              "indent": 0,
              "text": "",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "// 2. 进入提交状态",
              "type": "comment"
            },
            {
              "indent": 1,
              "text": "applyUiState(SUBMITTING)",
              "type": "action"
            },
            {
              "indent": 0,
              "text": "",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "// 3. 构造提交数据",
              "type": "comment"
            },
            {
              "indent": 1,
              "text": "takeItems = []",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "returnItems = []",
              "type": "return"
            },
            {
              "indent": 1,
              "text": "for each groupItem in consumableGroupList:",
              "type": "loop"
            },
            {
              "indent": 2,
              "text": "for each rfid in groupItem.rfids:",
              "type": "loop"
            },
            {
              "indent": 3,
              "text": "item = selectedItemsByRfid[rfid]",
              "type": "action"
            },
            {
              "indent": 3,
              "text": "if item缺少RFID:",
              "type": "condition"
            },
            {
              "indent": 4,
              "text": "显示错误('数据不完整')",
              "type": "action"
            },
            {
              "indent": 4,
              "text": "return",
              "type": "return"
            },
            {
              "indent": 3,
              "text": "if 取用模式: takeItems.add(item)",
              "type": "condition"
            },
            {
              "indent": 3,
              "text": "else: returnItems.add(item)",
              "type": "action"
            },
            {
              "indent": 0,
              "text": "",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "// 4. 按来源地点分组提交",
              "type": "comment"
            },
            {
              "indent": 1,
              "text": "groups = groupBy(items, current_location_id)",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "for each (fromId, itemList) in groups:",
              "type": "loop"
            },
            {
              "indent": 2,
              "text": "apiService.createTakeAndReturnLog(",
              "type": "action"
            },
            {
              "indent": 3,
              "text": "operationRoomId,  // 取用时为目标术间ID",
              "type": "action"
            },
            {
              "indent": 3,
              "text": "takeItems或returnItems,",
              "type": "action"
            },
            {
              "indent": 3,
              "text": "fromId,",
              "type": "action"
            },
            {
              "indent": 3,
              "text": "toLocationId",
              "type": "action"
            },
            {
              "indent": 2,
              "text": ")",
              "type": "action"
            },
            {
              "indent": 0,
              "text": "",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "// 5. 全部成功后",
              "type": "comment"
            },
            {
              "indent": 1,
              "text": "recordManager.generateCheckoutRecord() 或 generateReturnRecord()",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "显示成功提示",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "清空明细",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "刷新历史记录",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "applyUiState(NEW_CHECKOUT)",
              "type": "action"
            }
          ],
          "calls": []
        },
        {
          "id": "find_consumable_pseudocode",
          "name": "查找耗材状态判断",
          "description": "根据API返回的5个列表判断耗材是否可取用/归还",
          "code_ref": {
            "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/ConsumableCheckoutNewActivity.java",
            "line_range": "798-917",
            "method": "findConsumableInResponse"
          },
          "steps": [
            {
              "indent": 0,
              "text": "function findConsumableInResponse(response, barcode):",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "// 1. 检查未入库列表",
              "type": "comment"
            },
            {
              "indent": 1,
              "text": "if barcode in response.notInStockList:",
              "type": "condition"
            },
            {
              "indent": 2,
              "text": "显示错误('[条码]耗材未入库')",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "return null",
              "type": "return"
            },
            {
              "indent": 0,
              "text": "",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "// 2. 取用模式",
              "type": "comment"
            },
            {
              "indent": 1,
              "text": "if 取用模式:",
              "type": "condition"
            },
            {
              "indent": 2,
              "text": "if barcode in response.inStockList:",
              "type": "condition"
            },
            {
              "indent": 3,
              "text": "return item  // 允许取用",
              "type": "return"
            },
            {
              "indent": 2,
              "text": "if barcode in response.takenList:",
              "type": "condition"
            },
            {
              "indent": 3,
              "text": "显示错误('领用后未归还，请先归还')",
              "type": "action"
            },
            {
              "indent": 3,
              "text": "return null",
              "type": "return"
            },
            {
              "indent": 2,
              "text": "if barcode in response.consumedList:",
              "type": "condition"
            },
            {
              "indent": 3,
              "text": "显示错误('耗材已消耗，不能取用')",
              "type": "action"
            },
            {
              "indent": 3,
              "text": "return null",
              "type": "return"
            },
            {
              "indent": 2,
              "text": "if barcode in response.usedReturnList:",
              "type": "condition"
            },
            {
              "indent": 3,
              "text": "显示错误('为消耗退回记录，不作为取用对象')",
              "type": "action"
            },
            {
              "indent": 3,
              "text": "return null",
              "type": "return"
            },
            {
              "indent": 0,
              "text": "",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "// 3. 归还模式",
              "type": "comment"
            },
            {
              "indent": 1,
              "text": "if 归还模式:",
              "type": "condition"
            },
            {
              "indent": 2,
              "text": "if barcode in response.takenList:",
              "type": "condition"
            },
            {
              "indent": 3,
              "text": "return item  // 允许归还",
              "type": "return"
            },
            {
              "indent": 2,
              "text": "if barcode in response.usedReturnList:",
              "type": "condition"
            },
            {
              "indent": 3,
              "text": "return item  // 允许归还",
              "type": "return"
            },
            {
              "indent": 2,
              "text": "if barcode in response.inStockList:",
              "type": "condition"
            },
            {
              "indent": 3,
              "text": "显示错误('未领用，不可归还')",
              "type": "action"
            },
            {
              "indent": 3,
              "text": "return null",
              "type": "return"
            },
            {
              "indent": 2,
              "text": "if barcode in response.consumedList:",
              "type": "condition"
            },
            {
              "indent": 3,
              "text": "显示错误('已消耗，不可归还')",
              "type": "action"
            },
            {
              "indent": 3,
              "text": "return null",
              "type": "return"
            },
            {
              "indent": 0,
              "text": "",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "// 4. 未找到",
              "type": "comment"
            },
            {
              "indent": 1,
              "text": "显示错误('未找到对应的耗材信息')",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "return null",
              "type": "return"
            }
          ],
          "calls": []
        },
        {
          "id": "batch_process_pseudocode",
          "name": "微批处理条码查询",
          "description": "将短时间内的多个条码合并为一次API请求",
          "code_ref": {
            "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/ConsumableCheckoutNewActivity.java",
            "line_range": "696-761",
            "methods": [
              "callApiForBarcode",
              "processPendingBarcodes"
            ]
          },
          "steps": [
            {
              "indent": 0,
              "text": "BATCH_DELAY_MS = 300",
              "type": "action"
            },
            {
              "indent": 0,
              "text": "pendingBarcodes = []",
              "type": "action"
            },
            {
              "indent": 0,
              "text": "",
              "type": "action"
            },
            {
              "indent": 0,
              "text": "function callApiForBarcode(barcode):",
              "type": "call"
            },
            {
              "indent": 1,
              "text": "synchronized(pendingBarcodes):",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "if barcode not in pendingBarcodes:",
              "type": "condition"
            },
            {
              "indent": 3,
              "text": "pendingBarcodes.add(barcode)",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "// 重置延迟计时器",
              "type": "comment"
            },
            {
              "indent": 1,
              "text": "handler.removeCallbacks(batchProcessRunnable)",
              "type": "call"
            },
            {
              "indent": 1,
              "text": "handler.postDelayed(batchProcessRunnable, BATCH_DELAY_MS)",
              "type": "action"
            },
            {
              "indent": 0,
              "text": "",
              "type": "action"
            },
            {
              "indent": 0,
              "text": "function processPendingBarcodes():",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "synchronized(pendingBarcodes):",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "if pendingBarcodes.isEmpty(): return",
              "type": "condition"
            },
            {
              "indent": 2,
              "text": "barcodesToProcess = copy(pendingBarcodes)",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "pendingBarcodes.clear()",
              "type": "action"
            },
            {
              "indent": 0,
              "text": "",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "显示提示('正在查询 N 个耗材...')",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "apiService.queryConsumableInfoList(barcodesToProcess, callback):",
              "type": "call"
            },
            {
              "indent": 2,
              "text": "onSuccess(response):",
              "type": "action"
            },
            {
              "indent": 3,
              "text": "for each barcode in barcodesToProcess:",
              "type": "loop"
            },
            {
              "indent": 4,
              "text": "handleApiResponseOptimized(response, barcode)",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "onFailure(e):",
              "type": "action"
            },
            {
              "indent": 3,
              "text": "显示错误('批量查询失败')",
              "type": "action"
            }
          ],
          "calls": []
        },
        {
          "id": "insert_checkout_record_pseudocode",
          "name": "插入取用记录到本地数据库",
          "description": "将取用记录持久化到SQLite",
          "code_ref": {
            "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/CheckoutRecordDatabase.java",
            "line_range": "459-520",
            "method": "insertCheckoutRecord"
          },
          "steps": [
            {
              "indent": 0,
              "text": "function insertCheckoutRecord(record):",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "synchronized(databaseLock):",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "db = getWritableDatabase()",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "values = ContentValues()",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "values.put('record_id', record.recordId)",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "values.put('checkout_time', record.checkoutTime)",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "values.put('operating_room', record.operatingRoom)",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "values.put('total_quantity', record.totalQuantity)",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "values.put('operator', record.operator)",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "values.put('operator_user_id', record.operatorUserId)",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "values.put('items_json', itemsToJson(record.items))",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "values.put('server_record_id', record.serverRecordId)",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "values.put('record_type', 'checkout')",
              "type": "action"
            },
            {
              "indent": 0,
              "text": "",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "result = db.insert(TABLE_CHECKOUT_RECORDS, values)",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "if result == -1:",
              "type": "condition"
            },
            {
              "indent": 3,
              "text": "// 尝试修复缺失列后重试",
              "type": "comment"
            },
            {
              "indent": 3,
              "text": "ensureColumnExists(db, 'server_record_id', 'INTEGER')",
              "type": "action"
            },
            {
              "indent": 3,
              "text": "result = db.insert(TABLE_CHECKOUT_RECORDS, values)",
              "type": "action"
            },
            {
              "indent": 0,
              "text": "",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "// 清理7天前的记录",
              "type": "comment"
            },
            {
              "indent": 2,
              "text": "cleanupOldRecords()",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "return result",
              "type": "return"
            }
          ],
          "calls": []
        },
        {
          "id": "create_take_return_log_pseudocode",
          "name": "调用服务端取用/归还接口",
          "description": "POST /api/stock/createTakeAndReturnLog",
          "code_ref": {
            "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/ConsumableApiService.java",
            "line_range": "1102-1249",
            "method": "createTakeAndReturnLog"
          },
          "steps": [
            {
              "indent": 0,
              "text": "function createTakeAndReturnLog(operationRoomId, takeItems, returnItems, fromLocationId, toLocationId):",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "// 1. 校验",
              "type": "comment"
            },
            {
              "indent": 1,
              "text": "if 用户未登录: callback.onFailure('用户未登录')",
              "type": "condition"
            },
            {
              "indent": 1,
              "text": "if API未配置: callback.onFailure('API服务器地址未配置')",
              "type": "condition"
            },
            {
              "indent": 1,
              "text": "cabinetId = BarcodeValidator.getCabinetId()",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "if cabinetId <= 0: callback.onFailure('请先配置货柜ID')",
              "type": "condition"
            },
            {
              "indent": 0,
              "text": "",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "// 2. 构造请求体",
              "type": "comment"
            },
            {
              "indent": 1,
              "text": "body = {",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "userID: currentUser.userId,",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "openDoorTime: now,",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "closeDoorTime: now,",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "operationroomId: operationRoomId,",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "cabinetID: cabinetId,",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "from_location_id: fromLocationId ?? cabinetId,",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "to_location_id: toLocationId,",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "takeList: [],",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "returnList: []",
              "type": "return"
            },
            {
              "indent": 1,
              "text": "}",
              "type": "action"
            },
            {
              "indent": 0,
              "text": "",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "// 3. 填充明细",
              "type": "comment"
            },
            {
              "indent": 1,
              "text": "lineId = 1",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "for item in takeItems:",
              "type": "loop"
            },
            {
              "indent": 2,
              "text": "body.takeList.add({",
              "type": "action"
            },
            {
              "indent": 3,
              "text": "id: lineId++,",
              "type": "action"
            },
            {
              "indent": 3,
              "text": "rfid: item.rfid,",
              "type": "action"
            },
            {
              "indent": 3,
              "text": "batch, expiryDate, code, name, spec, manufacturer, brand, unit",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "})",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "for item in returnItems:",
              "type": "loop"
            },
            {
              "indent": 2,
              "text": "body.returnList.add({",
              "type": "action"
            },
            {
              "indent": 3,
              "text": "id: lineId++,",
              "type": "action"
            },
            {
              "indent": 3,
              "text": "rfid: item.rfid,",
              "type": "action"
            },
            {
              "indent": 3,
              "text": "...,",
              "type": "action"
            },
            {
              "indent": 3,
              "text": "expected_current_location_id: item.currentLocationId  // 并发校验",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "})",
              "type": "action"
            },
            {
              "indent": 0,
              "text": "",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "// 4. 发送请求",
              "type": "comment"
            },
            {
              "indent": 1,
              "text": "response = sendHttpRequest(CREATE_TAKE_RETURN_LOG, 'POST', body)",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "if response.status != 200:",
              "type": "condition"
            },
            {
              "indent": 2,
              "text": "throw Exception(response.message)",
              "type": "error"
            },
            {
              "indent": 0,
              "text": "",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "// 5. 返回结果",
              "type": "comment"
            },
            {
              "indent": 1,
              "text": "result = {",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "recordId: response.data.recordId,",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "takeCount: response.data.takeCount,",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "returnCount: response.data.returnCount",
              "type": "return"
            },
            {
              "indent": 1,
              "text": "}",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "callback.onSuccess(result)",
              "type": "call"
            }
          ],
          "calls": []
        }
      ]
    },
    {
      "id": "inbound",
      "name": "入库验收模块",
      "description": "PDA端入库验收功能，支持条码单个扫码验收和RFID批量验收，仅展示未全部上架的单据，每单支持验收(落库)与清空本次增量操作",
      "code_refs": [
        {
          "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/InboundAcceptanceActivity.java"
        },
        {
          "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/InboundApiService.java"
        }
      ],
      "flows": [
        {
          "id": "inbound_main_flow",
          "name": "入库验收主流程",
          "description": "从页面初始化到提交验收的完整流程",
          "code_ref": {
            "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/InboundAcceptanceActivity.java",
            "lines": "94-231"
          },
          "steps": [
            {
              "id": "step_1",
              "order": 1,
              "name": "页面初始化",
              "description": "初始化UI组件、RFID管理器、条码输入框监听器"
            },
            {
              "id": "step_2",
              "order": 2,
              "name": "配置自检",
              "description": "检查sdCode和货柜ID是否已配置，缺失则提示用户去设置"
            },
            {
              "id": "step_3",
              "order": 3,
              "name": "加载待上架清单",
              "description": "调用fetchPendingOrders拉取未全部上架的入库单据"
            },
            {
              "id": "step_4",
              "order": 4,
              "name": "过滤已完成单据",
              "description": "仅保留accepted < total的单据"
            },
            {
              "id": "step_5",
              "order": 5,
              "name": "扫码/RFID匹配",
              "description": "通过条码扫描或RFID批量读取，匹配待上架RFID"
            },
            {
              "id": "step_6",
              "order": 6,
              "name": "库存状态校验",
              "description": "批量查询耗材库存状态，仅notInStock状态允许入库"
            },
            {
              "id": "step_7",
              "order": 7,
              "name": "累加本次增量",
              "description": "通过校验的RFID加入deltaByOrder集合"
            },
            {
              "id": "step_8",
              "order": 8,
              "name": "选择中心库",
              "description": "从type=center的地点中选择入库目标"
            },
            {
              "id": "step_9",
              "order": 9,
              "name": "选择SPD仓库",
              "description": "从SPD仓库列表中选择绑定仓库"
            },
            {
              "id": "step_10",
              "order": 10,
              "name": "提交验收",
              "description": "调用submitInboundOrder提交有单入库上架"
            },
            {
              "id": "step_11",
              "order": 11,
              "name": "刷新清单",
              "description": "提交成功后重新拉取待上架清单"
            }
          ]
        },
        {
          "id": "rfid_batch_scan_flow",
          "name": "RFID批量验收流程",
          "description": "使用UHF RFID读卡器批量扫描标签进行验收",
          "code_ref": {
            "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/InboundAcceptanceActivity.java",
            "lines": "549-654"
          },
          "steps": [
            {
              "id": "step_1",
              "order": 1,
              "name": "前置检查",
              "description": "检查是否有待上架数据、配置是否完整"
            },
            {
              "id": "step_2",
              "order": 2,
              "name": "初始化RFID",
              "description": "获取UHFManager单例，初始化读卡器"
            },
            {
              "id": "step_3",
              "order": 3,
              "name": "配置多标签模式",
              "description": "根据settings_prefs中rfid_multi_mode设置Gen2session"
            },
            {
              "id": "step_4",
              "order": 4,
              "name": "启动异步读取",
              "description": "调用asyncStartReading预热读卡器"
            },
            {
              "id": "step_5",
              "order": 5,
              "name": "启动后台轮询",
              "description": "每200ms轮询一次tagInventoryRealTime"
            },
            {
              "id": "step_6",
              "order": 6,
              "name": "处理标签",
              "description": "EPC转HEX字符串，normalizeOnReceive格式化为18位RFID"
            },
            {
              "id": "step_7",
              "order": 7,
              "name": "本轮去重",
              "description": "seenEpcsThisRun集合过滤重复标签"
            },
            {
              "id": "step_8",
              "order": 8,
              "name": "匹配入库单",
              "description": "findOrderByPlannedRfid查找RFID所属的入库单"
            },
            {
              "id": "step_9",
              "order": 9,
              "name": "蜂鸣反馈",
              "description": "根据beep_mode配置决定raw模式或biz模式蜂鸣"
            },
            {
              "id": "step_10",
              "order": 10,
              "name": "更新EPC滚动列表",
              "description": "将匹配的RFID添加到底部水平滚动列表"
            }
          ]
        },
        {
          "id": "single_barcode_scan_flow",
          "name": "条码单个扫码验收流程",
          "description": "通过顶部条码输入框进行单个耗材验收",
          "code_ref": {
            "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/InboundAcceptanceActivity.java",
            "lines": "449-478"
          },
          "steps": [
            {
              "id": "step_1",
              "order": 1,
              "name": "接收条码输入",
              "description": "监听IME_ACTION_DONE或ENTER键触发"
            },
            {
              "id": "step_2",
              "order": 2,
              "name": "清空输入框",
              "description": "处理后立即清空，准备下次扫码"
            },
            {
              "id": "step_3",
              "order": 3,
              "name": "条码格式校验",
              "description": "使用BarcodeValidator校验前缀和长度"
            },
            {
              "id": "step_4",
              "order": 4,
              "name": "格式化RFID",
              "description": "调用EpcFormatter.normalizeOnReceive转换为18位RFID"
            },
            {
              "id": "step_5",
              "order": 5,
              "name": "匹配入库单",
              "description": "在所有待上架单的plannedRfids中查找"
            },
            {
              "id": "step_6",
              "order": 6,
              "name": "加入增量",
              "description": "匹配成功则调用addDelta累加"
            }
          ]
        },
        {
          "id": "inventory_status_check_flow",
          "name": "库存状态校验流程",
          "description": "入库前批量查询耗材库存状态，确保只有notInStock状态的耗材可以入库",
          "code_ref": {
            "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/InboundAcceptanceActivity.java",
            "lines": "750-858"
          },
          "steps": [
            {
              "id": "step_1",
              "order": 1,
              "name": "收集待查询RFID",
              "description": "pendingRfidToOrder收集300ms内的RFID"
            },
            {
              "id": "step_2",
              "order": 2,
              "name": "批量查询",
              "description": "调用queryConsumableInfoList批量获取状态"
            },
            {
              "id": "step_3",
              "order": 3,
              "name": "状态判定",
              "description": "检查RFID在哪个状态列表中"
            },
            {
              "id": "step_4",
              "order": 4,
              "name": "允许入库",
              "description": "仅notInStock且不在其他列表中的RFID可入库"
            },
            {
              "id": "step_5",
              "order": 5,
              "name": "拒绝并提示",
              "description": "其他状态给出具体错误提示"
            }
          ]
        },
        {
          "id": "submit_acceptance_flow",
          "name": "提交验收流程",
          "description": "选择中心库和SPD仓库后提交入库验收",
          "code_ref": {
            "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/InboundAcceptanceActivity.java",
            "lines": "872-1073"
          },
          "steps": [
            {
              "id": "step_1",
              "order": 1,
              "name": "检查增量",
              "description": "deltaByOrder中该单据的RFID数量必须>0"
            },
            {
              "id": "step_2",
              "order": 2,
              "name": "配置校验",
              "description": "检查sdCode和货柜ID"
            },
            {
              "id": "step_3",
              "order": 3,
              "name": "加载中心库列表",
              "description": "fetchLocations获取type=center且isActive的地点"
            },
            {
              "id": "step_4",
              "order": 4,
              "name": "选择中心库",
              "description": "单个直接使用，多个弹出选择框"
            },
            {
              "id": "step_5",
              "order": 5,
              "name": "保存中心库ID",
              "description": "写入locations_prefs的default_return_location_id"
            },
            {
              "id": "step_6",
              "order": 6,
              "name": "加载SPD仓库列表",
              "description": "fetchSpdRepositories获取SPD仓库"
            },
            {
              "id": "step_7",
              "order": 7,
              "name": "选择SPD仓库",
              "description": "单个直接使用，多个弹出选择框"
            },
            {
              "id": "step_8",
              "order": 8,
              "name": "调用API提交",
              "description": "submitInboundOrder发送POST请求"
            },
            {
              "id": "step_9",
              "order": 9,
              "name": "清理本地状态",
              "description": "清空deltaByOrder，更新或移除已完成单据"
            },
            {
              "id": "step_10",
              "order": 10,
              "name": "刷新列表",
              "description": "重新调用loadPendingOrders"
            }
          ]
        }
      ],
      "rules": [
        {
          "id": "epc_normalize_rule",
          "name": "EPC格式化规则",
          "description": "将扫描到的EPC/条码统一转换为18位十进制RFID",
          "code_ref": {
            "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/InboundAcceptanceActivity.java",
            "lines": "1096-1140"
          },
          "conditions": [
            {
              "condition": "输入已是18位纯数字",
              "result": "直接返回"
            },
            {
              "condition": "输入是20位且以00结尾",
              "result": "截取前18位"
            },
            {
              "condition": "输入是HEX字符串",
              "result": "尝试ASCII解码为18位数字"
            },
            {
              "condition": "以上均不匹配",
              "result": "返回null，过滤该标签"
            }
          ],
          "priority": "medium",
          "constraints": [],
          "effects": []
        },
        {
          "id": "inventory_status_rule",
          "name": "库存状态校验规则",
          "description": "入库验收前的库存状态校验，决定是否允许入库",
          "code_ref": {
            "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/InboundAcceptanceActivity.java",
            "lines": "785-838"
          },
          "conditions": [
            {
              "condition": "在notInStockList且不在其他列表",
              "result": "允许入库",
              "action": "performAddDelta"
            },
            {
              "condition": "在inStockList",
              "result": "拒绝",
              "message": "已在耗材屋库存中，无法重复入库"
            },
            {
              "condition": "在takenList",
              "result": "拒绝",
              "message": "处于取用未归还状态，不能上架入库"
            },
            {
              "condition": "在consumedList",
              "result": "拒绝",
              "message": "已消耗，不能上架入库"
            },
            {
              "condition": "在usedReturnList",
              "result": "拒绝",
              "message": "为消耗退回记录，不走首次有单上架"
            },
            {
              "condition": "未命中任何列表",
              "result": "拒绝",
              "message": "状态未知，暂不处理"
            }
          ],
          "priority": "medium",
          "constraints": [],
          "effects": []
        },
        {
          "id": "order_filter_rule",
          "name": "入库单过滤规则",
          "description": "仅展示未全部上架的单据",
          "code_ref": {
            "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/InboundAcceptanceActivity.java",
            "lines": "287-298"
          },
          "conditions": [
            {
              "condition": "accepted >= total",
              "result": "过滤掉，不显示"
            },
            {
              "condition": "accepted < total",
              "result": "保留，显示在列表中"
            }
          ],
          "priority": "medium",
          "constraints": [],
          "effects": []
        },
        {
          "id": "config_ready_rule",
          "name": "配置完整性校验规则",
          "description": "入库验收前必须配置sdCode和货柜ID",
          "code_ref": {
            "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/InboundAcceptanceActivity.java",
            "lines": "1075-1093"
          },
          "conditions": [
            {
              "condition": "sdCode为空",
              "result": "阻断",
              "message": "请先在设置中配置 sdCode"
            },
            {
              "condition": "cabinetId <= 0",
              "result": "阻断",
              "message": "请先在设置中配置货柜ID"
            },
            {
              "condition": "两者均有效",
              "result": "通过"
            }
          ],
          "priority": "medium",
          "constraints": [],
          "effects": []
        },
        {
          "id": "rfid_match_rule",
          "name": "RFID匹配入库单规则",
          "description": "扫描到的RFID必须在某个待上架单的plannedRfids中才处理",
          "code_ref": {
            "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/InboundAcceptanceActivity.java",
            "lines": "714-720"
          },
          "conditions": [
            {
              "condition": "RFID在某单据的plannedRfids中",
              "result": "返回该单据，继续处理"
            },
            {
              "condition": "RFID不在任何单据的plannedRfids中",
              "result": "返回null，静默过滤"
            }
          ],
          "priority": "medium",
          "constraints": [],
          "effects": []
        },
        {
          "id": "center_location_rule",
          "name": "中心库选择规则",
          "description": "入库验收必须选择type=center的活跃地点",
          "code_ref": {
            "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/InboundAcceptanceActivity.java",
            "lines": "894-943"
          },
          "conditions": [
            {
              "condition": "type != center",
              "result": "过滤掉"
            },
            {
              "condition": "isActive == false",
              "result": "过滤掉"
            },
            {
              "condition": "serverId <= 0",
              "result": "过滤掉"
            },
            {
              "condition": "无可用中心库",
              "result": "报错：未配置中心库地点"
            },
            {
              "condition": "仅一个中心库",
              "result": "直接使用"
            },
            {
              "condition": "多个中心库",
              "result": "弹出选择框"
            }
          ],
          "priority": "medium",
          "constraints": [],
          "effects": []
        },
        {
          "id": "submit_validation_rule",
          "name": "提交验收校验规则",
          "description": "API提交前的参数校验",
          "code_ref": {
            "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/InboundApiService.java",
            "lines": "173-189"
          },
          "conditions": [
            {
              "condition": "order == null",
              "result": "失败：未找到入库单信息"
            },
            {
              "condition": "用户未登录",
              "result": "失败：用户未登录"
            },
            {
              "condition": "sdCode为空",
              "result": "失败：请先在设置中配置sdCode"
            },
            {
              "condition": "cabinetId <= 0",
              "result": "失败：请先在设置中配置货柜ID"
            },
            {
              "condition": "rfids为空",
              "result": "失败：无新增可提交"
            },
            {
              "condition": "spdBindingId <= 0",
              "result": "失败：请选择SPD仓库"
            },
            {
              "condition": "userId为空",
              "result": "失败：用户信息缺少ID"
            }
          ],
          "priority": "medium",
          "constraints": [],
          "effects": []
        }
      ],
      "state_machines": [],
      "pseudocodes": [
        {
          "id": "fetch_pending_orders",
          "name": "拉取待上架入库单",
          "description": "从服务端获取待上架的入库单据列表",
          "code_ref": {
            "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/InboundApiService.java",
            "lines": "59-167"
          },
          "steps": [
            {
              "indent": 0,
              "text": "function fetchPendingOrders(callback):",
              "type": "call"
            },
            {
              "indent": 1,
              "text": "if 用户未登录:",
              "type": "condition"
            },
            {
              "indent": 2,
              "text": "return 失败('用户未登录')",
              "type": "return"
            },
            {
              "indent": 1,
              "text": "if API地址未配置:",
              "type": "condition"
            },
            {
              "indent": 2,
              "text": "return 失败('API服务器地址未配置')",
              "type": "return"
            },
            {
              "indent": 1,
              "text": "",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "response = GET /api/stock/getWarehousingOrder",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "if response.status != 200:",
              "type": "condition"
            },
            {
              "indent": 2,
              "text": "return 失败(response.message)",
              "type": "return"
            },
            {
              "indent": 1,
              "text": "",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "orders = []",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "for each orderJson in response.data:",
              "type": "loop"
            },
            {
              "indent": 2,
              "text": "order = new InboundOrder()",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "order.code = orderJson.orderNo",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "order.total = orderJson.number",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "order.accepted = orderJson.shelfedNumber",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "order.rpNameTo = orderJson.rpNameTo",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "plannedRfids = Set()",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "details = []",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "for each level1 in orderJson.children:",
              "type": "loop"
            },
            {
              "indent": 3,
              "text": "for each item in level1.children:",
              "type": "loop"
            },
            {
              "indent": 4,
              "text": "rfid = EpcFormatter.normalizeOnReceive(item.rfid)",
              "type": "action"
            },
            {
              "indent": 4,
              "text": "detail = new InboundOrderDetail(rfid, item.*)",
              "type": "action"
            },
            {
              "indent": 4,
              "text": "detail.baseMatched = item.isShelfed",
              "type": "action"
            },
            {
              "indent": 4,
              "text": "details.add(detail)",
              "type": "action"
            },
            {
              "indent": 4,
              "text": "if not item.isShelfed:",
              "type": "condition"
            },
            {
              "indent": 5,
              "text": "plannedRfids.add(rfid)",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "order.plannedRfids = plannedRfids",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "order.details = details",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "orders.add(order)",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "return 成功(orders)",
              "type": "return"
            }
          ],
          "calls": []
        },
        {
          "id": "submit_inbound_order",
          "name": "提交有单入库上架",
          "description": "将本次验收的RFID列表提交到服务端",
          "code_ref": {
            "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/InboundApiService.java",
            "lines": "169-292"
          },
          "steps": [
            {
              "indent": 0,
              "text": "function submitInboundOrder(order, rfids, spdBindingId, callback):",
              "type": "call"
            },
            {
              "indent": 1,
              "text": "// 参数校验",
              "type": "comment"
            },
            {
              "indent": 1,
              "text": "if order == null: return 失败('未找到入库单信息')",
              "type": "condition"
            },
            {
              "indent": 1,
              "text": "if 用户未登录: return 失败('用户未登录')",
              "type": "condition"
            },
            {
              "indent": 1,
              "text": "if sdCode为空: return 失败('请先配置sdCode')",
              "type": "condition"
            },
            {
              "indent": 1,
              "text": "if cabinetId <= 0: return 失败('请先配置货柜ID')",
              "type": "condition"
            },
            {
              "indent": 1,
              "text": "if rfids为空: return 失败('无新增可提交')",
              "type": "condition"
            },
            {
              "indent": 1,
              "text": "if spdBindingId <= 0: return 失败('请选择SPD仓库')",
              "type": "condition"
            },
            {
              "indent": 1,
              "text": "",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "// 构建items数组",
              "type": "comment"
            },
            {
              "indent": 1,
              "text": "items = []",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "for each rfid in rfids:",
              "type": "loop"
            },
            {
              "indent": 2,
              "text": "item = {",
              "type": "action"
            },
            {
              "indent": 3,
              "text": "rfid: rfid,",
              "type": "action"
            },
            {
              "indent": 3,
              "text": "cabinetID: cabinetId,",
              "type": "action"
            },
            {
              "indent": 3,
              "text": "orderNo: order.code,",
              "type": "action"
            },
            {
              "indent": 3,
              "text": "quantity: detail.quantity or 1,",
              "type": "action"
            },
            {
              "indent": 3,
              "text": "// 其他字段从detailByRfid获取",
              "type": "comment"
            },
            {
              "indent": 2,
              "text": "}",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "items.add(item)",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "// 构建请求体",
              "type": "comment"
            },
            {
              "indent": 1,
              "text": "body = {",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "userID: currentUser.userId,",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "userName: currentUser.username,",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "sdCode: sdCode,",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "orderNo: order.code,",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "type: 'hasOrder',",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "cabinetID: cabinetId,",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "createDate: now(),",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "items: items,",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "target_location_id: 中心库ID,",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "bindingId: spdBindingId",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "}",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "response = POST /api/stock/hasOrderInbound body",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "if response.status in [200, 0] and response.data有效:",
              "type": "condition"
            },
            {
              "indent": 2,
              "text": "return 成功(true)",
              "type": "return"
            },
            {
              "indent": 1,
              "text": "else:",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "return 失败(response.msg)",
              "type": "return"
            }
          ],
          "calls": []
        },
        {
          "id": "handle_rfid_tag",
          "name": "处理RFID标签",
          "description": "RFID轮询读取到标签后的处理逻辑",
          "code_ref": {
            "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/InboundAcceptanceActivity.java",
            "lines": "634-654"
          },
          "steps": [
            {
              "indent": 0,
              "text": "function handleRfidTag(tag):",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "epcHex = bytesToHexString(tag.EpcId)",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "if epcHex为空: return",
              "type": "condition"
            },
            {
              "indent": 1,
              "text": "",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "if beepModeRaw:",
              "type": "condition"
            },
            {
              "indent": 2,
              "text": "rfidBeepManager.requestBeep()  // 原始蜂鸣",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "rfid18 = EpcFormatter.normalizeOnReceive(epcHex)",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "if rfid18为空: return  // 非合规格式，过滤",
              "type": "condition"
            },
            {
              "indent": 1,
              "text": "",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "if rfid18 in seenEpcsThisRun:",
              "type": "condition"
            },
            {
              "indent": 2,
              "text": "return  // 本轮已处理，去重",
              "type": "return"
            },
            {
              "indent": 1,
              "text": "seenEpcsThisRun.add(rfid18)",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "order = findOrderByPlannedRfid(rfid18)",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "if order == null:",
              "type": "condition"
            },
            {
              "indent": 2,
              "text": "return  // 非待上架RFID，静默过滤",
              "type": "return"
            },
            {
              "indent": 1,
              "text": "",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "addDelta(order, rfid18)  // 加入本次增量",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "if not beepModeRaw:",
              "type": "condition"
            },
            {
              "indent": 2,
              "text": "rfidBeepManager.requestBeep()  // 业务蜂鸣",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "epcAdapter.addEpc(rfid18)  // 更新UI滚动列表",
              "type": "action"
            }
          ],
          "calls": []
        },
        {
          "id": "process_pending_inbound_rfids",
          "name": "批量处理待查询RFID",
          "description": "微批处理机制，收集300ms内的RFID后批量查询库存状态",
          "code_ref": {
            "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/InboundAcceptanceActivity.java",
            "lines": "750-779"
          },
          "steps": [
            {
              "indent": 0,
              "text": "function processPendingInboundRfids():",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "synchronized(pendingRfidToOrder):",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "if pendingRfidToOrder.isEmpty():",
              "type": "condition"
            },
            {
              "indent": 3,
              "text": "return",
              "type": "return"
            },
            {
              "indent": 2,
              "text": "toProcess = copy(pendingRfidToOrder)",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "pendingRfidToOrder.clear()",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "rfidList = toProcess.keys()",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "Log('Batch processing ' + rfidList.size() + ' RFIDs')",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "ConsumableApiService.queryConsumableInfoList(rfidList, {",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "onSuccess: (resp) => {",
              "type": "action"
            },
            {
              "indent": 3,
              "text": "for each (rfid, order) in toProcess:",
              "type": "loop"
            },
            {
              "indent": 4,
              "text": "handleInboundInventoryCheck(order, rfid, resp)",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "},",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "onFailure: (e) => {",
              "type": "action"
            },
            {
              "indent": 3,
              "text": "showError('批量获取耗材库存状态失败')",
              "type": "error"
            },
            {
              "indent": 2,
              "text": "}",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "})",
              "type": "action"
            }
          ],
          "calls": []
        },
        {
          "id": "handle_inbound_inventory_check",
          "name": "入库库存状态校验",
          "description": "根据耗材库存状态决定是否允许入库",
          "code_ref": {
            "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/InboundAcceptanceActivity.java",
            "lines": "785-838"
          },
          "steps": [
            {
              "indent": 0,
              "text": "function handleInboundInventoryCheck(order, rfid, resp):",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "if isFinishing(): return",
              "type": "condition"
            },
            {
              "indent": 1,
              "text": "if order == null or order.code为空: return",
              "type": "condition"
            },
            {
              "indent": 1,
              "text": "",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "// 确保订单仍存在于当前列表",
              "type": "comment"
            },
            {
              "indent": 1,
              "text": "target = orders.find(o => o.code == order.code)",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "if target == null:",
              "type": "condition"
            },
            {
              "indent": 2,
              "text": "showInfo('当前入库单已更新，忽略标签 ' + rfid)",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "return",
              "type": "return"
            },
            {
              "indent": 1,
              "text": "",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "// 判断RFID在哪个状态列表",
              "type": "comment"
            },
            {
              "indent": 1,
              "text": "inNotInStock = resp.notInStockList.contains(rfid)",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "inInStock = resp.inStockList.containsRfid(rfid)",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "inTaken = resp.takenList.containsRfid(rfid)",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "inConsumed = resp.consumedList.containsRfid(rfid)",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "inUsedReturn = resp.usedReturnList.containsRfid(rfid)",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "// 仅notInStock且不在其他列表时允许入库",
              "type": "comment"
            },
            {
              "indent": 1,
              "text": "if inNotInStock and not (inInStock or inTaken or inConsumed or inUsedReturn):",
              "type": "condition"
            },
            {
              "indent": 2,
              "text": "performAddDelta(target, rfid)",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "return",
              "type": "return"
            },
            {
              "indent": 1,
              "text": "",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "// 其他状态给出具体错误提示",
              "type": "comment"
            },
            {
              "indent": 1,
              "text": "if inInStock:",
              "type": "condition"
            },
            {
              "indent": 2,
              "text": "showError('耗材已在库存中，无法重复入库')",
              "type": "error"
            },
            {
              "indent": 1,
              "text": "else if inTaken:",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "showError('耗材处于取用未归还状态')",
              "type": "error"
            },
            {
              "indent": 1,
              "text": "else if inConsumed:",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "showError('耗材已消耗')",
              "type": "error"
            },
            {
              "indent": 1,
              "text": "else if inUsedReturn:",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "showError('耗材为消耗退回记录')",
              "type": "error"
            },
            {
              "indent": 1,
              "text": "else:",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "showError('状态未知，暂不处理')",
              "type": "error"
            }
          ],
          "calls": []
        },
        {
          "id": "add_delta",
          "name": "添加本次验收增量",
          "description": "将RFID加入待处理队列，延迟批量查询",
          "code_ref": {
            "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/InboundAcceptanceActivity.java",
            "lines": "722-745"
          },
          "steps": [
            {
              "indent": 0,
              "text": "function addDelta(order, rfid):",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "// 确保在主线程执行",
              "type": "comment"
            },
            {
              "indent": 1,
              "text": "if not isMainThread():",
              "type": "condition"
            },
            {
              "indent": 2,
              "text": "runOnUiThread(() => addDelta(order, rfid))",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "return",
              "type": "return"
            },
            {
              "indent": 1,
              "text": "",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "if order == null or order.code为空: return",
              "type": "condition"
            },
            {
              "indent": 1,
              "text": "",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "// 检查是否已在本次会话中添加过",
              "type": "comment"
            },
            {
              "indent": 1,
              "text": "existing = deltaByOrder.get(order.code)",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "if existing != null and rfid in existing:",
              "type": "condition"
            },
            {
              "indent": 2,
              "text": "return  // 已添加，跳过",
              "type": "return"
            },
            {
              "indent": 1,
              "text": "",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "// 加入待处理队列",
              "type": "comment"
            },
            {
              "indent": 1,
              "text": "synchronized(pendingRfidToOrder):",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "if rfid not in pendingRfidToOrder:",
              "type": "condition"
            },
            {
              "indent": 3,
              "text": "pendingRfidToOrder.put(rfid, order)",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "// 延迟300ms批量处理",
              "type": "comment"
            },
            {
              "indent": 1,
              "text": "inboundBatchHandler.removeCallbacks(inboundBatchRunnable)",
              "type": "call"
            },
            {
              "indent": 1,
              "text": "inboundBatchHandler.postDelayed(inboundBatchRunnable, 300)",
              "type": "action"
            }
          ],
          "calls": []
        }
      ]
    },
    {
      "id": "inventory",
      "name": "盘点模块",
      "description": "Android PDA 库存盘点功能，支持 RFID 批量扫描、实时统计、差异分析。采用状态机驱动 UI，任务生命周期由 Web 端管理，PDA 仅负责扫描与提交。",
      "code_refs": [
        {
          "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/InventoryActivity.java"
        },
        {
          "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/InventoryDatabase.java"
        },
        {
          "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/inventory/InventorySession.java"
        },
        {
          "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/inventory/InventoryRoomStatus.java"
        },
        {
          "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/inventory/InventoryPlanItem.java"
        }
      ],
      "flows": [
        {
          "id": "inventory_main_flow",
          "name": "盘点主流程",
          "description": "从选择任务到提交盘点数据的完整流程",
          "code_ref": {
            "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/InventoryActivity.java",
            "lines": "163-175, 320-365, 1348-1406"
          },
          "steps": [
            {
              "id": "step_1",
              "order": 1,
              "name": "初始化",
              "description": "onCreate 中初始化视图、数据、事件监听，加载盘点任务列表，设置 UI 状态为 NO_TASK"
            },
            {
              "id": "step_2",
              "order": 2,
              "name": "加载任务列表",
              "description": "调用 fetchInventoryTaskList API 获取当前地点的盘点任务，按创建时间倒序排列"
            },
            {
              "id": "step_3",
              "order": 3,
              "name": "选择任务",
              "description": "用户从侧边栏选择任务，切换前强制停止扫描，清空已提交/待提交缓存，加载任务明细"
            },
            {
              "id": "step_4",
              "order": 4,
              "name": "加载任务明细",
              "description": "调用 fetchInventoryTaskDetail API，重建 InventorySession 和地点汇总"
            },
            {
              "id": "step_5",
              "order": 5,
              "name": "RFID 扫描",
              "description": "用户按物理键启动扫描，读取标签并实时更新统计"
            },
            {
              "id": "step_6",
              "order": 6,
              "name": "提交批次",
              "description": "调用 submitInventoryScanBatch API 提交扫描到的 RFID 列表"
            }
          ]
        },
        {
          "id": "rfid_scan_flow",
          "name": "RFID 扫描流程",
          "description": "物理按键触发的 RFID 扫描启停与标签处理流程",
          "code_ref": {
            "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/InventoryActivity.java",
            "lines": "1076-1148, 1164-1224, 1262-1289, 641-691"
          },
          "steps": [
            {
              "id": "step_1",
              "order": 1,
              "name": "按键触发",
              "description": "KeyReceiver 接收 F1-F4/F7/F8 按键释放事件，调用 toggleRFIDScanning"
            },
            {
              "id": "step_2",
              "order": 2,
              "name": "状态校验",
              "description": "检查 uiState==EXECUTING、currentTask!=null、rawStatus==running"
            },
            {
              "id": "step_3",
              "order": 3,
              "name": "启动扫描",
              "description": "初始化 UHF、设置多标签模式、启动异步读取、创建后台轮询线程"
            },
            {
              "id": "step_4",
              "order": 4,
              "name": "轮询读取",
              "description": "后台线程定时调用 tagInventoryRealTime/tagInventoryByTimer 获取标签"
            },
            {
              "id": "step_5",
              "order": 5,
              "name": "标签处理",
              "description": "handleTagScanned 格式化 EPC、去重、加入待提交批次、更新 Session 和 UI"
            },
            {
              "id": "step_6",
              "order": 6,
              "name": "停止扫描",
              "description": "再次按键或退出时停止轮询、停止硬件读取、可选自动提交批次"
            }
          ]
        },
        {
          "id": "batch_submit_flow",
          "name": "批次提交流程",
          "description": "将扫描到的 RFID 批量提交到后端",
          "code_ref": {
            "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/InventoryActivity.java",
            "lines": "897-967"
          },
          "steps": [
            {
              "id": "step_1",
              "order": 1,
              "name": "前置校验",
              "description": "检查任务状态为 running、非正在提交中"
            },
            {
              "id": "step_2",
              "order": 2,
              "name": "去重过滤",
              "description": "从 pendingBatchRfids 中移除已在 submittedRfids 中的标签"
            },
            {
              "id": "step_3",
              "order": 3,
              "name": "调用 API",
              "description": "调用 submitInventoryScanBatch 提交批次"
            },
            {
              "id": "step_4",
              "order": 4,
              "name": "成功处理",
              "description": "更新任务统计、标记已提交、清理待提交、刷新明细和地点汇总"
            },
            {
              "id": "step_5",
              "order": 5,
              "name": "失败处理",
              "description": "保留 pendingBatchRfids 以便重试"
            }
          ]
        },
        {
          "id": "session_rebuild_flow",
          "name": "会话重建流程",
          "description": "从后端任务明细重建内存态 InventorySession",
          "code_ref": {
            "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/InventoryActivity.java",
            "lines": "411-469"
          },
          "steps": [
            {
              "id": "step_1",
              "order": 1,
              "name": "创建会话",
              "description": "new InventorySession(taskId)"
            },
            {
              "id": "step_2",
              "order": 2,
              "name": "检测快照标志",
              "description": "遍历明细判断是否存在 snapshotStatus 字段，区分新旧版本任务"
            },
            {
              "id": "step_3",
              "order": 3,
              "name": "构建计划列表",
              "description": "筛选 snapshotStatus!=null 的行（新版）或全部行（旧版）作为计划内"
            },
            {
              "id": "step_4",
              "order": 4,
              "name": "加载计划",
              "description": "调用 inventorySession.loadPlan(plan)"
            },
            {
              "id": "step_5",
              "order": 5,
              "name": "写入状态",
              "description": "调用 setStatusFor 记录 snapshotStatus/latestStatus"
            },
            {
              "id": "step_6",
              "order": 6,
              "name": "标记已盘",
              "description": "scanStatus==scanned 的行调用 onTag 标记为已盘"
            },
            {
              "id": "step_7",
              "order": 7,
              "name": "更新 UI",
              "description": "调用 updateRoomGridFromSession 刷新地点卡片"
            }
          ]
        }
      ],
      "rules": [
        {
          "id": "rule_single_active_task",
          "name": "单一执行中任务约束",
          "description": "本地只允许存在一个执行中的盘点任务，确认新任务前需检查",
          "code_ref": {
            "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/InventoryActivity.java",
            "lines": "537-540"
          },
          "condition": "checkoutDb.hasActiveInventoryTask() == true",
          "action": "showError('存在执行中的盘点任务，请先结束或作废')",
          "priority": "medium",
          "constraints": [
            "checkoutDb.hasActiveInventoryTask() == true"
          ],
          "effects": [
            "showError('存在执行中的盘点任务，请先结束或作废')"
          ]
        },
        {
          "id": "rule_scan_state_check",
          "name": "扫描状态校验",
          "description": "只有在 EXECUTING 状态且任务为 running 时才允许扫描",
          "code_ref": {
            "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/InventoryActivity.java",
            "lines": "642-644, 1263-1270"
          },
          "condition": "uiState != EXECUTING || currentTask == null || rawStatus != 'running'",
          "action": "拒绝处理标签或显示错误提示",
          "priority": "medium",
          "constraints": [
            "uiState != EXECUTING || currentTask == null || rawStatus != 'running'"
          ],
          "effects": [
            "拒绝处理标签或显示错误提示"
          ]
        },
        {
          "id": "rule_tag_dedup_session",
          "name": "标签去重（会话级）",
          "description": "同一扫描轮次内已见过的 EPC 不重复处理",
          "code_ref": {
            "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/InventoryActivity.java",
            "lines": "652-656"
          },
          "condition": "seenEpcsThisRun.contains(epc)",
          "action": "return（跳过处理）",
          "priority": "medium",
          "constraints": [
            "seenEpcsThisRun.contains(epc)"
          ],
          "effects": [
            "return（跳过处理）"
          ]
        },
        {
          "id": "rule_tag_dedup_submit",
          "name": "标签去重（提交级）",
          "description": "已成功提交的标签不再加入待提交批次",
          "code_ref": {
            "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/InventoryActivity.java",
            "lines": "658-661, 912-919"
          },
          "condition": "submittedRfids.contains(epc)",
          "action": "不加入 pendingBatchRfids",
          "priority": "medium",
          "constraints": [
            "submittedRfids.contains(epc)"
          ],
          "effects": [
            "不加入 pendingBatchRfids"
          ]
        },
        {
          "id": "rule_submit_lock",
          "name": "提交互斥锁",
          "description": "防止并发提交，上一批提交完成前不允许新提交",
          "code_ref": {
            "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/InventoryActivity.java",
            "lines": "904-909"
          },
          "condition": "isSubmittingBatch == true",
          "action": "showInfo('上一批盘点数据正在提交，请稍候')",
          "priority": "medium",
          "constraints": [
            "isSubmittingBatch == true"
          ],
          "effects": [
            "showInfo('上一批盘点数据正在提交，请稍候')"
          ]
        },
        {
          "id": "rule_stop_scan_on_task_switch",
          "name": "切换任务前停止扫描",
          "description": "选择新任务前强制停止当前扫描，避免跨任务写入",
          "code_ref": {
            "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/InventoryActivity.java",
            "lines": "1349-1352"
          },
          "condition": "isRFIDActive == true",
          "action": "stopRFIDScanning()",
          "priority": "medium",
          "constraints": [
            "isRFIDActive == true"
          ],
          "effects": [
            "stopRFIDScanning()"
          ]
        },
        {
          "id": "rule_rfid_empty_read_recovery",
          "name": "空读自恢复",
          "description": "连续 4 轮空读后重启异步读取，提升稳定性",
          "code_ref": {
            "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/InventoryActivity.java",
            "lines": "1198-1210"
          },
          "condition": "emptyReadRounds >= 4",
          "action": "asyncStopReading -> sleep(30) -> asyncStartReading",
          "priority": "medium",
          "constraints": [
            "emptyReadRounds >= 4"
          ],
          "effects": [
            "asyncStopReading -> sleep(30) -> asyncStartReading"
          ]
        },
        {
          "id": "rule_poll_backoff",
          "name": "轮询退避策略",
          "description": "连续空读时逐步增加轮询间隔（200ms -> 800ms），读到标签时恢复最小间隔",
          "code_ref": {
            "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/InventoryActivity.java",
            "lines": "131-133, 1183-1196"
          },
          "condition": "tagList 为空",
          "action": "currentPollInterval = min(currentPollInterval * 2, 800)",
          "priority": "medium",
          "constraints": [
            "tagList 为空"
          ],
          "effects": [
            "currentPollInterval = min(currentPollInterval * 2, 800)"
          ]
        },
        {
          "id": "rule_session_tag_classification",
          "name": "标签分类规则",
          "description": "扫描到的标签根据是否在计划集中分为已盘（计划内）或盈余",
          "code_ref": {
            "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/inventory/InventorySession.java",
            "lines": "121-142"
          },
          "condition": "canonical != null && allPlanned.contains(canonical)",
          "action": "加入 countedByRoom 和 countedAll；否则加入 surplus",
          "priority": "medium",
          "constraints": [
            "canonical != null && allPlanned.contains(canonical)"
          ],
          "effects": [
            "加入 countedByRoom 和 countedAll；否则加入 surplus"
          ]
        }
      ],
      "state_machines": [
        {
          "id": "task_ui_state_machine",
          "name": "任务 UI 状态机",
          "description": "控制盘点界面四个视图的显示切换",
          "code_ref": {
            "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/InventoryActivity.java",
            "lines": "56-57, 309-318"
          },
          "states": [
            {
              "id": "NO_TASK",
              "name": "无任务",
              "description": "显示 viewNoTask，隐藏任务头和统计栏"
            },
            {
              "id": "PENDING",
              "name": "待确认",
              "description": "显示 viewPending，用于本地创建任务后拉取库存预览（当前流程已弃用）"
            },
            {
              "id": "EXECUTING",
              "name": "执行中",
              "description": "显示 viewExecuting，展示地点卡片网格，允许 RFID 扫描"
            },
            {
              "id": "FINISHED",
              "name": "已完成",
              "description": "显示 viewFinished，展示差异明细（缺失/盈余）"
            }
          ],
          "transitions": [
            {
              "from": "NO_TASK",
              "to": "PENDING",
              "trigger": "createNewInventoryTask()",
              "description": "本地新建任务（当前流程已改为从侧边栏选择）"
            },
            {
              "from": "NO_TASK",
              "to": "EXECUTING",
              "trigger": "selectInventoryTask(task)",
              "description": "从侧边栏选择已有任务"
            },
            {
              "from": "PENDING",
              "to": "EXECUTING",
              "trigger": "confirmCurrentTask()",
              "description": "确认本地任务进入执行"
            },
            {
              "from": "EXECUTING",
              "to": "FINISHED",
              "trigger": "任务状态变为 closed/review",
              "description": "任务完成后展示差异"
            },
            {
              "from": "EXECUTING",
              "to": "NO_TASK",
              "trigger": "onBackPressed() 或任务作废",
              "description": "退出当前任务"
            }
          ],
          "entity": "任务 UI 状态机",
          "field": "status"
        },
        {
          "id": "rfid_scan_state_machine",
          "name": "RFID 扫描状态机",
          "description": "控制 RFID 硬件的启停状态",
          "code_ref": {
            "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/InventoryActivity.java",
            "lines": "124, 1076-1148, 1262-1289"
          },
          "states": [
            {
              "id": "IDLE",
              "name": "空闲",
              "description": "isRFIDActive=false，硬件未读取"
            },
            {
              "id": "SCANNING",
              "name": "扫描中",
              "description": "isRFIDActive=true，后台轮询读取标签"
            }
          ],
          "transitions": [
            {
              "from": "IDLE",
              "to": "SCANNING",
              "trigger": "物理按键(F1-F4/F7/F8) 且 uiState==EXECUTING && rawStatus==running",
              "description": "启动扫描"
            },
            {
              "from": "SCANNING",
              "to": "IDLE",
              "trigger": "物理按键 或 endInventory() 或 onPause() 或 onBackPressed()",
              "description": "停止扫描"
            }
          ],
          "entity": "RFID 扫描状态机",
          "field": "status"
        }
      ],
      "pseudocodes": [
        {
          "id": "pseudo_handle_tag_scanned",
          "name": "handleTagScanned 标签处理",
          "description": "处理单个 RFID 标签的核心逻辑",
          "code_ref": {
            "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/InventoryActivity.java",
            "lines": "641-691"
          },
          "steps": [
            {
              "indent": 0,
              "text": "FUNCTION handleTagScanned(tag):",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "IF uiState != EXECUTING OR currentTask == null OR rawStatus != 'running':",
              "type": "condition"
            },
            {
              "indent": 2,
              "text": "RETURN",
              "type": "return"
            },
            {
              "indent": 1,
              "text": "",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "epcRawHex = bytesToHexString(tag.EpcId)",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "epc = EpcFormatter.normalizeOnReceive(epcRawHex)",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "IF epc is empty:",
              "type": "condition"
            },
            {
              "indent": 2,
              "text": "RETURN",
              "type": "return"
            },
            {
              "indent": 1,
              "text": "",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "// 本轮去重",
              "type": "comment"
            },
            {
              "indent": 1,
              "text": "IF epc IN seenEpcsThisRun:",
              "type": "condition"
            },
            {
              "indent": 2,
              "text": "RETURN",
              "type": "return"
            },
            {
              "indent": 1,
              "text": "seenEpcsThisRun.add(epc)",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "// 提交级去重",
              "type": "comment"
            },
            {
              "indent": 1,
              "text": "isNewTag = false",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "IF epc NOT IN submittedRfids:",
              "type": "condition"
            },
            {
              "indent": 2,
              "text": "pendingBatchRfids.add(epc)",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "isNewTag = true",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "// 蜂鸣反馈（业务增量模式）",
              "type": "comment"
            },
            {
              "indent": 1,
              "text": "IF NOT beepModeRaw:",
              "type": "condition"
            },
            {
              "indent": 2,
              "text": "rfidBeepManager.requestBeep()",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "// 更新本地会话并刷新 UI",
              "type": "comment"
            },
            {
              "indent": 1,
              "text": "IF isNewTag AND inventorySession != null:",
              "type": "condition"
            },
            {
              "indent": 2,
              "text": "inventorySession.onTag(epc)",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "POST TO UI_THREAD:",
              "type": "action"
            },
            {
              "indent": 3,
              "text": "更新表头统计",
              "type": "action"
            },
            {
              "indent": 3,
              "text": "updateRoomGridFromSession()",
              "type": "action"
            }
          ],
          "calls": []
        },
        {
          "id": "pseudo_session_on_tag",
          "name": "InventorySession.onTag 标签入账",
          "description": "将扫描到的标签分类为已盘或盈余",
          "code_ref": {
            "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/inventory/InventorySession.java",
            "lines": "121-142"
          },
          "steps": [
            {
              "indent": 0,
              "text": "FUNCTION onTag(rawRfid):",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "raw = safeRfid(rawRfid)",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "IF raw is empty:",
              "type": "condition"
            },
            {
              "indent": 2,
              "text": "RETURN false",
              "type": "return"
            },
            {
              "indent": 1,
              "text": "",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "// 简单去重",
              "type": "comment"
            },
            {
              "indent": 1,
              "text": "IF raw IN seen:",
              "type": "condition"
            },
            {
              "indent": 2,
              "text": "RETURN false",
              "type": "return"
            },
            {
              "indent": 1,
              "text": "seen.add(raw)",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "canonical = canonicalize(raw)",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "IF canonical != null AND canonical IN allPlanned:",
              "type": "condition"
            },
            {
              "indent": 2,
              "text": "// 计划内标签：找到所属地点并标记已盘",
              "type": "comment"
            },
            {
              "indent": 2,
              "text": "FOR EACH (roomId, plannedSet) IN plannedByRoom:",
              "type": "loop"
            },
            {
              "indent": 3,
              "text": "IF canonical IN plannedSet:",
              "type": "condition"
            },
            {
              "indent": 4,
              "text": "countedByRoom[roomId].add(canonical)",
              "type": "action"
            },
            {
              "indent": 4,
              "text": "countedAll.add(canonical)",
              "type": "action"
            },
            {
              "indent": 4,
              "text": "BREAK",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "ELSE:",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "// 盈余标签",
              "type": "comment"
            },
            {
              "indent": 2,
              "text": "surplus.add(raw)",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "RETURN true",
              "type": "return"
            }
          ],
          "calls": []
        },
        {
          "id": "pseudo_submit_batch",
          "name": "submitCurrentBatch 批次提交",
          "description": "将待提交的 RFID 批量上传到后端",
          "code_ref": {
            "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/InventoryActivity.java",
            "lines": "897-967"
          },
          "steps": [
            {
              "indent": 0,
              "text": "FUNCTION submitCurrentBatch(forceToastOnEmpty):",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "// 前置校验",
              "type": "comment"
            },
            {
              "indent": 1,
              "text": "IF currentTask == null OR rawStatus != 'running':",
              "type": "condition"
            },
            {
              "indent": 2,
              "text": "IF forceToastOnEmpty: showInfo('当前任务状态不允许提交')",
              "type": "condition"
            },
            {
              "indent": 2,
              "text": "RETURN",
              "type": "return"
            },
            {
              "indent": 1,
              "text": "IF isSubmittingBatch:",
              "type": "condition"
            },
            {
              "indent": 2,
              "text": "IF forceToastOnEmpty: showInfo('上一批正在提交')",
              "type": "condition"
            },
            {
              "indent": 2,
              "text": "RETURN",
              "type": "return"
            },
            {
              "indent": 1,
              "text": "",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "// 构建去重批次",
              "type": "comment"
            },
            {
              "indent": 1,
              "text": "batch = []",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "FOR EACH code IN pendingBatchRfids:",
              "type": "loop"
            },
            {
              "indent": 2,
              "text": "IF code NOT IN submittedRfids:",
              "type": "condition"
            },
            {
              "indent": 3,
              "text": "batch.add(code)",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "IF batch is empty:",
              "type": "condition"
            },
            {
              "indent": 2,
              "text": "IF forceToastOnEmpty: showInfo('无新标签需要提交')",
              "type": "condition"
            },
            {
              "indent": 2,
              "text": "RETURN",
              "type": "return"
            },
            {
              "indent": 1,
              "text": "",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "isSubmittingBatch = true",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "showInfo('正在提交...')",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "CALL API submitInventoryScanBatch(taskId, batch):",
              "type": "call"
            },
            {
              "indent": 2,
              "text": "ON SUCCESS(result):",
              "type": "action"
            },
            {
              "indent": 3,
              "text": "更新 currentTask 统计字段",
              "type": "action"
            },
            {
              "indent": 3,
              "text": "submittedRfids.addAll(batch)",
              "type": "action"
            },
            {
              "indent": 3,
              "text": "pendingBatchRfids.removeAll(batch)",
              "type": "action"
            },
            {
              "indent": 3,
              "text": "updateHeaderStats()",
              "type": "action"
            },
            {
              "indent": 3,
              "text": "reloadTaskDetailAndSession(false)",
              "type": "action"
            },
            {
              "indent": 3,
              "text": "showSuccess('提交成功')",
              "type": "action"
            },
            {
              "indent": 3,
              "text": "isSubmittingBatch = false",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "ON FAILURE(e):",
              "type": "action"
            },
            {
              "indent": 3,
              "text": "showError('提交失败')",
              "type": "error"
            },
            {
              "indent": 3,
              "text": "// 保留 pendingBatchRfids 以便重试",
              "type": "comment"
            },
            {
              "indent": 3,
              "text": "isSubmittingBatch = false",
              "type": "action"
            }
          ],
          "calls": []
        },
        {
          "id": "pseudo_rebuild_session",
          "name": "rebuildSessionFromDetail 会话重建",
          "description": "从后端任务明细重建内存态会话",
          "code_ref": {
            "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/InventoryActivity.java",
            "lines": "411-469"
          },
          "steps": [
            {
              "indent": 0,
              "text": "FUNCTION rebuildSessionFromDetail(taskId, detail):",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "inventorySession = new InventorySession(taskId)",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "IF detail is null OR detail.items is empty:",
              "type": "condition"
            },
            {
              "indent": 2,
              "text": "清空地点网格",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "RETURN",
              "type": "return"
            },
            {
              "indent": 1,
              "text": "",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "// 检测是否有快照标志（区分新旧版本任务）",
              "type": "comment"
            },
            {
              "indent": 1,
              "text": "hasSnapshotFlag = false",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "FOR EACH item IN detail.items:",
              "type": "loop"
            },
            {
              "indent": 2,
              "text": "IF item.snapshotStatus is not empty:",
              "type": "condition"
            },
            {
              "indent": 3,
              "text": "hasSnapshotFlag = true",
              "type": "action"
            },
            {
              "indent": 3,
              "text": "BREAK",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "// 构建计划列表",
              "type": "comment"
            },
            {
              "indent": 1,
              "text": "plan = []",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "FOR EACH item IN detail.items:",
              "type": "loop"
            },
            {
              "indent": 2,
              "text": "// 新版：仅 snapshotStatus!=null 的为计划内",
              "type": "comment"
            },
            {
              "indent": 2,
              "text": "// 旧版：所有行都视为计划内",
              "type": "comment"
            },
            {
              "indent": 2,
              "text": "IF hasSnapshotFlag AND item.snapshotStatus is null:",
              "type": "condition"
            },
            {
              "indent": 3,
              "text": "CONTINUE",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "IF item.rfid is empty:",
              "type": "condition"
            },
            {
              "indent": 3,
              "text": "CONTINUE",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "plan.add(new InventoryPlanItem(...))",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "inventorySession.loadPlan(plan)",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "// 写入状态快照并标记已盘",
              "type": "comment"
            },
            {
              "indent": 1,
              "text": "FOR EACH item IN detail.items:",
              "type": "loop"
            },
            {
              "indent": 2,
              "text": "IF hasSnapshotFlag AND item.snapshotStatus is null:",
              "type": "condition"
            },
            {
              "indent": 3,
              "text": "CONTINUE",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "inventorySession.setStatusFor(rfid, snapshotStatus, latestStatus)",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "IF item.scanStatus == 'scanned':",
              "type": "condition"
            },
            {
              "indent": 3,
              "text": "inventorySession.onTag(rfid)",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "updateRoomGridFromSession()",
              "type": "action"
            }
          ],
          "calls": []
        },
        {
          "id": "pseudo_rfid_polling",
          "name": "RFID 轮询读取",
          "description": "后台线程轮询读取 RFID 标签的核心逻辑",
          "code_ref": {
            "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/InventoryActivity.java",
            "lines": "1164-1220"
          },
          "steps": [
            {
              "indent": 0,
              "text": "FUNCTION rfidRunnable.run():",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "IF NOT isRFIDActive OR uhfManager not initialized:",
              "type": "condition"
            },
            {
              "indent": 2,
              "text": "RETURN",
              "type": "return"
            },
            {
              "indent": 1,
              "text": "",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "TRY:",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "// 先尝试实时读取",
              "type": "comment"
            },
            {
              "indent": 2,
              "text": "tagList = uhfManager.tagInventoryRealTime()",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "// 若为空，回退到定时读取",
              "type": "comment"
            },
            {
              "indent": 2,
              "text": "IF tagList is empty:",
              "type": "condition"
            },
            {
              "indent": 3,
              "text": "tagList = uhfManager.tagInventoryByTimer(50ms)",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "IF tagList is not empty:",
              "type": "condition"
            },
            {
              "indent": 3,
              "text": "emptyReadRounds = 0",
              "type": "action"
            },
            {
              "indent": 3,
              "text": "currentPollInterval = MIN_INTERVAL (200ms)",
              "type": "action"
            },
            {
              "indent": 3,
              "text": "FOR EACH tag IN tagList:",
              "type": "loop"
            },
            {
              "indent": 4,
              "text": "IF beepModeRaw: rfidBeepManager.requestBeep()",
              "type": "condition"
            },
            {
              "indent": 4,
              "text": "handleTagScanned(tag)",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "ELSE:",
              "type": "action"
            },
            {
              "indent": 3,
              "text": "// 退避策略",
              "type": "comment"
            },
            {
              "indent": 3,
              "text": "emptyReadRounds++",
              "type": "action"
            },
            {
              "indent": 3,
              "text": "currentPollInterval = min(currentPollInterval * 2, MAX_INTERVAL)",
              "type": "action"
            },
            {
              "indent": 3,
              "text": "",
              "type": "action"
            },
            {
              "indent": 3,
              "text": "// 空读自恢复",
              "type": "comment"
            },
            {
              "indent": 3,
              "text": "IF emptyReadRounds >= 4:",
              "type": "condition"
            },
            {
              "indent": 4,
              "text": "uhfManager.asyncStopReading()",
              "type": "action"
            },
            {
              "indent": 4,
              "text": "sleep(30ms)",
              "type": "action"
            },
            {
              "indent": 4,
              "text": "uhfManager.asyncStartReading()",
              "type": "action"
            },
            {
              "indent": 4,
              "text": "emptyReadRounds = 0",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "CATCH Exception:",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "Log error",
              "type": "error"
            },
            {
              "indent": 1,
              "text": "",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "// 调度下一轮",
              "type": "comment"
            },
            {
              "indent": 1,
              "text": "IF isRFIDActive:",
              "type": "condition"
            },
            {
              "indent": 2,
              "text": "rfidBgHandler.postDelayed(this, currentPollInterval)",
              "type": "action"
            }
          ],
          "calls": []
        }
      ]
    },
    {
      "id": "rfid",
      "name": "RFID硬件管理模块",
      "description": "封装UHF RFID读卡器的初始化、参数配置、标签读取、EPC编解码及音频反馈功能，提供统一的硬件抽象层",
      "code_refs": [
        {
          "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/rfid/UHFManager.java"
        },
        {
          "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/rfid/EpcFormatter.java"
        },
        {
          "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/rfid/RfidBeepManager.java"
        }
      ],
      "flows": [
        {
          "id": "rfid_init_flow",
          "name": "RFID模块初始化流程",
          "description": "初始化UHF RFID模块，包括获取实例、设置功率（带降级）、设置频段和其他参数",
          "code_ref": {
            "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/rfid/UHFManager.java",
            "lines": "49-80,93-136"
          },
          "steps": [
            {
              "id": "step_1",
              "order": 1,
              "name": "获取UHFRManager单例实例"
            },
            {
              "id": "step_2",
              "order": 2,
              "name": "尝试设置用户配置的功率值"
            },
            {
              "id": "step_3",
              "order": 3,
              "name": "功率设置成功则设置频段"
            },
            {
              "id": "step_4",
              "order": 4,
              "name": "降级到30dBm重试"
            },
            {
              "id": "step_5",
              "order": 5,
              "name": "设置Session/Target/Q值/FastID参数"
            },
            {
              "id": "step_6",
              "order": 6,
              "name": "标记isInitialized=true"
            }
          ],
          "error_handling": "任何步骤异常则返回false，不改变isInitialized状态"
        },
        {
          "id": "rfid_high_perf_read_flow",
          "name": "高性能读取模式启动流程",
          "description": "启动高性能RFID读取，先强制停止所有操作，等待资源释放，再设置高性能参数",
          "code_ref": {
            "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/rfid/UHFManager.java",
            "lines": "273-311"
          },
          "steps": [
            {
              "id": "step_1",
              "order": 1,
              "name": "检查isInitialized状态"
            },
            {
              "id": "step_2",
              "order": 2,
              "name": "检查isReading状态，防止重复启动"
            },
            {
              "id": "step_3",
              "order": 3,
              "name": "调用forceStopAllOperations强制停止"
            },
            {
              "id": "step_4",
              "order": 4,
              "name": "等待100ms确保资源释放"
            },
            {
              "id": "step_5",
              "order": 5,
              "name": "设置Session/Target/Q值/FastID参数"
            },
            {
              "id": "step_6",
              "order": 6,
              "name": "标记isReading=true"
            }
          ],
          "error_handling": "异常时返回false，不改变isReading状态"
        },
        {
          "id": "rfid_stop_flow",
          "name": "RFID停止读取流程",
          "description": "停止所有RFID读取操作，包括异步读取和定时盘存",
          "code_ref": {
            "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/rfid/UHFManager.java",
            "lines": "441-463,516-542"
          },
          "steps": [
            {
              "id": "step_1",
              "order": 1,
              "name": "检查isReading状态"
            },
            {
              "id": "step_2",
              "order": 2,
              "name": "调用asyncStopReading停止异步读取"
            },
            {
              "id": "step_3",
              "order": 3,
              "name": "调用stopTagInventory停止定时盘存"
            },
            {
              "id": "step_4",
              "order": 4,
              "name": "重置isReading=false"
            },
            {
              "id": "step_5",
              "order": 5,
              "name": "等待100ms确保停止完成"
            }
          ],
          "error_handling": "各步骤独立try-catch，确保尽可能停止所有操作"
        },
        {
          "id": "rfid_close_flow",
          "name": "RFID模块关闭流程",
          "description": "完全关闭UHF模块，释放资源",
          "code_ref": {
            "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/rfid/UHFManager.java",
            "lines": "555-581"
          },
          "steps": [
            {
              "id": "step_1",
              "order": 1,
              "name": "如果isReading则先调用stopReading"
            },
            {
              "id": "step_2",
              "order": 2,
              "name": "调用uhfReader.close()"
            },
            {
              "id": "step_3",
              "order": 3,
              "name": "置空uhfReader引用"
            },
            {
              "id": "step_4",
              "order": 4,
              "name": "重置isInitialized=false和isReading=false"
            }
          ],
          "error_handling": "异常时仍尝试清理状态"
        }
      ],
      "rules": [
        {
          "id": "epc_rule_prefix_000000",
          "name": "EPC前缀000000规则",
          "description": "以'000000'开头且总长24的字符串，取后18位作为标准EPC值",
          "code_ref": {
            "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/rfid/EpcFormatter.java",
            "lines": "28-29"
          },
          "condition": "input.length() == 24 && input.startsWith(\"000000\")",
          "action": "return input.substring(6)",
          "example": {
            "input": "000000ABCDEF123456789012",
            "output": "ABCDEF123456789012"
          },
          "priority": "medium",
          "constraints": [
            "input.length() == 24 && input.startsWith(\"000000\")"
          ],
          "effects": [
            "return input.substring(6)"
          ]
        },
        {
          "id": "epc_rule_suffix_00",
          "name": "EPC后缀00规则",
          "description": "以'00'结尾且总长20的字符串，取前18位作为标准EPC值",
          "code_ref": {
            "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/rfid/EpcFormatter.java",
            "lines": "31-32"
          },
          "condition": "input.length() == 20 && input.endsWith(\"00\")",
          "action": "return input.substring(0, 18)",
          "example": {
            "input": "ABCDEF12345678901200",
            "output": "ABCDEF123456789012"
          },
          "priority": "medium",
          "constraints": [
            "input.length() == 20 && input.endsWith(\"00\")"
          ],
          "effects": [
            "return input.substring(0, 18)"
          ]
        },
        {
          "id": "epc_rule_hex_form_a",
          "name": "EPC HEX形态A规则",
          "description": "HEX以'000000'开头且总长42，取后36位按ASCII解码为18字符",
          "code_ref": {
            "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/rfid/EpcFormatter.java",
            "lines": "37-44"
          },
          "condition": "isHexLike(s) && s.length() == 42 && s.startsWith(\"000000\")",
          "action": "取后36位HEX，按ASCII解码，若结果为18字符则返回",
          "example": {
            "input": "000000414243444546313233343536373839303132",
            "output": "ABCDEF123456789012"
          },
          "priority": "medium",
          "constraints": [
            "isHexLike(s) && s.length() == 42 && s.startsWith(\"000000\")"
          ],
          "effects": [
            "取后36位HEX，按ASCII解码，若结果为18字符则返回"
          ]
        },
        {
          "id": "epc_rule_hex_form_b",
          "name": "EPC HEX形态B规则",
          "description": "HEX总长40，ASCII解码后长度20且以'00'结尾，取前18字符",
          "code_ref": {
            "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/rfid/EpcFormatter.java",
            "lines": "45-51"
          },
          "condition": "isHexLike(s) && s.length() == 40 && decode后length==20 && endsWith(\"00\")",
          "action": "ASCII解码后取前18字符",
          "example": {
            "input": "41424344454631323334353637383930313230300",
            "output": "ABCDEF123456789012"
          },
          "priority": "medium",
          "constraints": [
            "isHexLike(s) && s.length() == 40 && decode后length==20 && endsWith(\"00\")"
          ],
          "effects": [
            "ASCII解码后取前18字符"
          ]
        },
        {
          "id": "epc_rule_passthrough",
          "name": "EPC透传规则",
          "description": "未匹配任何规则时，返回原值（仅trim）",
          "code_ref": {
            "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/rfid/EpcFormatter.java",
            "lines": "54-55"
          },
          "condition": "不满足以上任何规则",
          "action": "return input.trim()",
          "priority": "medium",
          "constraints": [
            "不满足以上任何规则"
          ],
          "effects": [
            "return input.trim()"
          ]
        },
        {
          "id": "power_fallback_rule",
          "name": "功率降级规则",
          "description": "设置功率失败时自动降级到30dBm",
          "code_ref": {
            "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/rfid/UHFManager.java",
            "lines": "112-130,216-226"
          },
          "condition": "setPower返回值 != MT_OK_ERR",
          "action": "降级调用setPower(30, 30)",
          "priority": "medium",
          "constraints": [
            "setPower返回值 != MT_OK_ERR"
          ],
          "effects": [
            "降级调用setPower(30, 30)"
          ]
        },
        {
          "id": "beep_throttle_rule",
          "name": "蜂鸣限流规则",
          "description": "蜂鸣请求需满足最小间隔才发声，多标签模式40ms，单标签模式120ms",
          "code_ref": {
            "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/rfid/RfidBeepManager.java",
            "lines": "56-70"
          },
          "condition": "now - lastBeepAt >= gap",
          "action": "发声并更新lastBeepAt",
          "parameters": {
            "multi_mode_gap_ms": 40,
            "single_mode_gap_ms": 120,
            "multi_mode_duration_ms": 60,
            "single_mode_duration_ms": 120
          },
          "priority": "medium",
          "constraints": [
            "now - lastBeepAt >= gap"
          ],
          "effects": [
            "发声并更新lastBeepAt"
          ]
        },
        {
          "id": "region_mapping_rule",
          "name": "频段映射规则",
          "description": "将业务频段代码映射到硬件Region_Conf枚举",
          "code_ref": {
            "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/rfid/UHFManager.java",
            "lines": "600-609"
          },
          "mapping": {
            "1": {
              "name": "中国",
              "freq": "920-925MHz",
              "hardware_value": 2
            },
            "2": {
              "name": "美国",
              "freq": "902-928MHz",
              "hardware_value": 1
            },
            "3": {
              "name": "欧洲",
              "freq": "865-868MHz",
              "hardware_value": 2
            },
            "default": {
              "hardware_value": 1
            }
          },
          "priority": "medium",
          "constraints": [],
          "effects": []
        },
        {
          "id": "session_mode_rule",
          "name": "Session模式规则",
          "description": "布尔值转Session参数：多标签模式=3，单标签模式=0",
          "code_ref": {
            "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/rfid/UHFManager.java",
            "lines": "746-761"
          },
          "mapping": {
            "true": 3,
            "false": 0
          },
          "priority": "medium",
          "constraints": [],
          "effects": []
        }
      ],
      "state_machines": [
        {
          "id": "uhf_manager_state",
          "name": "UHFManager状态机",
          "description": "管理RFID模块的初始化和读取状态",
          "code_ref": {
            "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/rfid/UHFManager.java",
            "lines": "24-25"
          },
          "states": [
            {
              "id": "uninitialized",
              "name": "uninitialized",
              "description": "未初始化状态，isInitialized=false"
            },
            {
              "id": "initialized_idle",
              "name": "initialized_idle",
              "description": "已初始化但未读取，isInitialized=true, isReading=false"
            },
            {
              "id": "reading",
              "name": "reading",
              "description": "正在读取，isInitialized=true, isReading=true"
            }
          ],
          "transitions": [
            {
              "from": "uninitialized",
              "to": "initialized_idle",
              "trigger": "initialize()成功"
            },
            {
              "from": "initialized_idle",
              "to": "reading",
              "trigger": "startHighPerformanceReading()/startNormalReading()/asyncStartReading()成功"
            },
            {
              "from": "reading",
              "to": "initialized_idle",
              "trigger": "stopReading()/asyncStopReading()成功"
            },
            {
              "from": "initialized_idle",
              "to": "uninitialized",
              "trigger": "close()"
            },
            {
              "from": "reading",
              "to": "uninitialized",
              "trigger": "close()"
            }
          ],
          "guards": {
            "initialize": "uhfReader实例获取成功且功率设置成功（原值或降级）",
            "startReading": "isInitialized==true && isReading==false",
            "stopReading": "isReading==true"
          },
          "entity": "UHFManager状态机",
          "field": "status"
        },
        {
          "id": "beep_manager_state",
          "name": "RfidBeepManager状态机",
          "description": "管理蜂鸣器的激活状态",
          "code_ref": {
            "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/rfid/RfidBeepManager.java",
            "lines": "25-28"
          },
          "states": [
            {
              "id": "inactive",
              "name": "inactive",
              "description": "未激活，active=false"
            },
            {
              "id": "active",
              "name": "active",
              "description": "已激活，active=true"
            }
          ],
          "transitions": [
            {
              "from": "inactive",
              "to": "active",
              "trigger": "start()"
            },
            {
              "from": "active",
              "to": "inactive",
              "trigger": "stop()"
            },
            {
              "from": "active",
              "to": "inactive",
              "trigger": "release()"
            }
          ],
          "entity": "RfidBeepManager状态机",
          "field": "status"
        }
      ],
      "pseudocodes": [
        {
          "id": "epc_normalize_pseudocode",
          "name": "EPC标准化伪代码",
          "description": "将各种格式的EPC值标准化为18位标准值",
          "code_ref": {
            "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/rfid/EpcFormatter.java",
            "lines": "22-56"
          },
          "steps": [
            {
              "indent": 0,
              "text": "FUNCTION normalizeOnReceive(input):",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "IF input IS NULL THEN RETURN NULL",
              "type": "condition"
            },
            {
              "indent": 1,
              "text": "s = TRIM(input)",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "IF s IS EMPTY THEN RETURN s",
              "type": "condition"
            },
            {
              "indent": 0,
              "text": "",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "// 规则1: 前缀000000，长度24",
              "type": "comment"
            },
            {
              "indent": 1,
              "text": "IF LENGTH(s) == 24 AND STARTS_WITH(s, '000000') THEN",
              "type": "condition"
            },
            {
              "indent": 2,
              "text": "RETURN SUBSTRING(s, 6)  // 取后18位",
              "type": "return"
            },
            {
              "indent": 0,
              "text": "",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "// 规则2: 后缀00，长度20",
              "type": "comment"
            },
            {
              "indent": 1,
              "text": "IF LENGTH(s) == 20 AND ENDS_WITH(s, '00') THEN",
              "type": "condition"
            },
            {
              "indent": 2,
              "text": "RETURN SUBSTRING(s, 0, 18)  // 取前18位",
              "type": "return"
            },
            {
              "indent": 0,
              "text": "",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "// HEX形态检测",
              "type": "comment"
            },
            {
              "indent": 1,
              "text": "IF isHexLike(s) THEN",
              "type": "condition"
            },
            {
              "indent": 2,
              "text": "// 形态A: HEX前缀000000，长度42",
              "type": "comment"
            },
            {
              "indent": 2,
              "text": "IF LENGTH(s) == 42 AND STARTS_WITH(s, '000000') THEN",
              "type": "condition"
            },
            {
              "indent": 3,
              "text": "tail = SUBSTRING(s, 6)  // 取后36位HEX",
              "type": "action"
            },
            {
              "indent": 3,
              "text": "decoded = ASCII_DECODE(tail)",
              "type": "action"
            },
            {
              "indent": 3,
              "text": "IF decoded != NULL AND LENGTH(decoded) == 18 THEN",
              "type": "condition"
            },
            {
              "indent": 4,
              "text": "RETURN decoded",
              "type": "return"
            },
            {
              "indent": 0,
              "text": "",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "// 形态B: HEX长度40，解码后20位且以00结尾",
              "type": "comment"
            },
            {
              "indent": 2,
              "text": "IF LENGTH(s) == 40 THEN",
              "type": "condition"
            },
            {
              "indent": 3,
              "text": "decoded = ASCII_DECODE(s)",
              "type": "action"
            },
            {
              "indent": 3,
              "text": "IF decoded != NULL AND LENGTH(decoded) == 20 AND ENDS_WITH(decoded, '00') THEN",
              "type": "condition"
            },
            {
              "indent": 4,
              "text": "RETURN SUBSTRING(decoded, 0, 18)",
              "type": "return"
            },
            {
              "indent": 0,
              "text": "",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "// 未匹配任何规则，返回原值",
              "type": "comment"
            },
            {
              "indent": 1,
              "text": "RETURN s",
              "type": "return"
            }
          ],
          "calls": []
        },
        {
          "id": "uhf_init_pseudocode",
          "name": "UHF初始化伪代码",
          "description": "初始化UHF模块的完整流程，包含功率降级逻辑",
          "code_ref": {
            "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/rfid/UHFManager.java",
            "lines": "49-136"
          },
          "steps": [
            {
              "indent": 0,
              "text": "FUNCTION initialize(context):",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "TRY",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "this.context = context",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "this.sharedUtil = NEW SharedUtil(context)",
              "type": "action"
            },
            {
              "indent": 0,
              "text": "",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "// 获取UHF实例",
              "type": "comment"
            },
            {
              "indent": 2,
              "text": "uhfReader = UHFRManager.getInstance()",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "IF uhfReader IS NULL THEN RETURN FALSE",
              "type": "condition"
            },
            {
              "indent": 0,
              "text": "",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "// 尝试设置用户配置的功率",
              "type": "comment"
            },
            {
              "indent": 2,
              "text": "userPower = sharedUtil.getPower()",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "result = uhfReader.setPower(userPower, userPower)",
              "type": "action"
            },
            {
              "indent": 0,
              "text": "",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "IF result == MT_OK_ERR THEN",
              "type": "condition"
            },
            {
              "indent": 3,
              "text": "LOG '功率设置成功: ' + userPower + 'dBm'",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "ELSE",
              "type": "action"
            },
            {
              "indent": 3,
              "text": "// 降级到30dBm",
              "type": "comment"
            },
            {
              "indent": 3,
              "text": "LOG '功率设置失败，降级到30dBm'",
              "type": "action"
            },
            {
              "indent": 3,
              "text": "result = uhfReader.setPower(30, 30)",
              "type": "action"
            },
            {
              "indent": 3,
              "text": "IF result != MT_OK_ERR THEN RETURN FALSE",
              "type": "condition"
            },
            {
              "indent": 0,
              "text": "",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "// 设置频段",
              "type": "comment"
            },
            {
              "indent": 2,
              "text": "uhfReader.setRegion(sharedUtil.getWorkFreq())",
              "type": "action"
            },
            {
              "indent": 0,
              "text": "",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "// 设置其他参数",
              "type": "comment"
            },
            {
              "indent": 2,
              "text": "uhfReader.setGen2session(sharedUtil.getSession())",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "uhfReader.setTarget(sharedUtil.getTarget())",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "uhfReader.setQvaule(sharedUtil.getQvalue())",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "uhfReader.setFastID(sharedUtil.getFastId())",
              "type": "action"
            },
            {
              "indent": 0,
              "text": "",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "isInitialized = TRUE",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "RETURN TRUE",
              "type": "return"
            },
            {
              "indent": 0,
              "text": "",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "CATCH Exception",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "LOG '初始化失败'",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "RETURN FALSE",
              "type": "return"
            }
          ],
          "calls": []
        },
        {
          "id": "beep_request_pseudocode",
          "name": "蜂鸣请求伪代码",
          "description": "带限流的蜂鸣请求处理",
          "code_ref": {
            "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/rfid/RfidBeepManager.java",
            "lines": "56-70"
          },
          "steps": [
            {
              "indent": 0,
              "text": "FUNCTION requestBeep():",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "IF NOT active OR NOT enabled THEN RETURN",
              "type": "condition"
            },
            {
              "indent": 0,
              "text": "",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "// 计算最小间隔",
              "type": "comment"
            },
            {
              "indent": 1,
              "text": "gap = multiMode ? 40ms : 120ms",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "now = CURRENT_TIME_MS()",
              "type": "action"
            },
            {
              "indent": 0,
              "text": "",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "// 限流检查",
              "type": "comment"
            },
            {
              "indent": 1,
              "text": "IF now - lastBeepAt < gap THEN RETURN",
              "type": "condition"
            },
            {
              "indent": 0,
              "text": "",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "TRY",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "// 确保ToneGenerator存在",
              "type": "comment"
            },
            {
              "indent": 2,
              "text": "IF toneGenerator IS NULL THEN",
              "type": "condition"
            },
            {
              "indent": 3,
              "text": "toneGenerator = NEW ToneGenerator(STREAM_MUSIC, 100)",
              "type": "action"
            },
            {
              "indent": 0,
              "text": "",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "// 选择音色和时长",
              "type": "comment"
            },
            {
              "indent": 2,
              "text": "tone = multiMode ? TONE_PROP_BEEP : TONE_PROP_ACK",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "duration = multiMode ? 60ms : 120ms",
              "type": "action"
            },
            {
              "indent": 0,
              "text": "",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "// 发声",
              "type": "comment"
            },
            {
              "indent": 2,
              "text": "toneGenerator.startTone(tone, duration)",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "lastBeepAt = now",
              "type": "action"
            },
            {
              "indent": 0,
              "text": "",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "CATCH Exception",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "LOG '蜂鸣失败'",
              "type": "action"
            }
          ],
          "calls": []
        },
        {
          "id": "bytes_to_hex_pseudocode",
          "name": "字节数组转HEX字符串伪代码",
          "description": "将RFID标签的EpcId字节数组转换为十六进制字符串",
          "code_ref": {
            "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/rfid/UHFManager.java",
            "lines": "630-640"
          },
          "steps": [
            {
              "indent": 0,
              "text": "FUNCTION bytesToHexString(bytes):",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "IF bytes IS NULL OR LENGTH(bytes) == 0 THEN",
              "type": "condition"
            },
            {
              "indent": 2,
              "text": "RETURN ''",
              "type": "return"
            },
            {
              "indent": 0,
              "text": "",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "result = ''",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "FOR EACH byte IN bytes DO",
              "type": "loop"
            },
            {
              "indent": 2,
              "text": "// 转换为无符号值并格式化为2位HEX",
              "type": "comment"
            },
            {
              "indent": 2,
              "text": "hexValue = FORMAT('%02X', byte AND 0xFF)",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "result = result + hexValue",
              "type": "action"
            },
            {
              "indent": 0,
              "text": "",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "RETURN result",
              "type": "return"
            }
          ],
          "calls": []
        },
        {
          "id": "hex_to_ascii_pseudocode",
          "name": "HEX转ASCII伪代码",
          "description": "将HEX字符串按ASCII解码为字符串",
          "code_ref": {
            "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/rfid/EpcFormatter.java",
            "lines": "69-81"
          },
          "steps": [
            {
              "indent": 0,
              "text": "FUNCTION tryAsciiFromHex(hex):",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "TRY",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "IF hex IS NULL OR LENGTH(hex) % 2 != 0 THEN",
              "type": "condition"
            },
            {
              "indent": 3,
              "text": "RETURN NULL",
              "type": "return"
            },
            {
              "indent": 0,
              "text": "",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "result = ''",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "FOR i = 0 TO LENGTH(hex) STEP 2 DO",
              "type": "loop"
            },
            {
              "indent": 3,
              "text": "// 取2位HEX，解析为整数",
              "type": "comment"
            },
            {
              "indent": 3,
              "text": "byteValue = PARSE_INT(SUBSTRING(hex, i, i+2), 16)",
              "type": "action"
            },
            {
              "indent": 3,
              "text": "// 转换为字符",
              "type": "comment"
            },
            {
              "indent": 3,
              "text": "result = result + CHAR(byteValue)",
              "type": "action"
            },
            {
              "indent": 0,
              "text": "",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "RETURN result",
              "type": "return"
            },
            {
              "indent": 0,
              "text": "",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "CATCH Exception",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "RETURN NULL",
              "type": "return"
            }
          ],
          "calls": []
        }
      ]
    },
    {
      "id": "transfer",
      "name": "耗材调拨模块",
      "description": "PDA 动作型移库单功能，支持条码/RFID扫描耗材，按源中心库+子码聚合展示，一次提交后端按源中心库拆分移库单",
      "code_refs": [
        {
          "file": "/Users/dm/code/PDA/app/src/main/java/com/pda/hcw/ConsumableTransferActivity.java"
        }
      ],
      "flows": [
        {
          "id": "transfer_main_flow",
          "name": "耗材移库主流程",
          "description": "从选择目标中心库到提交移库单的完整流程",
          "code_ref": {
            "file": "ConsumableTransferActivity.java",
            "lines": "146-155, 361-429"
          },
          "steps": [
            {
              "id": "step_1",
              "order": 1,
              "name": "选择目标中心库",
              "description": "从下拉列表选择启用中的中心库作为移库目标"
            },
            {
              "id": "step_2",
              "order": 2,
              "name": "扫描耗材",
              "description": "通过条码扫描或RFID扫描添加耗材到移库单"
            },
            {
              "id": "step_3",
              "order": 3,
              "name": "预览聚合",
              "description": "调用API预览移库信息，按源中心库+子码聚合展示"
            },
            {
              "id": "step_4",
              "order": 4,
              "name": "提交移库",
              "description": "构造请求体提交移库，后端按源中心库拆分移库单"
            }
          ]
        },
        {
          "id": "barcode_scan_flow",
          "name": "条码扫描流程",
          "description": "通过条码输入框扫描耗材条码",
          "code_ref": {
            "file": "ConsumableTransferActivity.java",
            "lines": "201-274"
          },
          "steps": [
            {
              "id": "step_1",
              "order": 1,
              "name": "监听输入",
              "description": "监听IME_ACTION_DONE或回车键事件"
            },
            {
              "id": "step_2",
              "order": 2,
              "name": "校验前置条件",
              "description": "检查是否已选择目标中心库"
            },
            {
              "id": "step_3",
              "order": 3,
              "name": "校验条码格式",
              "description": "使用BarcodeValidator校验条码格式"
            },
            {
              "id": "step_4",
              "order": 4,
              "name": "调用预览API",
              "description": "调用previewTransferByBarcode获取移库预览信息"
            }
          ]
        },
        {
          "id": "rfid_scan_flow",
          "name": "RFID扫描流程",
          "description": "通过UHF RFID批量扫描耗材标签",
          "code_ref": {
            "file": "ConsumableTransferActivity.java",
            "lines": "472-682"
          },
          "steps": [
            {
              "id": "step_1",
              "order": 1,
              "name": "初始化RFID",
              "description": "获取UHFManager单例并初始化"
            },
            {
              "id": "step_2",
              "order": 2,
              "name": "配置检查",
              "description": "检查sdCode和货柜ID配置"
            },
            {
              "id": "step_3",
              "order": 3,
              "name": "启动扫描",
              "description": "设置Gen2session，启动异步读取和轮询"
            },
            {
              "id": "step_4",
              "order": 4,
              "name": "轮询读取",
              "description": "每200ms轮询一次，优先实时读取，失败则定时读取"
            },
            {
              "id": "step_5",
              "order": 5,
              "name": "处理标签",
              "description": "解析EPC，去重，调用预览API"
            }
          ]
        }
      ],
      "rules": [
        {
          "id": "rule_center_required",
          "name": "目标中心库必选",
          "description": "扫描耗材或提交移库前必须先选择目标中心库",
          "code_ref": {
            "file": "ConsumableTransferActivity.java",
            "lines": "217-218, 254-256, 362-365, 485-488"
          },
          "condition": "selectedCenterId == null",
          "action": "showError(getString(R.string.transfer_select_center_first))",
          "priority": "medium",
          "constraints": [
            "selectedCenterId == null"
          ],
          "effects": [
            "showError(getString(R.string.transfer_select_center_first))"
          ]
        },
        {
          "id": "rule_center_filter",
          "name": "中心库过滤规则",
          "description": "仅显示启用中的中心库类型地点",
          "code_ref": {
            "file": "ConsumableTransferActivity.java",
            "lines": "169-175"
          },
          "conditions": [
            "serverId != null && serverId > 0",
            "type == 'center' (忽略大小写)",
            "isActive == true"
          ],
          "priority": "medium",
          "constraints": [],
          "effects": []
        },
        {
          "id": "rule_barcode_validation",
          "name": "条码格式校验",
          "description": "使用BarcodeValidator校验条码格式",
          "code_ref": {
            "file": "ConsumableTransferActivity.java",
            "lines": "246-252"
          },
          "condition": "!validator.validateBarcode(barcode)",
          "action": "showError(validator.getInvalidBarcodeMessage())",
          "priority": "medium",
          "constraints": [
            "!validator.validateBarcode(barcode)"
          ],
          "effects": [
            "showError(validator.getInvalidBarcodeMessage())"
          ]
        },
        {
          "id": "rule_rfid_duplicate",
          "name": "RFID去重规则",
          "description": "同一RFID在本次移库单中只能添加一次",
          "code_ref": {
            "file": "ConsumableTransferActivity.java",
            "lines": "277-283, 651"
          },
          "conditions": [
            "selectedByRfid.containsKey(rfid) -> 显示已在当前移库单中",
            "seenEpcsThisRun.add(rfid18) -> 本轮扫描去重"
          ],
          "priority": "medium",
          "constraints": [],
          "effects": []
        },
        {
          "id": "rule_rfid_config_required",
          "name": "RFID配置必填",
          "description": "启动RFID扫描前必须配置sdCode和货柜ID",
          "code_ref": {
            "file": "ConsumableTransferActivity.java",
            "lines": "501-519"
          },
          "conditions": [
            "sd_code不能为空",
            "cabinetId必须大于0"
          ],
          "priority": "medium",
          "constraints": [],
          "effects": []
        },
        {
          "id": "rule_submit_validation",
          "name": "提交前校验",
          "description": "提交移库单前的校验规则",
          "code_ref": {
            "file": "ConsumableTransferActivity.java",
            "lines": "362-374"
          },
          "conditions": [
            "selectedCenterId != null (必须选择目标中心库)",
            "!selectedByRfid.isEmpty() (必须有待移库耗材)",
            "currentUser != null (用户必须已登录)"
          ],
          "priority": "medium",
          "constraints": [],
          "effects": []
        },
        {
          "id": "rule_group_aggregation",
          "name": "聚合规则",
          "description": "按源中心库ID+子码聚合展示",
          "code_ref": {
            "file": "ConsumableTransferActivity.java",
            "lines": "288-289"
          },
          "key_format": "fromLocationId + '#' + code",
          "priority": "medium",
          "constraints": [],
          "effects": []
        },
        {
          "id": "rule_rfid_auto_restart",
          "name": "RFID自动重启规则",
          "description": "连续4轮空读后自动重启RFID读取",
          "code_ref": {
            "file": "ConsumableTransferActivity.java",
            "lines": "606-616"
          },
          "condition": "emptyReadRounds >= 4",
          "action": "asyncStopReading -> sleep(30ms) -> asyncStartReading",
          "priority": "medium",
          "constraints": [
            "emptyReadRounds >= 4"
          ],
          "effects": [
            "asyncStopReading -> sleep(30ms) -> asyncStartReading"
          ]
        }
      ],
      "state_machines": [
        {
          "id": "rfid_state_machine",
          "name": "RFID扫描状态机",
          "description": "RFID扫描的启动/停止状态管理",
          "code_ref": {
            "file": "ConsumableTransferActivity.java",
            "lines": "94, 484-498, 532-572, 574-592"
          },
          "states": [
            {
              "id": "idle",
              "name": "空闲",
              "description": "RFID未激活，isRFIDActive=false"
            },
            {
              "id": "scanning",
              "name": "扫描中",
              "description": "RFID激活中，isRFIDActive=true，轮询线程运行"
            }
          ],
          "transitions": [
            {
              "from": "idle",
              "to": "scanning",
              "trigger": "toggleRFIDScanning() when !isRFIDActive"
            },
            {
              "from": "scanning",
              "to": "idle",
              "trigger": "toggleRFIDScanning() when isRFIDActive"
            },
            {
              "from": "scanning",
              "to": "idle",
              "trigger": "onPause() / onDestroy()"
            }
          ],
          "entity": "RFID扫描状态机",
          "field": "status"
        }
      ],
      "pseudocodes": [
        {
          "id": "pseudo_add_or_update_group",
          "name": "addOrUpdateGroup",
          "description": "添加或更新聚合分组",
          "code_ref": {
            "file": "ConsumableTransferActivity.java",
            "lines": "276-321"
          },
          "steps": [
            {
              "indent": 0,
              "text": "IF src为空 OR src.rfid为空 THEN RETURN",
              "type": "condition"
            },
            {
              "indent": 0,
              "text": "rfid = src.rfid.trim()",
              "type": "action"
            },
            {
              "indent": 0,
              "text": "IF rfid已在selectedByRfid中 THEN",
              "type": "condition"
            },
            {
              "indent": 1,
              "text": "显示'该耗材已在当前移库单中'",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "RETURN",
              "type": "return"
            },
            {
              "indent": 0,
              "text": "END IF",
              "type": "action"
            },
            {
              "indent": 0,
              "text": "将rfid加入selectedByRfid",
              "type": "action"
            },
            {
              "indent": 0,
              "text": "key = fromLocationId + '#' + code",
              "type": "action"
            },
            {
              "indent": 0,
              "text": "IF key不在groupMap中 THEN",
              "type": "condition"
            },
            {
              "indent": 1,
              "text": "创建新的TransferGroupItem",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "加入groupMap和groupList头部",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "通知适配器插入",
              "type": "action"
            },
            {
              "indent": 0,
              "text": "END IF",
              "type": "action"
            },
            {
              "indent": 0,
              "text": "group.quantity++",
              "type": "action"
            },
            {
              "indent": 0,
              "text": "group.rfids.add(rfid)",
              "type": "action"
            },
            {
              "indent": 0,
              "text": "通知适配器更新",
              "type": "action"
            },
            {
              "indent": 0,
              "text": "totalCount++",
              "type": "action"
            },
            {
              "indent": 0,
              "text": "更新汇总显示",
              "type": "action"
            }
          ],
          "calls": []
        },
        {
          "id": "pseudo_submit_transfer",
          "name": "submitTransfer",
          "description": "提交移库单",
          "code_ref": {
            "file": "ConsumableTransferActivity.java",
            "lines": "361-429"
          },
          "steps": [
            {
              "indent": 0,
              "text": "校验: selectedCenterId不为空",
              "type": "action"
            },
            {
              "indent": 0,
              "text": "校验: selectedByRfid不为空",
              "type": "action"
            },
            {
              "indent": 0,
              "text": "校验: 用户已登录",
              "type": "action"
            },
            {
              "indent": 0,
              "text": "构造请求体:",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "- to_location_id: 目标中心库ID",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "- rfid_list: RFID列表",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "- operator_id: 操作员ID",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "- device_id: 设备ID",
              "type": "action"
            },
            {
              "indent": 0,
              "text": "POST请求到 TRANSFER_SUBMIT_FROM_PDA",
              "type": "action"
            },
            {
              "indent": 0,
              "text": "IF status == 200 THEN",
              "type": "condition"
            },
            {
              "indent": 1,
              "text": "显示成功(成功数量, 订单数量)",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "清空所有数据",
              "type": "action"
            },
            {
              "indent": 0,
              "text": "ELSE",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "显示错误信息",
              "type": "action"
            },
            {
              "indent": 0,
              "text": "END IF",
              "type": "action"
            }
          ],
          "calls": []
        },
        {
          "id": "pseudo_handle_rfid_tag",
          "name": "handleRfidTag",
          "description": "处理RFID标签",
          "code_ref": {
            "file": "ConsumableTransferActivity.java",
            "lines": "640-682"
          },
          "steps": [
            {
              "indent": 0,
              "text": "epcHex = 字节转十六进制(tag.EpcId)",
              "type": "action"
            },
            {
              "indent": 0,
              "text": "IF epcHex为空 THEN RETURN",
              "type": "condition"
            },
            {
              "indent": 0,
              "text": "IF beepModeRaw THEN 请求蜂鸣",
              "type": "condition"
            },
            {
              "indent": 0,
              "text": "rfid18 = EpcFormatter.normalizeOnReceive(epcHex)",
              "type": "action"
            },
            {
              "indent": 0,
              "text": "IF rfid18为空 THEN RETURN",
              "type": "condition"
            },
            {
              "indent": 0,
              "text": "IF rfid18已在seenEpcsThisRun中 THEN RETURN (本轮去重)",
              "type": "condition"
            },
            {
              "indent": 0,
              "text": "将rfid18加入seenEpcsThisRun",
              "type": "action"
            },
            {
              "indent": 0,
              "text": "IF selectedCenterId为空 THEN RETURN",
              "type": "condition"
            },
            {
              "indent": 0,
              "text": "调用previewTransferByRfid API",
              "type": "call"
            },
            {
              "indent": 1,
              "text": "成功: addOrUpdateGroup(result)",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "失败: 显示错误",
              "type": "action"
            },
            {
              "indent": 0,
              "text": "更新EPC滚动列表UI",
              "type": "action"
            },
            {
              "indent": 0,
              "text": "IF !beepModeRaw THEN 请求蜂鸣 (业务模式)",
              "type": "condition"
            }
          ],
          "calls": []
        },
        {
          "id": "pseudo_rfid_polling",
          "name": "startRFIDPolling",
          "description": "RFID轮询逻辑",
          "code_ref": {
            "file": "ConsumableTransferActivity.java",
            "lines": "594-627"
          },
          "steps": [
            {
              "indent": 0,
              "text": "LOOP (每200ms):",
              "type": "loop"
            },
            {
              "indent": 1,
              "text": "IF !isRFIDActive OR uhfManager未初始化 THEN RETURN",
              "type": "condition"
            },
            {
              "indent": 1,
              "text": "tagList = uhfManager.tagInventoryRealTime()",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "IF tagList为空 THEN",
              "type": "condition"
            },
            {
              "indent": 2,
              "text": "tagList = uhfManager.tagInventoryByTimer(50ms)",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "END IF",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "IF tagList为空 THEN",
              "type": "condition"
            },
            {
              "indent": 2,
              "text": "emptyReadRounds++",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "IF emptyReadRounds >= 4 THEN",
              "type": "condition"
            },
            {
              "indent": 3,
              "text": "重启RFID读取(stop -> sleep 30ms -> start)",
              "type": "action"
            },
            {
              "indent": 3,
              "text": "emptyReadRounds = 0",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "END IF",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "ELSE",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "emptyReadRounds = 0",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "FOR EACH tag IN tagList:",
              "type": "loop"
            },
            {
              "indent": 3,
              "text": "handleRfidTag(tag)",
              "type": "action"
            },
            {
              "indent": 2,
              "text": "END FOR",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "END IF",
              "type": "action"
            },
            {
              "indent": 1,
              "text": "IF isRFIDActive THEN 延迟200ms后继续轮询",
              "type": "condition"
            }
          ],
          "calls": []
        }
      ]
    }
  ],
  "data_models": [
    {
      "id": "UserInfo",
      "name": "用户信息",
      "description": "登录用户的基本信息",
      "code_ref": {
        "file": "app/src/main/java/com/pda/hcw/UserInfo.java"
      },
      "fields": [
        {
          "name": "userId",
          "type": "String",
          "description": "用户ID"
        },
        {
          "name": "username",
          "type": "String",
          "description": "用户名"
        },
        {
          "name": "realName",
          "type": "String",
          "description": "真实姓名"
        },
        {
          "name": "department",
          "type": "String",
          "description": "部门"
        },
        {
          "name": "role",
          "type": "UserRole",
          "description": "角色枚举"
        },
        {
          "name": "token",
          "type": "String",
          "description": "认证令牌"
        },
        {
          "name": "sessionId",
          "type": "String",
          "description": "会话ID"
        },
        {
          "name": "nfcCardId",
          "type": "String",
          "description": "NFC卡号（可选）"
        },
        {
          "name": "isBackdoorAccount",
          "type": "boolean",
          "description": "是否后门账户"
        }
      ]
    },
    {
      "id": "ConsumableItem",
      "name": "耗材项",
      "description": "单个耗材的详细信息",
      "code_ref": {
        "file": "app/src/main/java/com/pda/hcw/ConsumableItem.java"
      },
      "fields": [
        {
          "name": "rfid",
          "type": "String",
          "description": "RFID标签（18位）"
        },
        {
          "name": "barcode",
          "type": "String",
          "description": "条码"
        },
        {
          "name": "code",
          "type": "String",
          "description": "商品编号/子码"
        },
        {
          "name": "name",
          "type": "String",
          "description": "商品名称"
        },
        {
          "name": "spec",
          "type": "String",
          "description": "规格"
        },
        {
          "name": "manufacturer",
          "type": "String",
          "description": "生产厂家"
        },
        {
          "name": "brand",
          "type": "String",
          "description": "品牌"
        },
        {
          "name": "unit",
          "type": "String",
          "description": "单位"
        },
        {
          "name": "batch",
          "type": "String",
          "description": "批号"
        },
        {
          "name": "expiryDate",
          "type": "String",
          "description": "有效期"
        },
        {
          "name": "currentLocationId",
          "type": "int",
          "description": "当前位置ID"
        },
        {
          "name": "currentLocationName",
          "type": "String",
          "description": "当前位置名称"
        }
      ]
    },
    {
      "id": "CheckoutRecord",
      "name": "出库记录",
      "description": "本地持久化的取用/归还记录",
      "code_ref": {
        "file": "app/src/main/java/com/pda/hcw/CheckoutRecord.java"
      },
      "fields": [
        {
          "name": "recordId",
          "type": "String",
          "description": "本地记录ID"
        },
        {
          "name": "serverRecordId",
          "type": "int",
          "description": "服务端记录ID"
        },
        {
          "name": "checkoutTime",
          "type": "long",
          "description": "操作时间戳"
        },
        {
          "name": "operatingRoom",
          "type": "String",
          "description": "术间名称"
        },
        {
          "name": "totalQuantity",
          "type": "int",
          "description": "总数量"
        },
        {
          "name": "operator",
          "type": "String",
          "description": "操作员姓名"
        },
        {
          "name": "operatorUserId",
          "type": "String",
          "description": "操作员ID"
        },
        {
          "name": "recordType",
          "type": "String",
          "description": "记录类型：checkout/return"
        },
        {
          "name": "items",
          "type": "List<ConsumableItem>",
          "description": "耗材明细列表"
        }
      ]
    },
    {
      "id": "InventoryTask",
      "name": "盘点任务",
      "description": "盘点任务的基本信息",
      "code_ref": {
        "file": "app/src/main/java/com/pda/hcw/InventoryTask.java"
      },
      "fields": [
        {
          "name": "taskId",
          "type": "int",
          "description": "任务ID"
        },
        {
          "name": "taskName",
          "type": "String",
          "description": "任务名称"
        },
        {
          "name": "status",
          "type": "String",
          "description": "状态：running/closed/review"
        },
        {
          "name": "totalCount",
          "type": "int",
          "description": "计划总数"
        },
        {
          "name": "scannedCount",
          "type": "int",
          "description": "已扫描数"
        },
        {
          "name": "createTime",
          "type": "String",
          "description": "创建时间"
        }
      ]
    },
    {
      "id": "InventorySession",
      "name": "盘点会话",
      "description": "内存态的盘点会话，管理计划集和已盘集",
      "code_ref": {
        "file": "app/src/main/java/com/pda/hcw/inventory/InventorySession.java"
      },
      "fields": [
        {
          "name": "taskId",
          "type": "int",
          "description": "关联的任务ID"
        },
        {
          "name": "allPlanned",
          "type": "Set<String>",
          "description": "计划内RFID集合"
        },
        {
          "name": "plannedByRoom",
          "type": "Map<String,Set<String>>",
          "description": "按地点分组的计划集"
        },
        {
          "name": "countedAll",
          "type": "Set<String>",
          "description": "已盘RFID集合"
        },
        {
          "name": "countedByRoom",
          "type": "Map<String,Set<String>>",
          "description": "按地点分组的已盘集"
        },
        {
          "name": "surplus",
          "type": "Set<String>",
          "description": "盈余RFID集合"
        },
        {
          "name": "seen",
          "type": "Set<String>",
          "description": "本轮已见RFID（去重用）"
        }
      ]
    },
    {
      "id": "InboundOrder",
      "name": "入库单",
      "description": "待上架的入库单据",
      "fields": [
        {
          "name": "code",
          "type": "String",
          "description": "单据编号"
        },
        {
          "name": "total",
          "type": "int",
          "description": "总数量"
        },
        {
          "name": "accepted",
          "type": "int",
          "description": "已上架数量"
        },
        {
          "name": "rpNameTo",
          "type": "String",
          "description": "目标仓库名称"
        },
        {
          "name": "plannedRfids",
          "type": "Set<String>",
          "description": "待上架RFID集合"
        },
        {
          "name": "details",
          "type": "List<InboundOrderDetail>",
          "description": "明细列表"
        }
      ]
    },
    {
      "id": "OperatingRoom",
      "name": "地点/术间",
      "description": "地点信息，包括中心库和术间",
      "code_ref": {
        "file": "app/src/main/java/com/pda/hcw/OperatingRoom.java"
      },
      "fields": [
        {
          "name": "serverId",
          "type": "int",
          "description": "服务端ID"
        },
        {
          "name": "name",
          "type": "String",
          "description": "名称"
        },
        {
          "name": "type",
          "type": "String",
          "description": "类型：center/room"
        },
        {
          "name": "isActive",
          "type": "boolean",
          "description": "是否启用"
        }
      ]
    },
    {
      "id": "LocationSummary",
      "name": "地点汇总",
      "description": "盘点时的地点统计卡片",
      "code_ref": {
        "file": "app/src/main/java/com/pda/hcw/LocationSummary.java"
      },
      "fields": [
        {
          "name": "roomId",
          "type": "String",
          "description": "地点ID"
        },
        {
          "name": "roomName",
          "type": "String",
          "description": "地点名称"
        },
        {
          "name": "plannedCount",
          "type": "int",
          "description": "计划数"
        },
        {
          "name": "countedCount",
          "type": "int",
          "description": "已盘数"
        },
        {
          "name": "missingCount",
          "type": "int",
          "description": "缺失数"
        }
      ]
    }
  ],
  "glossary": {
    "EPC": {
      "term": "EPC",
      "description": "Electronic Product Code，电子产品编码，RFID 标签的唯一标识"
    },
    "RFID": {
      "term": "RFID",
      "description": "Radio Frequency Identification，射频识别技术"
    },
    "UHF": {
      "term": "UHF",
      "description": "Ultra High Frequency，超高频 RFID（860-960MHz）"
    },
    "SPD": {
      "term": "SPD",
      "description": "Supply Processing Distribution，医疗供应链配送中心"
    },
    "中心库": {
      "term": "中心库",
      "description": "医院的中央耗材仓库，type=center"
    },
    "术间": {
      "term": "术间",
      "description": "手术室，type=room，耗材取用的目标地点"
    },
    "盘点": {
      "term": "盘点",
      "description": "库存清点，对比计划库存与实际扫描结果"
    },
    "取用": {
      "term": "取用",
      "description": "从中心库领取耗材到术间"
    },
    "归还": {
      "term": "归还",
      "description": "将未使用的耗材从术间退回中心库"
    },
    "入库验收": {
      "term": "入库验收",
      "description": "有单入库上架，将 SPD 配送的耗材验收入库"
    },
    "调拨": {
      "term": "调拨",
      "description": "耗材在不同中心库之间的移库操作"
    }
  },
  "changelog": [
    {
      "date": "2026-02-04",
      "type": "init",
      "summary": "初始版本：从代码中提取业务逻辑清单"
    }
  ]
}