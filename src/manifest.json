{
  "$schema": "https://logic-command-center.dev/schema/v3.1",
  "project": {
    "id": "hcw_yao",
    "name": "高值耗材管理系统",
    "description": "基于 Yao 框架的高值耗材全生命周期管理系统，支持入库、取用、消耗、盘点等业务流程",
    "version": "2.0.0",
    "updated_at": "2025-02-02"
  },
  "modules": [
    {
      "id": "inbound",
      "name": "入库管理",
      "description": "管理耗材入库流程，支持有单入库和无单入库两种模式",
      "tags": ["核心", "库存"],
      "dependencies": ["spd", "dictionary"],
      "code_refs": [{ "file": "scripts/hv3/stock/inbound.js" }],
      "flows": [
        {
          "id": "flow_has_order_inbound",
          "name": "有单入库流程",
          "description": "根据SPD下发的待上架订单进行入库",
          "trigger": "用户扫描耗材RFID",
          "steps": [
            { "id": "step1", "order": 1, "name": "参数校验", "description": "校验入库参数（items、target_location_id、bindingId）", "rules": ["rule_inbound_params"] },
            { "id": "step2", "order": 2, "name": "校验入库方式", "description": "检查系统配置的入库方式是否匹配", "rules": ["rule_inbound_method"] },
            { "id": "step3", "order": 3, "name": "字段补齐", "description": "通过字典或SPD接口补齐厂家、品牌、单位等信息", "rules": ["rule_enrich_items"] },
            { "id": "step4", "order": 4, "name": "库存校验", "description": "批量查询库存，校验RFID是否已存在", "rules": ["rule_check_existing"] },
            { "id": "step5", "order": 5, "name": "写入库存", "description": "批量插入或更新库存记录" },
            { "id": "step6", "order": 6, "name": "更新待上架订单", "description": "将pending_inbound_order状态改为completed" },
            { "id": "step7", "order": 7, "name": "记录日志", "description": "写入入库日志和库存流转账本" }
          ],
          "code_ref": { "file": "scripts/hv3/stock/inbound.js", "function": "hasOrderAddStock", "line": 175 }
        },
        {
          "id": "flow_no_order_inbound",
          "name": "无单入库流程",
          "description": "直接扫描耗材RFID进行入库，通过SPD查询耗材信息",
          "trigger": "用户扫描耗材RFID",
          "steps": [
            { "id": "step1", "order": 1, "name": "校验入库方式", "description": "确认系统配置为无单入库模式", "rules": ["rule_inbound_method"] },
            { "id": "step2", "order": 2, "name": "SPD查询", "description": "按货柜分组调用SPD接口查询耗材信息" },
            { "id": "step3", "order": 3, "name": "批量入库", "description": "将SPD返回的耗材信息写入库存表" },
            { "id": "step4", "order": 4, "name": "记录日志", "description": "写入入库日志和库存流转账本" },
            { "id": "step5", "order": 5, "name": "更新效期状态", "description": "检测并更新耗材效期状态" }
          ],
          "code_ref": { "file": "scripts/hv3/stock/inbound.js", "function": "noOrderAddStock", "line": 657 }
        }
      ],
      "rules": [
        {
          "id": "rule_inbound_params",
          "name": "入库参数校验规则",
          "description": "入库时必须提供有效的耗材清单、目标地点ID和SPD仓库ID",
          "priority": "high",
          "category": "校验",
          "constraints": ["items必须是非空数组", "target_location_id必须存在", "bindingId必须存在"],
          "effects": ["校验失败返回400错误"],
          "affects": { "entities": ["inventory"], "operations": ["C"] },
          "code_ref": { "file": "scripts/hv3/stock/inbound.js", "line": 180 }
        },
        {
          "id": "rule_inbound_method",
          "name": "入库方式匹配规则",
          "description": "入库类型必须与系统配置的onShelfInboundMethod一致",
          "priority": "high",
          "category": "校验",
          "constraints": ["type必须为hasOrder或noOrder", "必须与系统配置匹配"],
          "effects": ["不匹配时返回400错误"],
          "affects": { "entities": ["inventory"], "operations": ["C"] },
          "code_ref": { "file": "scripts/hv3/stock/inbound.js", "line": 223 }
        },
        {
          "id": "rule_enrich_items",
          "name": "耗材信息补齐规则",
          "description": "入库时厂家、品牌、单位只能从字典或SPD获取，不信任前端传值",
          "priority": "high",
          "category": "数据补齐",
          "constraints": ["字典优先", "字典未命中时查询SPD", "SPD查询失败则整单失败"],
          "effects": ["补齐manufacturer、brand、unit字段", "未补齐则拒绝入库"],
          "affects": { "entities": ["inventory"], "fields": ["manufacturer", "brand", "unit"], "operations": ["C"] },
          "code_ref": { "file": "scripts/hv3/stock/inbound.js", "function": "enrichInboundItemsWithDictAndSpd", "line": 19 }
        },
        {
          "id": "rule_check_existing",
          "name": "库存重复校验规则",
          "description": "有单入库时，已在库或已取用的RFID不允许重复入库",
          "priority": "high",
          "category": "校验",
          "constraints": ["有单入库：status为inStock或taken时拒绝", "无单入库：RFID已存在时拒绝"],
          "effects": ["重复RFID进入errorItems列表"],
          "affects": { "entities": ["inventory"], "operations": ["C"] },
          "code_ref": { "file": "scripts/hv3/stock/inbound.js", "line": 285 }
        },
        {
          "id": "rule_center_location",
          "name": "中心库位置校验规则",
          "description": "入库目标地点必须是启用的中心库(type=center)",
          "priority": "high",
          "category": "校验",
          "constraints": ["地点必须存在", "地点必须启用(is_active=true)", "地点类型必须是center"],
          "effects": ["校验失败返回400错误"],
          "affects": { "entities": ["locations"], "operations": ["R"] },
          "code_ref": { "file": "scripts/hv3/stock/inbound.js", "function": "ensureCenterLocation", "line": 146 }
        }
      ],
      "state_machines": [
        {
          "id": "sm_inventory_status",
          "name": "库存状态机",
          "description": "耗材在库存中的状态流转",
          "entity": "inventory",
          "field": "status",
          "states": [
            { "id": "inStock", "name": "在库", "description": "耗材已入库，可被取用", "is_initial": true },
            { "id": "taken", "name": "已取用", "description": "耗材已被取出，待消耗或归还" },
            { "id": "consumed", "name": "已消耗", "description": "耗材已被消耗使用" },
            { "id": "usedReturn", "name": "消耗退回", "description": "已消耗的耗材被退回", "is_final": true }
          ],
          "transitions": [
            { "from": "inStock", "to": "taken", "trigger": "取用", "description": "用户从货柜取出耗材" },
            { "from": "taken", "to": "inStock", "trigger": "归还", "description": "用户将未使用的耗材放回货柜" },
            { "from": "taken", "to": "consumed", "trigger": "消耗确认", "description": "确认耗材已在手术中使用" },
            { "from": "consumed", "to": "usedReturn", "trigger": "消耗退回", "description": "已消耗耗材因某种原因退回" }
          ]
        }
      ],
      "pseudocodes": [
        {
          "id": "pc_has_order_inbound",
          "name": "有单入库",
          "description": "处理有单入库的完整逻辑",
          "params": ["params: {userID, type, items, target_location_id, bindingId}"],
          "returns": "入库结果 {成功数量, 失败列表}",
          "steps": [
            { "indent": 0, "text": "// 有单入库：根据SPD待上架订单进行入库", "type": "comment" },
            { "indent": 0, "text": "校验 items 是否为有效数组", "type": "condition" },
            { "indent": 1, "text": "若无效 → 返回错误", "type": "error" },
            { "indent": 0, "text": "校验 target_location_id 是否为启用的中心库", "type": "condition" },
            { "indent": 1, "text": "若不是 → 返回错误", "type": "error" },
            { "indent": 0, "text": "校验系统配置的入库方式是否匹配", "type": "condition" },
            { "indent": 1, "text": "若不匹配 → 返回错误", "type": "error" },
            { "indent": 0, "text": "调用 enrichInboundItemsWithDictAndSpd 补齐耗材信息", "type": "call" },
            { "indent": 1, "text": "先查字典表补齐厂家/品牌/单位", "type": "action" },
            { "indent": 1, "text": "字典未命中的调用 SPD.唯一码查询", "type": "call" },
            { "indent": 0, "text": "批量查询库存表，获取已存在的RFID", "type": "call" },
            { "indent": 0, "text": "遍历 enrichedItems", "type": "loop" },
            { "indent": 1, "text": "若RFID已存在且状态为inStock/taken → 加入errorItems", "type": "condition" },
            { "indent": 1, "text": "若RFID已存在但需更新 → 加入itemsToUpdate", "type": "action" },
            { "indent": 1, "text": "若RFID不存在 → 加入itemsToInsert", "type": "action" },
            { "indent": 0, "text": "分批执行事务 TxHasOrderInbound", "type": "call" },
            { "indent": 1, "text": "批量插入新库存记录", "type": "action" },
            { "indent": 1, "text": "批量更新现有库存状态", "type": "action" },
            { "indent": 1, "text": "批量更新待上架订单状态为completed", "type": "action" },
            { "indent": 0, "text": "记录入库日志和库存流转账本", "type": "call" },
            { "indent": 0, "text": "返回入库结果", "type": "return" }
          ],
          "calls": [
            { "name": "字典表.按code查询", "type": "db", "table": "AllConsumablesDictionary", "description": "查询耗材字典补齐信息" },
            { "name": "SPD.唯一码查询", "type": "api", "method": "POST", "endpoint": "scripts.hv3.spd.spd.queryStock", "description": "查询SPD获取耗材详细信息" },
            { "name": "库存表.批量查询", "type": "db", "table": "inventory", "description": "检查RFID是否已存在" },
            { "name": "库存表.批量插入", "type": "db", "table": "inventory", "description": "插入新库存记录" },
            { "name": "待上架订单.批量更新", "type": "db", "table": "pendingInboundOrder", "description": "更新订单状态为completed" },
            { "name": "入库日志.记录", "type": "internal", "description": "调用operation.addInBoundAndReturnLog" },
            { "name": "库存流转账本.记录", "type": "db", "table": "stock_movement", "description": "记录Inbound操作" }
          ],
          "code_ref": { "file": "scripts/hv3/stock/inbound.js", "function": "hasOrderAddStock", "line": 175 }
        }
      ]
    },
    {
      "id": "outbound",
      "name": "出库管理",
      "description": "管理耗材取用和退库流程",
      "tags": ["核心", "库存"],
      "dependencies": ["inbound"],
      "code_refs": [{ "file": "scripts/hv3/stock/outbound.js" }],
      "flows": [
        {
          "id": "flow_return_supplier",
          "name": "退库流程",
          "description": "将在库耗材退回供应商",
          "trigger": "用户发起退库操作",
          "steps": [
            { "id": "step1", "order": 1, "name": "参数校验", "description": "校验退库列表和用户信息", "rules": ["rule_return_params"] },
            { "id": "step2", "order": 2, "name": "库存校验", "description": "批量检查RFID是否可退库（状态为inStock或usedReturn）", "rules": ["rule_return_status"] },
            { "id": "step3", "order": 3, "name": "记录退库日志", "description": "调用operation.addInBoundAndReturnLog" },
            { "id": "step4", "order": 4, "name": "归档库存", "description": "将库存记录写入归档表" },
            { "id": "step5", "order": 5, "name": "记录流转账本", "description": "写入ReturnSupplier操作记录" },
            { "id": "step6", "order": 6, "name": "删除库存", "description": "从库存表删除已退库的记录" }
          ],
          "code_ref": { "file": "scripts/hv3/stock/outbound.js", "function": "createReturnOrder", "line": 8 }
        }
      ],
      "rules": [
        {
          "id": "rule_return_params",
          "name": "退库参数校验规则",
          "description": "退库时必须提供退库列表、类型和用户ID",
          "priority": "high",
          "category": "校验",
          "constraints": ["list不能为空", "type必须提供", "userID必须提供"],
          "effects": ["校验失败抛出异常"],
          "affects": { "entities": ["inventory"], "operations": ["D"] },
          "code_ref": { "file": "scripts/hv3/stock/outbound.js", "line": 12 }
        },
        {
          "id": "rule_return_status",
          "name": "退库状态校验规则",
          "description": "只有状态为inStock或usedReturn的耗材才能退库",
          "priority": "high",
          "category": "校验",
          "constraints": ["status必须是inStock或usedReturn"],
          "effects": ["状态不符合则抛出异常"],
          "affects": { "entities": ["inventory"], "fields": ["status"], "operations": ["R", "D"] },
          "code_ref": { "file": "scripts/hv3/stock/outbound.js", "line": 42 }
        }
      ],
      "state_machines": [],
      "pseudocodes": [
        {
          "id": "pc_create_return_order",
          "name": "创建退库单",
          "description": "将在库耗材退回供应商的完整流程",
          "params": ["params: {list, type, userID, reason, target_location_id}"],
          "returns": "退库结果 {退库单号, 退库数量}",
          "steps": [
            { "indent": 0, "text": "// 退库：将在库耗材退回供应商", "type": "comment" },
            { "indent": 0, "text": "校验 list、type、userID 必填", "type": "condition" },
            { "indent": 0, "text": "查询用户信息获取用户名", "type": "call" },
            { "indent": 0, "text": "批量查询库存表，获取所有RFID的库存记录", "type": "call" },
            { "indent": 0, "text": "校验所有RFID是否存在且状态允许退库", "type": "condition" },
            { "indent": 1, "text": "若有不存在或状态不允许的 → 抛出异常", "type": "error" },
            { "indent": 0, "text": "调用 operation.addInBoundAndReturnLog 记录退库日志", "type": "call" },
            { "indent": 0, "text": "准备归档数据和流转账本数据", "type": "action" },
            { "indent": 0, "text": "批量插入归档记录到 inventory_archive", "type": "call" },
            { "indent": 0, "text": "批量插入流转账本到 stock_movement", "type": "call" },
            { "indent": 0, "text": "批量删除库存记录", "type": "call" },
            { "indent": 0, "text": "返回退库结果", "type": "return" }
          ],
          "calls": [
            { "name": "用户表.查询", "type": "db", "table": "admin_user", "description": "获取用户信息" },
            { "name": "库存表.批量查询", "type": "db", "table": "inventory", "description": "检查RFID状态" },
            { "name": "退库日志.记录", "type": "internal", "description": "调用operation.addInBoundAndReturnLog" },
            { "name": "归档表.批量插入", "type": "db", "table": "inventory_archive", "description": "归档库存记录" },
            { "name": "库存流转账本.记录", "type": "db", "table": "stock_movement", "description": "记录ReturnSupplier操作" },
            { "name": "库存表.批量删除", "type": "db", "table": "inventory", "description": "删除已退库记录" }
          ],
          "code_ref": { "file": "scripts/hv3/stock/outbound.js", "function": "createReturnOrder", "line": 8 }
        }
      ]
    },
    {
      "id": "inventory_task",
      "name": "库存盘点",
      "description": "库存盘点任务管理，支持创建盘点任务、扫描盘点、差异处理",
      "tags": ["核心", "盘点"],
      "dependencies": ["stock"],
      "code_refs": [{ "file": "scripts/hv3/stock/inventory_task.js" }],
      "flows": [
        {
          "id": "flow_create_inventory_task",
          "name": "创建盘点任务",
          "description": "创建盘点任务并生成明细快照",
          "trigger": "用户发起盘点",
          "steps": [
            { "id": "step1", "order": 1, "name": "未完成任务检查", "description": "检查是否存在未完成的盘点任务", "rules": ["rule_single_task"] },
            { "id": "step2", "order": 2, "name": "参数校验", "description": "校验operatingRoomIDs不为空" },
            { "id": "step3", "order": 3, "name": "获取地点信息", "description": "查询地点表获取地点名称" },
            { "id": "step4", "order": 4, "name": "创建任务头", "description": "生成任务号并创建任务记录" },
            { "id": "step5", "order": 5, "name": "生成明细快照", "description": "分批查询库存并写入盘点明细表", "rules": ["rule_participate_inventory"] },
            { "id": "step6", "order": 6, "name": "更新计划数量", "description": "回写plannedCount到任务头" }
          ],
          "code_ref": { "file": "scripts/hv3/stock/inventory_task.js", "function": "createTask", "line": 147 }
        }
      ],
      "rules": [
        {
          "id": "rule_single_task",
          "name": "单任务限制规则",
          "description": "同一时间只能存在一个未完成的盘点任务",
          "priority": "high",
          "category": "校验",
          "constraints": ["不存在status为draft/running/review的任务"],
          "effects": ["若存在则拒绝创建新任务"],
          "affects": { "entities": ["inventory_task"], "operations": ["C"] },
          "code_ref": { "file": "scripts/hv3/stock/inventory_task.js", "line": 161 }
        },
        {
          "id": "rule_participate_inventory",
          "name": "参与盘点规则",
          "description": "根据字典配置决定耗材是否参与盘点",
          "priority": "medium",
          "category": "过滤",
          "constraints": ["查询字典表的participateInventory字段", "默认参与盘点"],
          "effects": ["participateInventory=false的耗材不生成盘点明细"],
          "affects": { "entities": ["dictionary", "inventory_task_detail"], "operations": ["R", "C"] },
          "code_ref": { "file": "scripts/hv3/stock/inventory_task.js", "line": 343 }
        }
      ],
      "state_machines": [
        {
          "id": "sm_inventory_task_status",
          "name": "盘点任务状态机",
          "description": "盘点任务的状态流转",
          "entity": "inventory_task",
          "field": "status",
          "states": [
            { "id": "draft", "name": "草稿", "description": "任务已创建，未开始盘点", "is_initial": true },
            { "id": "running", "name": "进行中", "description": "正在执行盘点" },
            { "id": "review", "name": "待审核", "description": "盘点完成，等待审核" },
            { "id": "completed", "name": "已完成", "description": "盘点已审核通过", "is_final": true },
            { "id": "canceled", "name": "已取消", "description": "任务已取消", "is_final": true }
          ],
          "transitions": [
            { "from": "draft", "to": "running", "trigger": "开始盘点", "description": "用户开始执行盘点" },
            { "from": "draft", "to": "canceled", "trigger": "取消", "description": "取消任务" },
            { "from": "running", "to": "review", "trigger": "提交审核", "description": "盘点完成提交审核" },
            { "from": "running", "to": "canceled", "trigger": "作废", "description": "作废进行中的任务" },
            { "from": "review", "to": "completed", "trigger": "审核通过", "description": "审核通过完成盘点" },
            { "from": "review", "to": "running", "trigger": "打回", "description": "审核打回重新盘点" }
          ]
        }
      ],
      "pseudocodes": [
        {
          "id": "pc_create_inventory_task",
          "name": "创建盘点任务",
          "description": "创建盘点任务并生成明细快照的完整流程",
          "params": ["payload: {taskName, operatingRoomIDs, remark, userID, inventoryStatusList}"],
          "returns": "任务信息 {taskId, plannedCount}",
          "steps": [
            { "indent": 0, "text": "// 创建盘点任务", "type": "comment" },
            { "indent": 0, "text": "检查是否存在未完成的盘点任务(draft/running/review)", "type": "condition" },
            { "indent": 1, "text": "若存在 → 返回错误，提示先完成或作废", "type": "error" },
            { "indent": 0, "text": "校验 operatingRoomIDs 不为空", "type": "condition" },
            { "indent": 0, "text": "分批查询地点表获取地点名称", "type": "call" },
            { "indent": 0, "text": "生成盘点任务号 PD + YYYYMMDDHHmmss + 毫秒 + 随机数", "type": "action" },
            { "indent": 0, "text": "创建任务头记录（status=draft）", "type": "call" },
            { "indent": 0, "text": "分地点、分页查询库存表", "type": "loop" },
            { "indent": 1, "text": "按字典表participateInventory过滤", "type": "action" },
            { "indent": 1, "text": "批量插入盘点明细快照", "type": "call" },
            { "indent": 0, "text": "回写plannedCount到任务头", "type": "call" },
            { "indent": 0, "text": "返回任务创建结果", "type": "return" }
          ],
          "calls": [
            { "name": "盘点任务表.查询未完成", "type": "db", "table": "inventory_task", "description": "检查是否有未完成任务" },
            { "name": "地点表.批量查询", "type": "db", "table": "locations", "description": "获取地点名称" },
            { "name": "盘点任务表.创建", "type": "db", "table": "inventory_task", "description": "创建任务头" },
            { "name": "库存表.分页查询", "type": "db", "table": "inventory", "description": "查询库存生成快照" },
            { "name": "字典表.批量查询", "type": "db", "table": "AllConsumablesDictionary", "description": "获取participateInventory配置" },
            { "name": "盘点明细表.批量插入", "type": "db", "table": "inventory_task_detail", "description": "插入盘点明细快照" }
          ],
          "code_ref": { "file": "scripts/hv3/stock/inventory_task.js", "function": "createTask", "line": 147 }
        }
      ]
    },
    {
      "id": "stock",
      "name": "库存查询",
      "description": "库存信息查询、效期管理、字典关联",
      "tags": ["核心", "库存"],
      "dependencies": ["dictionary"],
      "code_refs": [{ "file": "scripts/hv3/stock/stock.js" }],
      "flows": [
        {
          "id": "flow_get_stock",
          "name": "库存查询",
          "description": "支持按子码、批次、RFID查询库存",
          "trigger": "用户查询库存",
          "steps": [
            { "id": "step1", "order": 1, "name": "参数校验", "description": "校验searchType和分页参数" },
            { "id": "step2", "order": 2, "name": "构建查询条件", "description": "根据参数构建查询条件" },
            { "id": "step3", "order": 3, "name": "查询库存", "description": "从库存表查询数据" },
            { "id": "step4", "order": 4, "name": "计算耗材状态", "description": "根据效期和字典状态计算type字段", "rules": ["rule_generate_type"] },
            { "id": "step5", "order": 5, "name": "贴合地点名称", "description": "批量查询地点表获取名称" },
            { "id": "step6", "order": 6, "name": "分组聚合", "description": "按searchType进行分组聚合" },
            { "id": "step7", "order": 7, "name": "排序分页", "description": "按指定字段排序并分页返回" }
          ],
          "code_ref": { "file": "scripts/hv3/stock/stock.js", "function": "getStock", "line": 275 }
        },
        {
          "id": "flow_update_expiry_status",
          "name": "效期状态更新",
          "description": "批量更新库存的效期状态",
          "trigger": "定时任务/入库后",
          "steps": [
            { "id": "step1", "order": 1, "name": "加载配置", "description": "加载效期预警配置和默认预警天数" },
            { "id": "step2", "order": 2, "name": "分批查询库存", "description": "使用游标分页查询在库库存" },
            { "id": "step3", "order": 3, "name": "计算效期状态", "description": "根据expiryDate和预警天数计算状态", "rules": ["rule_expiry_status"] },
            { "id": "step4", "order": 4, "name": "批量更新", "description": "更新expiryStatus和nearExpiryDays字段" }
          ],
          "code_ref": { "file": "scripts/hv3/stock/stock.js", "function": "updateExpiryStatus", "line": 111 }
        }
      ],
      "rules": [
        {
          "id": "rule_generate_type",
          "name": "耗材状态计算规则",
          "description": "根据效期状态和字典状态计算耗材显示类型",
          "priority": "medium",
          "category": "计算",
          "effects": ["type='SPD系统已停用': dictionary.dictionaryStatus=stop", "type='效期预警'或'已过期': expiryStatus!=normal", "type='正常': 其他情况"],
          "affects": { "entities": ["inventory"], "fields": ["type"], "operations": ["R"] },
          "code_ref": { "file": "scripts/hv3/stock/stock.js", "line": 308 }
        },
        {
          "id": "rule_expiry_status",
          "name": "效期状态计算规则",
          "description": "根据有效期计算效期状态",
          "priority": "high",
          "category": "计算",
          "constraints": ["有效期必须是有效日期格式"],
          "effects": ["expired: 剩余天数<0", "nearExpiry: 剩余天数<=预警天数", "normal: 其他"],
          "affects": { "entities": ["inventory"], "fields": ["expiryStatus", "nearExpiryDays"], "operations": ["U"] },
          "code_ref": { "file": "scripts/hv3/stock/stock.js", "line": 184 }
        }
      ],
      "state_machines": [],
      "pseudocodes": []
    },
    {
      "id": "consume",
      "name": "消耗管理",
      "description": "耗材消耗记录同步和状态变更",
      "tags": ["核心"],
      "dependencies": ["stock"],
      "code_refs": [{ "file": "scripts/hv3/consume/consume.js" }, { "file": "scripts/hv3/schedules/consume.js" }],
      "flows": [],
      "rules": [
        {
          "id": "rule_consume_status",
          "name": "消耗状态类型",
          "description": "消耗状态分为4种：0-消耗、1-消耗退回、2-领用未消耗、3-领用退回",
          "priority": "high",
          "category": "业务规则",
          "affects": { "entities": ["inventory"], "fields": ["status"], "operations": ["U"] }
        }
      ],
      "state_machines": [],
      "pseudocodes": []
    },
    {
      "id": "spd",
      "name": "SPD接口",
      "description": "与SPD系统对接的接口模块",
      "tags": ["集成", "外部接口"],
      "code_refs": [{ "file": "scripts/hv3/spd/spd.js" }],
      "flows": [],
      "rules": [],
      "state_machines": [],
      "pseudocodes": []
    },
    {
      "id": "dictionary",
      "name": "耗材字典",
      "description": "耗材字典管理，包含耗材基础信息、规格、厂家等",
      "tags": ["基础数据"],
      "code_refs": [{ "file": "scripts/hv3/dictionary/" }],
      "flows": [],
      "rules": [
        {
          "id": "rule_dict_priority",
          "name": "字典优先原则",
          "description": "在耗材信息查询时，本地字典的优先级高于SPD查询",
          "priority": "high",
          "category": "业务规则"
        }
      ],
      "state_machines": [],
      "pseudocodes": []
    }
  ],
  "entities": [
    {
      "id": "entity_inventory",
      "name": "库存",
      "description": "高值耗材库存实体，记录每件耗材的当前状态和位置",
      "models": ["inventory"],
      "key_fields": [
        { "name": "rfid", "label": "RFID标签", "description": "耗材唯一标识", "source": "inventory.rfid", "constraints": ["唯一"] },
        { "name": "code", "label": "耗材子码", "description": "耗材型号编码", "source": "inventory.code" },
        { "name": "status", "label": "库存状态", "description": "当前业务状态", "source": "inventory.status" },
        { "name": "current_location_id", "label": "当前位置", "description": "耗材所在地点ID", "source": "inventory.current_location_id" }
      ],
      "statuses": [
        { "value": "inStock", "label": "在库", "description": "耗材已入库，可被取用" },
        { "value": "taken", "label": "已取用", "description": "耗材已被取出" },
        { "value": "consumed", "label": "已消耗", "description": "耗材已被使用" },
        { "value": "usedReturn", "label": "消耗退回", "description": "已消耗耗材被退回" }
      ]
    },
    {
      "id": "entity_consumable",
      "name": "耗材",
      "description": "耗材字典实体，记录耗材的基础信息",
      "models": ["AllConsumablesDictionary"],
      "key_fields": [
        { "name": "subCode", "label": "子编码", "description": "耗材子码，唯一标识型号", "source": "AllConsumablesDictionary.subCode", "constraints": ["唯一"] },
        { "name": "name", "label": "名称", "description": "耗材名称", "source": "AllConsumablesDictionary.name" },
        { "name": "manufacturer", "label": "生产商", "description": "生产厂家", "source": "AllConsumablesDictionary.manufacturer" },
        { "name": "dictionaryStatus", "label": "字典状态", "description": "启用/停用", "source": "AllConsumablesDictionary.dictionaryStatus" }
      ],
      "statuses": [
        { "value": "enable", "label": "启用", "description": "耗材可正常使用" },
        { "value": "stop", "label": "停用", "description": "耗材已停用" }
      ]
    },
    {
      "id": "entity_location",
      "name": "地点",
      "description": "统一地点模型，包含中心库和二级仓库/术间",
      "models": ["locations"],
      "key_fields": [
        { "name": "name", "label": "名称", "description": "地点名称", "source": "locations.name" },
        { "name": "type", "label": "类型", "description": "center=中心库, room=二级仓库", "source": "locations.type" },
        { "name": "is_active", "label": "启用状态", "description": "是否启用", "source": "locations.is_active" }
      ]
    },
    {
      "id": "entity_inventory_task",
      "name": "盘点任务",
      "description": "库存盘点任务实体",
      "models": ["inventory_task", "inventory_task_detail"],
      "key_fields": [
        { "name": "taskId", "label": "任务号", "description": "盘点任务唯一编号", "source": "inventory_task.taskId" },
        { "name": "status", "label": "任务状态", "description": "任务执行状态", "source": "inventory_task.status" },
        { "name": "plannedCount", "label": "计划数量", "description": "应盘点数量", "source": "inventory_task.plannedCount" }
      ],
      "statuses": [
        { "value": "draft", "label": "草稿" },
        { "value": "running", "label": "进行中" },
        { "value": "review", "label": "待审核" },
        { "value": "completed", "label": "已完成" },
        { "value": "canceled", "label": "已取消" }
      ]
    }
  ],
  "data_models": [
    {
      "id": "model_inventory",
      "name": "库存表",
      "table": "inventory",
      "description": "存储每件高值耗材的库存信息",
      "entity": "entity_inventory",
      "fields": [
        { "name": "id", "type": "id", "label": "ID" },
        { "name": "rfid", "type": "string", "label": "RFID", "required": true, "unique": true },
        { "name": "code", "type": "string", "label": "编码" },
        { "name": "name", "type": "string", "label": "名称" },
        { "name": "spec", "type": "string", "label": "规格" },
        { "name": "batch", "type": "string", "label": "批次" },
        { "name": "expiryDate", "type": "string", "label": "有效期至" },
        { "name": "manufacturer", "type": "string", "label": "生产商" },
        { "name": "brand", "type": "string", "label": "品牌" },
        { "name": "unit", "type": "string", "label": "单位" },
        { "name": "price", "type": "string", "label": "价格" },
        { "name": "status", "type": "enum", "label": "库存状态", "enum_options": [
          { "value": "inStock", "label": "在库" },
          { "value": "taken", "label": "已取用" },
          { "value": "consumed", "label": "已消耗" },
          { "value": "usedReturn", "label": "消耗退回" }
        ]},
        { "name": "current_location_id", "type": "integer", "label": "当前位置ID", "required": true, "references": { "model": "locations", "field": "id" }},
        { "name": "expiryStatus", "type": "enum", "label": "效期状态", "enum_options": [
          { "value": "normal", "label": "正常" },
          { "value": "nearExpiry", "label": "近效期" },
          { "value": "expired", "label": "已过期" }
        ]},
        { "name": "dictionaryID", "type": "integer", "label": "字典ID", "references": { "model": "AllConsumablesDictionary", "field": "id" }},
        { "name": "cabinetID", "type": "integer", "label": "SPD仓库ID" }
      ],
      "source": { "file": "models/hv3/stock/inventory.mod.yao", "type": "yao" }
    },
    {
      "id": "model_dictionary",
      "name": "耗材字典表",
      "table": "AllConsumablesDictionary",
      "description": "存储所有耗材的基础信息",
      "entity": "entity_consumable",
      "fields": [
        { "name": "id", "type": "id", "label": "ID" },
        { "name": "subCode", "type": "string", "label": "子编码", "required": true, "unique": true },
        { "name": "name", "type": "string", "label": "名称" },
        { "name": "specifiacation", "type": "string", "label": "规格" },
        { "name": "manufacturer", "type": "string", "label": "生产商" },
        { "name": "brand", "type": "string", "label": "品牌" },
        { "name": "unit", "type": "string", "label": "单位" },
        { "name": "dictionaryStatus", "type": "enum", "label": "字典状态", "enum_options": [
          { "value": "enable", "label": "启用" },
          { "value": "stop", "label": "停用" }
        ]},
        { "name": "participateInventory", "type": "boolean", "label": "参与盘点" }
      ],
      "source": { "file": "models/hv3/dictionary/all.mod.yao", "type": "yao" }
    },
    {
      "id": "model_locations",
      "name": "地点表",
      "table": "locations",
      "description": "统一地点模型",
      "entity": "entity_location",
      "fields": [
        { "name": "id", "type": "id", "label": "ID" },
        { "name": "name", "type": "string", "label": "名称" },
        { "name": "type", "type": "string", "label": "类型", "description": "center=中心库, room=二级仓库" },
        { "name": "is_active", "type": "boolean", "label": "启用" },
        { "name": "is_default_inbound_return", "type": "boolean", "label": "默认入库/归还" }
      ],
      "source": { "file": "models/hv3/stock/locations.mod.yao", "type": "yao" }
    },
    {
      "id": "model_stock_movement",
      "name": "库存流转账本",
      "table": "stock_movement",
      "description": "记录库存状态与地点的每一次变更",
      "fields": [
        { "name": "id", "type": "id", "label": "ID" },
        { "name": "rfid", "type": "string", "label": "RFID" },
        { "name": "operation_type", "type": "enum", "label": "动作", "enum_options": [
          { "value": "Inbound", "label": "入库" },
          { "value": "Take", "label": "取用" },
          { "value": "ReturnUnused", "label": "归还(未使用)" },
          { "value": "Consume", "label": "消耗" },
          { "value": "ReturnUsed", "label": "归还(已使用)" },
          { "value": "ReturnSupplier", "label": "退库" },
          { "value": "Transfer", "label": "移库" }
        ]},
        { "name": "status_from", "type": "string", "label": "原状态" },
        { "name": "status_to", "type": "string", "label": "新状态" },
        { "name": "location_from_id", "type": "integer", "label": "来源位置" },
        { "name": "location_to_id", "type": "integer", "label": "目标位置" },
        { "name": "operator_id", "type": "integer", "label": "操作人" }
      ],
      "source": { "file": "models/hv3/stock/stock_movement.mod.yao", "type": "yao" }
    },
    {
      "id": "model_pending_inbound_order",
      "name": "待入库订单表",
      "table": "pendingInboundOrder",
      "description": "SPD下发的待上架订单",
      "fields": [
        { "name": "id", "type": "id", "label": "ID" },
        { "name": "orderNo", "type": "string", "label": "订单号", "required": true },
        { "name": "rfid", "type": "string", "label": "RFID", "required": true },
        { "name": "name", "type": "string", "label": "名称" },
        { "name": "code", "type": "string", "label": "耗材子码" },
        { "name": "type", "type": "enum", "label": "状态", "enum_options": [
          { "value": "pending", "label": "待完成" },
          { "value": "completed", "label": "已完成" }
        ]}
      ],
      "source": { "file": "models/hv3/stock/pending_inbound_order.mod.yao", "type": "yao" }
    },
    {
      "id": "model_take_and_return_log",
      "name": "取用归还日志表",
      "table": "TakeAndReturnLog",
      "description": "货柜操作日志表(取用和归还)",
      "fields": [
        { "name": "id", "type": "id", "label": "ID" },
        { "name": "operatorId", "type": "integer", "label": "操作人ID" },
        { "name": "isTake", "type": "boolean", "label": "是否取用" },
        { "name": "isReturn", "type": "boolean", "label": "是否归还" },
        { "name": "takedNum", "type": "integer", "label": "取用数量" },
        { "name": "returnNum", "type": "integer", "label": "归还数量" },
        { "name": "openDoorTime", "type": "datetime", "label": "开门时间" },
        { "name": "closeDoorTime", "type": "datetime", "label": "关门时间" },
        { "name": "cabinetID", "type": "integer", "label": "货柜ID" }
      ],
      "source": { "file": "models/hv3/log/take_and_return.mod.yao", "type": "yao" }
    }
  ],
  "glossary": {
    "RFID": { "term": "RFID", "description": "射频识别标签，用于唯一标识每件耗材" },
    "SPD": { "term": "SPD", "description": "供应链管理系统(Supply Processing Distribution)，负责耗材的采购、配送等" },
    "中心库": { "term": "中心库", "description": "一级仓库，是耗材入库的目标位置" },
    "二级仓库": { "term": "二级仓库", "description": "术间等使用耗材的位置" },
    "有单入库": { "term": "有单入库", "description": "根据SPD下发的待上架订单进行入库" },
    "无单入库": { "term": "无单入库", "description": "直接扫描耗材RFID进行入库，通过SPD接口查询信息" },
    "效期预警": { "term": "效期预警", "description": "耗材有效期临近时的预警状态" },
    "盘点": { "term": "盘点", "description": "清点实际库存与系统库存的一致性" },
    "取用": { "term": "取用", "description": "用户从智能柜中取出耗材" },
    "消耗": { "term": "消耗", "description": "耗材被实际使用（如手术中使用）" },
    "退库": { "term": "退库", "description": "将在库耗材退回供应商" }
  },
  "changelog": [
    {
      "date": "2025-02-02",
      "type": "init",
      "summary": "初始化 hcw_yao 项目的业务逻辑清单 v1",
      "details": "旧版本，包含基础模块信息"
    },
    {
      "date": "2025-02-02",
      "type": "modify",
      "summary": "升级到 Schema v3.1 格式",
      "details": "重构为分离展示结构：flows、rules、state_machines、pseudocodes 独立展示；增加伪代码和API调用汇总"
    }
  ]
}
